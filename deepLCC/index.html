
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Haoxing Du, Meihui Liu, Yang Zheng">
      
      
      
        <link rel="prev" href="..">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.18">
    
    
      
        <title>DeeP-LCC - DeeP-LCC</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#data-enabled-predictive-leading-cruise-control-deep-lcc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="DeeP-LCC" class="md-header__button md-logo" aria-label="DeeP-LCC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DeeP-LCC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DeeP-LCC
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/soc-ucsd/DeeP-LCC" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    soc-ucsd/DeeP-LCC
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Welcome
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      DeeP-LCC
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="DeeP-LCC" class="md-nav__button md-logo" aria-label="DeeP-LCC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    DeeP-LCC
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/soc-ucsd/DeeP-LCC" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    soc-ucsd/DeeP-LCC
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          DeeP-LCC
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        DeeP-LCC
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting Started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matlab-implementation" class="md-nav__link">
    Matlab Implementation
  </a>
  
    <nav class="md-nav" aria-label="Matlab Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-file" class="md-nav__link">
    Main File
  </a>
  
    <nav class="md-nav" aria-label="Main File">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main_brake_simulationm" class="md-nav__link">
    main_brake_simulation.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main_nedc_simulationm" class="md-nav__link">
    main_nedc_simulation.m
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hdv_dynamicsm" class="md-nav__link">
    HDV_dynamics.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hankel_matrixm" class="md-nav__link">
    hankel_matrix.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#measure_mixed_trafficm" class="md-nav__link">
    measure_mixed_traffic.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qp_deep_lccm" class="md-nav__link">
    qp_DeeP_LCC.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qp_mpcm" class="md-nav__link">
    qp_MPC.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic_linear_modelm" class="md-nav__link">
    traffic_linear_model.m
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-generation" class="md-nav__link">
    Data Generation
  </a>
  
    <nav class="md-nav" aria-label="Data Generation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data_hdvparameterm" class="md-nav__link">
    data_hdvParameter.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data_trajectorydatacollectionm" class="md-nav__link">
    data_trajectoryDataCollection.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data_trajectorydatacollection_hdvtrajectoryprocessm" class="md-nav__link">
    data_trajectoryDataCollection_HDVTrajectoryProcess.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nedc_trajectorym" class="md-nav__link">
    nedc_trajectory.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nedc_modified_trajectorym" class="md-nav__link">
    nedc_modified_trajectory.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nedc_trajectory_modifiedm" class="md-nav__link">
    nedc_trajectory_modified.m
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot-figure" class="md-nav__link">
    Plot Figure
  </a>
  
    <nav class="md-nav" aria-label="Plot Figure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#figure_brakeperturbation_trajectorym" class="md-nav__link">
    Figure_BrakePerturbation_Trajectory.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#figure_nedc_statisticsm" class="md-nav__link">
    Figure_NEDC_Statistics.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#figure_nedc_trajectorym" class="md-nav__link">
    Figure_NEDC_Trajectory.m
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#figure_ovmspacingpolicym" class="md-nav__link">
    Figure_OVMSpacingPolicy.m
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python-implementation" class="md-nav__link">
    Python Implementation
  </a>
  
    <nav class="md-nav" aria-label="Python Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#packages" class="md-nav__link">
    Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function" class="md-nav__link">
    Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiment-results" class="md-nav__link">
    Experiment Results
  </a>
  
    <nav class="md-nav" aria-label="Experiment Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#experiment-setup" class="md-nav__link">
    Experiment Setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#numerical-results" class="md-nav__link">
    Numerical Results
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runtime" class="md-nav__link">
    Runtime
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="data-enabled-predictive-leading-cruise-control-deep-lcc">Data-EnablEd Predictive Leading Cruise Control (DeeP-LCC)<a class="headerlink" href="#data-enabled-predictive-leading-cruise-control-deep-lcc" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>One of the biggest obstacles to the control of connected and autonomous vehicles (CAVs) is the lack of a trivial and accurate way to find car-following dynamics of human-driven vehicles. DeeP-LCC (Data-EnablEd Predictive Leading Cruise Control) introduced in the paper proposed a way to control CAVs in mixed traffic relying on data-driven non-parametric strategies. We used Willems' fundamental lemma in the paper to obtain a data-centric representation of mixed traffic behavior. Then we used a receding horizon strategy to solve the optimization problem at each time step. We further did numeric experiments to validate the performance of DeeP-LCC, which shows good improvements in the traffic and reveals excellent potential for further research. In particular, with a CAV penetration rate of 25%, DeeP-LCC help reduce up to 24.69% fuel consumption with safety guarantees in the emergency braking scenario.
The following content explains how Matlab and Python implementations work for the numeric simulation, and includes a brief discussion of the results.</p>
<h2 id="getting-started">Getting Started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h2>
<p>Graph of the dependency of all Matlab files:
<a class="glightbox" href="../img/deepLCC/ExecutableDependency.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Executable Dependency" src="../img/deepLCC/ExecutableDependency.png" /></a></p>
<h2 id="matlab-implementation">Matlab Implementation<a class="headerlink" href="#matlab-implementation" title="Permanent link">&para;</a></h2>
<h4 id="main-file">Main File<a class="headerlink" href="#main-file" title="Permanent link">&para;</a></h4>
<h5 id="main_brake_simulationm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/main_brake_simulation.m">main_brake_simulation.m</a><a class="headerlink" href="#main_brake_simulationm" title="Permanent link">&para;</a></h5>
<p>This main function is used for safety-critical simulation in the scenario that the head vehicle takes a sudden brake. More detailed can be refered to Section V of the paper "Data-Driven Predicted Control for Connected and Autonomous Vehicles in Mixed Traffic".</p>
<p>Add path and initialization.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">clc</span><span class="p">;</span><span class="w"> </span><span class="n">close</span><span class="w"> </span><span class="s">all</span><span class="p">;</span><span class="w"> </span><span class="nb">clear</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nb">addpath</span><span class="p">(</span><span class="s">&#39;_fcn&#39;</span><span class="p">);</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">warning</span><span class="w"> </span><span class="s">off</span><span class="p">;</span>
</code></pre></div>
</details>

<p>Parameter setup. This section includes Scenario Setup and HDV setup.</p>
<ul>
<li>Scenario Setup</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c">% whether traffic flow is mixed</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">mix</span><span class="w">                 </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">                    </span><span class="c">% 0. all HDVs; 1. there exist CAVs</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">ID</span><span class="w">                  </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span><span class="w">    </span><span class="c">% ID of vehicle types</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">                                            </span><span class="c">% 1: CAV  0: HDV</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">pos_cav</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">ID</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span><span class="w">          </span><span class="c">% position of CAVs</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">n_vehicle</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="n">n_cav</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">pos_cav</span><span class="p">);</span><span class="w">      </span><span class="c">% number of CAVs</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="n">n_hdv</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">-</span><span class="n">n_cav</span><span class="p">;</span><span class="w">      </span><span class="c">% number of HDVs</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="c">% perturbation on the head vehicle</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="n">per_type</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. sinuoid perturbation 2. brake perturbation </span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="n">sine_amp</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">    </span><span class="c">% amplitidue of sinuoid perturbation</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="n">brake_amp</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">   </span><span class="c">% brake amplitude of brake perturbation</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="c">% time</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="n">total_time</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w">              </span><span class="c">% Total Simulation Time</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="n">Tstep</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span><span class="w">            </span><span class="c">% Time Step</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="n">total_time_step</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">;</span>
</code></pre></div>
</details>

<ul>
<li>HDV setup</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c">% Type for HDV car-following model</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">hdv_type</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. OVM   2. IDM</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c">% Parameter setup for HDV </span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">data_str</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p">;</span><span class="w">  </span><span class="c">% 1. random ovm  2. manual heterogeneous ovm  3. homogeneous ovm</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">switch</span><span class="w"> </span><span class="n">hdv_type</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">        </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data/hdv_ovm_&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">        </span><span class="nb">load</span><span class="p">(</span><span class="s">&#39;_data/hdv_idm.mat&#39;</span><span class="p">);</span><span class="w">      </span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="k">end</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="c">% Uncertainty for HDV acceleration</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="n">acel_noise</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% A white noise signal on HDV&#39;s acceleration</span>
</code></pre></div>
</details>

<p>Formulation for DeeP-LCC</p>
<ul>
<li>Parameter setup</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c">% Type of the controller</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">controller_type</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. DeeP-LCC  2. MPC </span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c">% Initialize Equilibrium Setup (they might be updated in the control process)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">v_star</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w">   </span><span class="c">% Equilibrium velocity</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">s_star</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">   </span><span class="c">% Equilibrium spacing for CAV</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c">% Horizon setup </span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="n">Tini</span><span class="w">                </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">   </span><span class="c">% length of past data in control process</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="n">N</span><span class="w">                   </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w">   </span><span class="c">% length of future data in control process</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="c">% Performance cost</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="n">weight_v</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% weight coefficient for velocity error</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="n">weight_s</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">  </span><span class="c">% weight coefficient for spacing error   </span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="n">weight_u</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% weight coefficient for control input</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c">% Setup in DeeP-LCC</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="n">T</span><span class="w">                   </span><span class="p">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w"> </span><span class="c">% length of data samples</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="n">lambda_g</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">  </span><span class="c">% penalty on ||g||_2^2 in objective</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="n">lambda_y</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">1e4</span><span class="p">;</span><span class="w">  </span><span class="c">% penalty on ||sigma_y||_2^2 in objective</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="c">% Constraints</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="n">constraint_bool</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% whether there exist constraints</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="n">acel_max</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">    </span><span class="c">% maximum acceleration</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="n">dcel_max</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">;</span><span class="w">   </span><span class="c">% minimum acceleration (maximum deceleration)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="n">spacing_max</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w">   </span><span class="c">% maximum spacing</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="n">spacing_min</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">    </span><span class="c">% minimum spacing</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="n">u_limit</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">dcel_max</span><span class="p">,</span><span class="n">acel_max</span><span class="p">];</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="n">s_limit</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">spacing_min</span><span class="p">,</span><span class="n">spacing_max</span><span class="p">]</span><span class="o">-</span><span class="n">s_star</span><span class="p">;</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="c">% what signals are measurable (for output definition)</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="n">measure_type</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. Only the velocity errors of all the vehicles are measurable;</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">                            </span><span class="c">% 2. All the states, including velocity error and spacing error are measurable;</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">                            </span><span class="c">% 3. Velocity error and spacing error of the CAVs are measurable, </span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">                            </span><span class="c">%    and the velocity error of the HDVs are measurable.</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="c">% equilibrium setup</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="n">fixed_spacing_bool</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">    </span><span class="c">% wheter fix equilibrium spacing</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">                                </span><span class="c">% 0. the equilibrium spacing will be updated via an OVM-type spacing policy</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">                                </span><span class="c">% 1. fix the equilibrium spacing</span>
</code></pre></div>
</details>

<ul>
<li>Process parameters</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">n_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span><span class="w">    </span><span class="c">% number of state variables</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">m_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span><span class="w">          </span><span class="c">% number of input variables</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="k">switch</span><span class="w"> </span><span class="n">measure_type</span><span class="w">     </span><span class="c">% number of output variables</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="p">;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">end</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="n">Q_v</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="n">weight_v</span><span class="o">*</span><span class="nb">eye</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">);</span><span class="w">          </span><span class="c">% penalty for velocity error</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="n">Q_s</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="n">weight_s</span><span class="o">*</span><span class="nb">eye</span><span class="p">(</span><span class="n">p_ctr</span><span class="o">-</span><span class="n">n_vehicle</span><span class="p">);</span><span class="w">    </span><span class="c">% penalty for spacing error</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="n">Q</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">blkdiag</span><span class="p">(</span><span class="n">Q_v</span><span class="p">,</span><span class="n">Q_s</span><span class="p">);</span><span class="w">                 </span><span class="c">% penalty for trajectory error</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="n">R</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="n">weight_u</span><span class="o">*</span><span class="nb">eye</span><span class="p">(</span><span class="n">m_ctr</span><span class="p">);</span><span class="w">              </span><span class="c">% penalty for control input</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="n">u</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">m_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">     </span><span class="c">% control input</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="n">x</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">n_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">     </span><span class="c">% state variables</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="n">y</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">     </span><span class="c">% output variables</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="n">pr_status</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time_step</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">         </span><span class="c">% problem status</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="n">e</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">         </span><span class="c">% external input</span>
</code></pre></div>
</details>

<ul>
<li>Pre-collected data</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c">% load pre-collected data for DeeP-LCC</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">i_data</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% id of the pre-collected data</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\trajectory_data_collection\data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
</code></pre></div>
</details>

<p>Simulation</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c">% Mixed traffic states</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c">% S(time,vehicle id,state variable), in state variable: 1. position; 2. velocity; 3. acceleration</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">S</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time_step</span><span class="p">,</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">hdv_parameter</span><span class="p">.</span><span class="n">s_star</span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="k">end</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="n">v_star</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="c">%  reference trajectory is all zeros: stabilize the system to equilibrium</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="n">r</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="o">+</span><span class="n">N</span><span class="p">);</span><span class="w"> </span>
</code></pre></div>
</details>

<p>Experiment starts here</p>
<ul>
<li>Initialization: the CAVs and the head vehicle have zero control input</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c">% initial past data in control process</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">uini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">m_ctr</span><span class="p">,</span><span class="n">Tini</span><span class="p">);</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">eini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Tini</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">yini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p_ctr</span><span class="p">,</span><span class="n">Tini</span><span class="p">);</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="c">% calculate acceleration for the HDVs</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="n">acel</span><span class="w">                </span><span class="p">=</span><span class="w">  </span><span class="n">HDV_dynamics</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,:),</span><span class="n">hdv_parameter</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">                                </span><span class="o">-</span><span class="n">acel_noise</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">acel_noise</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">               </span><span class="c">% the head vehicle</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">acel</span><span class="p">;</span><span class="w">            </span><span class="c">% all the vehicles use HDV model</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pos_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">uini</span><span class="p">(:,</span><span class="n">k</span><span class="p">);</span><span class="w">       </span><span class="c">% the CAV</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="c">% update traffic states</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">eini</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span><span class="w">          </span><span class="c">% the velocity of the head vehicle</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="c">% update past output data</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="n">yini</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="k">end</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="n">k_end</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="n">yini</span><span class="p">(:,</span><span class="n">k_end</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k_end</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k_end</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="c">% update data in u,e,y</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="n">u</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">uini</span><span class="p">;</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="n">e</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eini</span><span class="p">;</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="n">y</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">yini</span><span class="p">;</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="c">% For MPC, which might have infeasible cases</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="n">previous_u_opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
</code></pre></div>
</details>

<ul>
<li>Continue the simulation</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Tini</span><span class="p">:</span><span class="n">total_time_step</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="c">% calculate acceleration for the HDVs</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">acel</span><span class="w">         </span><span class="p">=</span><span class="w">  </span><span class="n">HDV_dynamics</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,:),</span><span class="n">hdv_parameter</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">                    </span><span class="o">-</span><span class="n">acel_noise</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">acel_noise</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">acel</span><span class="p">;</span><span class="w">     </span><span class="c">% all the vehicles use HDV model</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">mix</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="n">controller_type</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c">% calculate control input via DeeP-LCC     </span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_DeeP_LCC</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span><span class="n">Yp</span><span class="p">,</span><span class="n">Uf</span><span class="p">,</span><span class="n">Yf</span><span class="p">,</span><span class="n">Ep</span><span class="p">,</span><span class="n">Ef</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">eini</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">                        </span><span class="n">lambda_g</span><span class="p">,</span><span class="n">lambda_y</span><span class="p">,</span><span class="n">u_limit</span><span class="p">,</span><span class="n">s_limit</span><span class="p">);</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_DeeP_LCC</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span><span class="n">Yp</span><span class="p">,</span><span class="n">Uf</span><span class="p">,</span><span class="n">Yf</span><span class="p">,</span><span class="n">Ep</span><span class="p">,</span><span class="n">Ef</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">eini</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">                        </span><span class="n">lambda_g</span><span class="p">,</span><span class="n">lambda_y</span><span class="p">);</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">                </span><span class="k">end</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c">% calculate control input via MPC</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_MPC</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">Tstep</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="n">measure_type</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">u_limit</span><span class="p">,</span><span class="n">s_limit</span><span class="p">,</span><span class="n">previous_u_opt</span><span class="p">);</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">                    </span><span class="n">previous_u_opt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">u_opt</span><span class="p">;</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_MPC</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">Tstep</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="n">measure_type</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span><span class="w">                    </span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">                </span><span class="k">end</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">         </span><span class="k">end</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">        </span><span class="c">% one-step implementation in receding horizon manner</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">        </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">u_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">m_ctr</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">        </span><span class="c">% update accleration for the CAV</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">        </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pos_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">        </span><span class="c">% judge whether AEB (automatic emergency braking, which is implemented in the function of &#39;HDV_dynamics&#39;) commands to brake</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">        </span><span class="n">brake_vehicle_ID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">acel</span><span class="o">==</span><span class="n">dcel_max</span><span class="p">);</span><span class="w">                </span><span class="c">% the vehicles that need to brake</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">        </span><span class="n">brake_cav_ID</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nb">intersect</span><span class="p">(</span><span class="n">brake_vehicle_ID</span><span class="p">,</span><span class="n">pos_cav</span><span class="p">);</span><span class="w"> </span><span class="c">% the CAVs that need to brake</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">brake_cav_ID</span><span class="p">)</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">            </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">brake_cav_ID</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcel_max</span><span class="p">;</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">        </span><span class="c">% record problem status</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="w">        </span><span class="n">pr_status</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pr</span><span class="p">;</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span class="w">    </span><span class="c">% update traffic states</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="w">    </span><span class="c">% perturbation for the head vehicle</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="n">per_type</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="w">            </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">v_star</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sine_amp</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">/</span><span class="n">Tstep</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="p">));</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="w">            </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">brake_amp</span><span class="o">/</span><span class="mi">5</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="w">                </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">brake_amp</span><span class="o">/</span><span class="mi">5</span><span class="o">+</span><span class="mi">5</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="w">                </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">brake_amp</span><span class="o">/</span><span class="mi">5</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="mi">5</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="w">                </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="w">                </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="w">            </span><span class="k">end</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a><span class="w">            </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a><span class="w">            </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">    </span><span class="c">% update equilibrium setup for the CAVs</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">    </span><span class="n">v_star</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w">               </span><span class="c">% update v_star</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">fixed_spacing_bool</span><span class="w">        </span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="w">        </span><span class="n">s_star</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">v_star</span><span class="o">/</span><span class="mi">30</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">35</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="c">% update s_star</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a><span class="w">    </span><span class="c">% update past data in control process</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a><span class="w">    </span><span class="n">uini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="w">    </span><span class="c">% the output needs to be re-calculated since the equilibrium might have been updated</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k_past</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a><span class="w">    </span><span class="c">% Record output</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a><span class="w">        </span><span class="n">y</span><span class="p">(:,</span><span class="n">k_past</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k_past</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k_past</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="w">        </span><span class="n">e</span><span class="p">(</span><span class="n">k_past</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k_past</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a><span class="w">    </span><span class="k">end</span><span class="w"> </span>
<a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a><span class="w">    </span><span class="n">yini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">y</span><span class="p">(:,</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a><span class="w">    </span><span class="n">eini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span>
<a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a>
<a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a><span class="w">    </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Simulation number: %d  |  process... %2.2f%% \n&#39;</span><span class="p">,</span><span class="n">i_data</span><span class="p">,(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_step</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a><span class="w">    </span><span class="c">%fprintf(&#39;Fixed Spacing: %d&#39;,fixed_spacing_bool);</span>
<a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a><span class="w">    </span><span class="c">%fprintf(&#39;Current spacing of the first CAV: %4.2f \n&#39;,S(k,3,1)-S(k,4,1));</span>
<a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a>
<a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a><span class="k">end</span>
<a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a><span class="n">k_end</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a><span class="n">y</span><span class="p">(:,</span><span class="n">k_end</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k_end</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k_end</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a>
<a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a><span class="n">tsim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">toc</span><span class="p">;</span>
<a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a>
<a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Simulation ends at %6.4f seconds \n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tsim</span><span class="p">);</span>
</code></pre></div>
</details>

<ul>
<li>Results output</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">if</span><span class="w"> </span><span class="n">mix</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">switch</span><span class="w"> </span><span class="n">controller_type</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="nb">save</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\DeeP_LCC\constrained_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">            </span><span class="s">&#39;_fixSpacing_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">fixed_spacing_bool</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;_lambdaG_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_g</span><span class="p">),</span><span class="s">&#39;_lambdaY_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_y</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">            </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">,</span><span class="s">&#39;pr_status&#39;</span><span class="p">);</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">        </span><span class="nb">save</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\MPC\constrained_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">            </span><span class="s">&#39;_fixSpacing_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">fixed_spacing_bool</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">            </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">,</span><span class="s">&#39;pr_status&#39;</span><span class="p">);</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="k">end</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="k">else</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span><span class="nb">save</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\HDV\constrained_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">            </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">);</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="k">end</span>
</code></pre></div>
</details>

<h5 id="main_nedc_simulationm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/main_nedc_simulation.m">main_nedc_simulation.m</a><a class="headerlink" href="#main_nedc_simulationm" title="Permanent link">&para;</a></h5>
<p>This main function is used for NEDC simulation in the scenario that the head vehicle follows a trajectory modified from the Extra-Urban Driving Cycle (EUDC) in New European Driving Circle (NEDC). More detailed can be refered to Section V of the paper "Data-Driven Predicted Control for Connected and Autonomous Vehicles in Mixed Traffic".</p>
<p>Add path and initialization.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nb">clc</span><span class="p">;</span><span class="w"> </span><span class="n">close</span><span class="w"> </span><span class="s">all</span><span class="p">;</span><span class="w"> </span><span class="nb">clear</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nb">addpath</span><span class="p">(</span><span class="s">&#39;_fcn&#39;</span><span class="p">);</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">warning</span><span class="w"> </span><span class="s">off</span><span class="p">;</span>
</code></pre></div>
</details>

<p>Parameter setup. This section includes Scenario Setup and HDV setup.</p>
<ul>
<li>Scenario Setup</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c">% whether traffic flow is mixed</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">mix</span><span class="w">                 </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">                    </span><span class="c">% 0. all HDVs; 1. there exist CAVs</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">ID</span><span class="w">                  </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span><span class="w">    </span><span class="c">% ID of vehicle types</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">                                            </span><span class="c">% 1: CAV  0: HDV</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">pos_cav</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">ID</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span><span class="w">          </span><span class="c">% position of CAVs</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="n">n_vehicle</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">n_cav</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">pos_cav</span><span class="p">);</span><span class="w">      </span><span class="c">% number of CAVs</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">n_hdv</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">-</span><span class="n">n_cav</span><span class="p">;</span><span class="w">      </span><span class="c">% number of HDVs</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="c">% Definition for Head vehicle trajectory</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="n">head_vehicle_trajectory</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nb">load</span><span class="p">(</span><span class="s">&#39;./_data/nedc_modified_v1.mat&#39;</span><span class="p">);</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="n">end_time</span><span class="w">                    </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">time</span><span class="p">(</span><span class="k">end</span><span class="p">);</span><span class="w">    </span><span class="c">% end time for the head vehicle trajectory</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">vel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">vel</span><span class="o">/</span><span class="mf">3.6</span><span class="p">;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="c">% Initialization Time</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="n">initialization_time</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w">               </span><span class="c">% Time for the original HDV-all system to stabilize</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="n">adaption_time</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">               </span><span class="c">% Time for the CAVs to adjust to their desired state</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="c">% Total Simulation Time</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="n">total_time</span><span class="w">                  </span><span class="p">=</span><span class="w"> </span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">end_time</span><span class="p">;</span><span class="w">  </span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="n">Tstep</span><span class="w">                       </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span><span class="w">             </span><span class="c">% Time Step</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="n">total_time_step</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">);</span>
</code></pre></div>
</details>

<ul>
<li>HDV setup</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c">% Type for HDV car-following model</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">hdv_type</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. OVM   2. IDM</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c">% Parameter setup for HDV </span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">data_str</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p">;</span><span class="w">  </span><span class="c">% 1. random ovm  2. manual heterogeneous ovm  3. homogeneous ovm</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">switch</span><span class="w"> </span><span class="n">hdv_type</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">        </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data/hdv_ovm_&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">        </span><span class="nb">load</span><span class="p">(</span><span class="s">&#39;_data/hdv_idm.mat&#39;</span><span class="p">);</span><span class="w">      </span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="k">end</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="c">% Uncertainty for HDV acceleration</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="n">acel_noise</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% A white noise signal on HDV&#39;s acceleration</span>
</code></pre></div>
</details>

<p>Formulation for DeeP-LCC</p>
<ul>
<li>Parameter setup</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c">% Type of the controller</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">controller_type</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. DeeP-LCC  2. MPC </span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c">% Initialize Equilibrium Setup (they might be updated in the control process)</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">v_star</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w">   </span><span class="c">% Equilibrium velocity</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">s_star</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">   </span><span class="c">% Equilibrium spacing for CAV</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c">% Horizon setup </span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="n">Tini</span><span class="w">                </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">   </span><span class="c">% length of past data in control process</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="n">N</span><span class="w">                   </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w">   </span><span class="c">% length of future data in control process</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="c">% Performance cost</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="n">weight_v</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% weight coefficient for velocity error</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="n">weight_s</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">  </span><span class="c">% weight coefficient for spacing error   </span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="n">weight_u</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% weight coefficient for control input</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="c">% Setup in DeeP-LCC</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="n">T</span><span class="w">                   </span><span class="p">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w"> </span><span class="c">% length of data samples</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="n">lambda_g</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">  </span><span class="c">% penalty on ||g||_2^2 in objective</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="n">lambda_y</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">1e4</span><span class="p">;</span><span class="w">  </span><span class="c">% penalty on ||sigma_y||_2^2 in objective</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="c">% Constraints</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="n">constraint_bool</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% whether there exist constraints</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="n">acel_max</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">    </span><span class="c">% maximum acceleration</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="n">dcel_max</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">;</span><span class="w">   </span><span class="c">% minimum acceleration (maximum deceleration)</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="n">spacing_max</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w">   </span><span class="c">% maximum spacing</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="n">spacing_min</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">    </span><span class="c">% minimum spacing</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="n">u_limit</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">dcel_max</span><span class="p">,</span><span class="n">acel_max</span><span class="p">];</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="n">s_limit</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">spacing_min</span><span class="p">,</span><span class="n">spacing_max</span><span class="p">]</span><span class="o">-</span><span class="n">s_star</span><span class="p">;</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="c">% what signals are measurable (for output definition)</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="n">measure_type</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. Only the velocity errors of all the vehicles are measurable;</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">                            </span><span class="c">% 2. All the states, including velocity error and spacing error are measurable;</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">                            </span><span class="c">% 3. Velocity error and spacing error of the CAVs are measurable, </span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">                            </span><span class="c">%    and the velocity error of the HDVs are measurable.</span>
</code></pre></div>
</details>

<ul>
<li>Process parameters</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">n_ctr</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span><span class="w">    </span><span class="c">% number of state variables</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">m_ctr</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span><span class="w">          </span><span class="c">% number of input variables</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">switch</span><span class="w"> </span><span class="n">measure_type</span><span class="w">               </span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="p">;</span><span class="w">      </span><span class="c">% number of output variables</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="k">end</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="n">Q_v</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="n">weight_v</span><span class="o">*</span><span class="nb">eye</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">);</span><span class="w">          </span><span class="c">% penalty for velocity error</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="n">Q_s</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="n">weight_s</span><span class="o">*</span><span class="nb">eye</span><span class="p">(</span><span class="n">p_ctr</span><span class="o">-</span><span class="n">n_vehicle</span><span class="p">);</span><span class="w">    </span><span class="c">% penalty for spacing error</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="n">Q</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">blkdiag</span><span class="p">(</span><span class="n">Q_v</span><span class="p">,</span><span class="n">Q_s</span><span class="p">);</span><span class="w">                 </span><span class="c">% penalty for trajectory error</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="n">R</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="n">weight_u</span><span class="o">*</span><span class="nb">eye</span><span class="p">(</span><span class="n">m_ctr</span><span class="p">);</span><span class="w">              </span><span class="c">% penalty for control input</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="n">u</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">m_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">     </span><span class="c">% control input</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="n">x</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">n_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">     </span><span class="c">% state variables</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="n">y</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">     </span><span class="c">% output variables</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="n">pr_status</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time_step</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">         </span><span class="c">% problem status</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="n">e</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">total_time_step</span><span class="p">);</span><span class="w">         </span><span class="c">% external input</span>
</code></pre></div>
</details>

<ul>
<li>Pre-collected data</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c">% load pre-collected data for DeeP-LCC</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">i_data</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% id of the pre-collected data</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\trajectory_data_collection\data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
</code></pre></div>
</details>

<p>Simulation</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c">% Mixed traffic states</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="c">% S(time,vehicle id,state variable), in state variable: 1. position; 2. velocity; 3. acceleration</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">S</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time_step</span><span class="p">,</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">hdv_parameter</span><span class="p">.</span><span class="n">s_star</span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="k">end</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="n">v_star</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="c">%  reference trajectory is all zeros: stabilize the system to equilibrium</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="n">r</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p_ctr</span><span class="p">,</span><span class="n">total_time_step</span><span class="o">+</span><span class="n">N</span><span class="p">);</span><span class="w"> </span>
</code></pre></div>
</details>

<p>Experiment starts here
- Initialization: all the vehicles use the HDV model</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">initialization_time</span><span class="o">/</span><span class="n">Tstep</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="c">% calculate acceleration</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">acel</span><span class="w">            </span><span class="p">=</span><span class="w">  </span><span class="n">HDV_dynamics</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,:),</span><span class="n">hdv_parameter</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">                            </span><span class="o">-</span><span class="n">acel_noise</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">acel_noise</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">               </span><span class="c">% the head vehicle</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">acel</span><span class="p">;</span><span class="w">            </span><span class="c">% all the vehicles use HDV model</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="c">% update traffic states</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">vel</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">    </span><span class="c">% the velocity of the head vehicle</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="c">% update equilibrium velocity</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">    </span><span class="n">v_star</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">vel</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">    </span><span class="c">% update states in DeeP-LCC</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">    </span><span class="n">y</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">    </span><span class="n">e</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">    </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pos_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="k">end</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="c">% update past data in control process</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="n">uini</span><span class="w">                </span><span class="p">=</span><span class="w"> </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="n">yini</span><span class="w">                </span><span class="p">=</span><span class="w"> </span><span class="n">y</span><span class="p">(:,</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="n">eini</span><span class="w">                </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span>
</code></pre></div>
</details>

<ul>
<li>The CAVs start to use DeeP-LCC</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">initialization_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">total_time_step</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="c">% calculate acceleration for the HDVs</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="n">acel</span><span class="w">            </span><span class="p">=</span><span class="w">  </span><span class="n">HDV_dynamics</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,:),</span><span class="n">hdv_parameter</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">                    </span><span class="o">-</span><span class="n">acel_noise</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">acel_noise</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">acel</span><span class="p">;</span><span class="w">     </span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">mix</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="n">controller_type</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c">% calculate control input via DeeP-LCC     </span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_DeeP_LCC</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span><span class="n">Yp</span><span class="p">,</span><span class="n">Uf</span><span class="p">,</span><span class="n">Yf</span><span class="p">,</span><span class="n">Ep</span><span class="p">,</span><span class="n">Ef</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">eini</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">                        </span><span class="n">lambda_g</span><span class="p">,</span><span class="n">lambda_y</span><span class="p">,</span><span class="n">u_limit</span><span class="p">,</span><span class="n">s_limit</span><span class="p">);</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_DeeP_LCC</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span><span class="n">Yp</span><span class="p">,</span><span class="n">Uf</span><span class="p">,</span><span class="n">Yf</span><span class="p">,</span><span class="n">Ep</span><span class="p">,</span><span class="n">Ef</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">eini</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">                        </span><span class="n">lambda_g</span><span class="p">,</span><span class="n">lambda_y</span><span class="p">);</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">                </span><span class="k">end</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c">% calculate control input via MPC</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_MPC</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">Tstep</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="n">measure_type</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">u_limit</span><span class="p">,</span><span class="n">s_limit</span><span class="p">);</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">                    </span><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">pr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_MPC</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">Tstep</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="n">measure_type</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">(:,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">                </span><span class="k">end</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">        </span><span class="c">% one-step implementation in receding horizon manner</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">        </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w">                      </span><span class="p">=</span><span class="w"> </span><span class="n">u_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">m_ctr</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">        </span><span class="c">% update accleration for the CAV</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w">        </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pos_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">        </span><span class="c">% judge whether AEB (automatic emergency braking, which is implemented in the function of &#39;HDV_dynamics&#39;) commands to brake</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">        </span><span class="n">brake_vehicle_ID</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">acel</span><span class="o">==</span><span class="n">dcel_max</span><span class="p">);</span><span class="w">                </span><span class="c">% the vehicles that need to brake</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">        </span><span class="n">brake_cav_ID</span><span class="w">                </span><span class="p">=</span><span class="w"> </span><span class="nb">intersect</span><span class="p">(</span><span class="n">brake_vehicle_ID</span><span class="p">,</span><span class="n">pos_cav</span><span class="p">);</span><span class="w"> </span><span class="c">% the CAVs that need to brake</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">brake_cav_ID</span><span class="p">)</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="w">            </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">brake_cav_ID</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">dcel_max</span><span class="p">;</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="w">        </span><span class="c">% record problem status</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="w">        </span><span class="n">pr_status</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w">                </span><span class="p">=</span><span class="w"> </span><span class="n">pr</span><span class="p">;</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="w">    </span><span class="c">% update traffic states</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="w">    </span><span class="c">% trajectory for the head vehicle</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a><span class="w">    </span><span class="c">% before adaption_time, the head vehicle maintains its velocity and the CAVs first stabilize the traffic system</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="w"> </span>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="w">        </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">vel</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a><span class="w">        </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">vel</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="p">(</span><span class="n">initialization_time</span><span class="o">+</span><span class="n">adaption_time</span><span class="p">)</span><span class="o">/</span><span class="n">Tstep</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a><span class="w">    </span><span class="c">% update equilibrium setup for the CAVs</span>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a><span class="w">    </span><span class="n">v_star</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w">              </span><span class="c">% average velocity of the head vehicle among the past Tini time</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a><span class="w">    </span><span class="n">s_star</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">v_star</span><span class="o">/</span><span class="mi">30</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">35</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">    </span><span class="c">% use the OVM-type spacing policy to calculate the equilibrium spacing of the CAVs</span>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a><span class="w">    </span><span class="c">% update past data in control process</span>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a><span class="w">    </span><span class="n">uini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">u</span><span class="p">(:,</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a><span class="w">    </span><span class="c">% the output needs to be re-calculated since the equilibrium has been updated</span>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k_past</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a><span class="w">        </span><span class="n">y</span><span class="p">(:,</span><span class="n">k_past</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k_past</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k_past</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a><span class="w">        </span><span class="n">e</span><span class="p">(</span><span class="n">k_past</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k_past</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a><span class="w">    </span><span class="k">end</span><span class="w"> </span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a><span class="w">    </span><span class="n">yini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">y</span><span class="p">(:,</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a><span class="w">    </span><span class="n">eini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a><span class="w">    </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Current simulation time: %.2f seconds (%.2f%%) \n&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">*</span><span class="n">Tstep</span><span class="p">,(</span><span class="n">k</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="n">initialization_time</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">total_time</span><span class="o">-</span><span class="n">initialization_time</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>
<a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a><span class="k">end</span>
<a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a><span class="n">k_end</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a><span class="n">y</span><span class="p">(:,</span><span class="n">k_end</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k_end</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k_end</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>
<a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a><span class="n">tsim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">toc</span><span class="p">;</span>
<a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>
<a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Simulation ends at %6.4f seconds \n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tsim</span><span class="p">);</span>
</code></pre></div>
</details>

<p>Results output</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">if</span><span class="w"> </span><span class="n">mix</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">switch</span><span class="w"> </span><span class="n">controller_type</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="w">    </span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">        </span><span class="nb">save</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\DeeP_LCC\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;_lambdaG_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_g</span><span class="p">),</span><span class="s">&#39;_lambdaY_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_y</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">            </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">);</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">        </span><span class="nb">save</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\MPC\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">            </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">);</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="k">end</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="k">else</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">    </span><span class="nb">save</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\HDV\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">            </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">);</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="k">end</span>
</code></pre></div>
</details>

<h4 id="functions">Functions<a class="headerlink" href="#functions" title="Permanent link">&para;</a></h4>
<h5 id="hdv_dynamicsm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/_fcn/HDV_dynamics.m">HDV_dynamics.m</a><a class="headerlink" href="#hdv_dynamicsm" title="Permanent link">&para;</a></h5>
<p>This function takes S and parameter as input to  calculate the acceleration of HDVs.</p>
<ul>
<li>S:            state of all the vehicles</li>
<li>type:         type of the HDV car-following model</li>
<li>parameter:    Parameter value in the car-following model</li>
<li>acel:         acceleration of HDVs</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">function</span><span class="w"> </span>[acel]<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">HDV_dynamics</span><span class="p">(</span>S,parameter<span class="p">)</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">num_vehicle</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">acel_max</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">dcel_max</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="k">switch</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="n">type</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="w">                    </span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">        </span><span class="n">V_diff</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:(</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">        </span><span class="n">D_diff</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:(</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">        </span><span class="n">cal_D</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">D_diff</span><span class="o">&#39;</span><span class="p">;</span><span class="w"> </span><span class="c">% For the boundary of Optimal Veloicity Calculation</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">num_vehicle</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">cal_D</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="n">s_go</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">                </span><span class="n">cal_D</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="n">s_go</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="n">cal_D</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="n">s_st</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">                </span><span class="n">cal_D</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="n">s_st</span><span class="p">;</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">            </span><span class="k">end</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">        </span><span class="k">end</span><span class="w">        </span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">        </span><span class="c">% nonlinear OVM Model</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">        </span><span class="c">% V_d = v_max/2*(1-cos(pi*(s-s_st)/(s_go-s_st)));</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">        </span><span class="c">% a   = alpha*(V_d-v2)+beta*(v1-v2);</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">        </span><span class="n">acel</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="n">alpha</span><span class="o">.*</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="n">v_max</span><span class="o">/</span><span class="mi">2</span><span class="o">.*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">cos</span><span class="p">(</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="n">cal_D</span><span class="o">-</span><span class="n">parameter</span><span class="p">.</span><span class="n">s_st</span><span class="p">)</span><span class="o">./</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="n">s_go</span><span class="o">-</span><span class="n">parameter</span><span class="p">.</span><span class="n">s_st</span><span class="p">)))</span><span class="w"> </span><span class="k">...</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">                </span><span class="o">-</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="n">beta</span><span class="o">.*</span><span class="n">V_diff</span><span class="o">&#39;</span><span class="p">;</span><span class="w">       </span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">        </span><span class="c">% % acceleration saturation</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">        </span><span class="n">acel</span><span class="p">(</span><span class="n">acel</span><span class="o">&gt;</span><span class="n">acel_max</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">acel_max</span><span class="p">;</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="w">        </span><span class="n">acel</span><span class="p">(</span><span class="n">acel</span><span class="o">&lt;</span><span class="n">dcel_max</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcel_max</span><span class="p">;</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">        </span><span class="c">%</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">        </span><span class="c">% SD as ADAS to prevent crash</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">        </span><span class="n">acel_sd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:(</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="o">./</span><span class="mi">2</span><span class="o">./</span><span class="n">D_diff</span><span class="p">;</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">        </span><span class="n">acel</span><span class="p">(</span><span class="n">acel_sd</span><span class="o">&gt;</span><span class="nb">abs</span><span class="p">(</span><span class="n">dcel_max</span><span class="p">))</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcel_max</span><span class="p">;</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">        </span><span class="c">% Driver Model: IDM</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="w">        </span><span class="n">v_max</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="w">        </span><span class="n">T_gap</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a><span class="w">        </span><span class="n">a</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a><span class="w">        </span><span class="n">b</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a><span class="w">        </span><span class="n">delta</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a><span class="w">        </span><span class="n">s_st</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>
<a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a><span class="w">        </span><span class="n">V_diff</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:(</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a><span class="w">        </span><span class="n">D_diff</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:(</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>
<a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a><span class="w">        </span><span class="n">acel</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">a</span><span class="o">.*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">v_max</span><span class="p">)</span><span class="o">.^</span><span class="n">delta</span><span class="w"> </span><span class="o">-</span><span class="k">...</span>
<a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a><span class="w">                    </span><span class="p">((</span><span class="n">s_st</span><span class="o">+</span><span class="n">T_gap</span><span class="o">.*</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">V_diff</span><span class="o">.*</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">./</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">./</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">./</span><span class="n">D_diff</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a><span class="w">        </span><span class="n">acel</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">acel</span><span class="o">&#39;</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a><span class="w">        </span><span class="c">% % acceleration saturation</span>
<a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a><span class="w">        </span><span class="c">% acel(acel&gt;acel_max) = acel_max;</span>
<a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a><span class="w">        </span><span class="c">% acel(acel&lt;dcel_max) = dcel_max;</span>
<a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a><span class="w">        </span><span class="c">%</span>
<a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a><span class="w">        </span><span class="c">% SD as ADAS to prevent crash</span>
<a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="w">        </span><span class="n">acel_sd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:(</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="o">./</span><span class="mi">2</span><span class="o">./</span><span class="n">D_diff</span><span class="p">;</span>
<a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a><span class="w">        </span><span class="n">acel</span><span class="p">(</span><span class="n">acel_sd</span><span class="o">&gt;</span><span class="nb">abs</span><span class="p">(</span><span class="n">dcel_max</span><span class="p">))</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dcel_max</span><span class="p">;</span>
<a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a><span class="k">end</span>
<a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a>
<a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a><span class="k">end</span>
</code></pre></div>
</details>

<h5 id="hankel_matrixm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/_fcn/hankel_matrix.m">hankel_matrix.m</a><a class="headerlink" href="#hankel_matrixm" title="Permanent link">&para;</a></h5>
<p>This function is used for generating a Hankel matrix of order L.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">function</span><span class="w"> </span>[U]<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">hankel_matrix</span><span class="p">(</span>u,L<span class="p">)</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">m</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">T</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">U</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">L</span><span class="p">,</span><span class="n">T</span><span class="o">-</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">L</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">   </span><span class="n">U</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="p">):</span><span class="nb">i</span><span class="o">*</span><span class="n">m</span><span class="p">,:)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">u</span><span class="p">(:,</span><span class="nb">i</span><span class="p">:(</span><span class="nb">i</span><span class="o">+</span><span class="n">T</span><span class="o">-</span><span class="n">L</span><span class="p">));</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="k">end</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="k">end</span>
</code></pre></div>
</details>

<h5 id="measure_mixed_trafficm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/_fcn/measure_mixed_traffic.m">measure_mixed_traffic.m</a><a class="headerlink" href="#measure_mixed_trafficm" title="Permanent link">&para;</a></h5>
<p>This function take the a series of parameters setting as input to measure the output in mixed traffic flow.</p>
<ul>
<li>vel:      velocity of each vehicle</li>
<li>pos:      position of each vehicle    </li>
<li>ID:       ID of vehicle types (1 for CAV, 0 for HDV)</li>
<li>v_star:   equilibrium velocity</li>
<li>s_star:   equilibrium spacing</li>
<li>type:<br />
(1) Only the velocity errors of all the vehicles are measurable;<br />
(2) All the states, including velocity error and spacing error are measurable;<br />
(3) Velocity error and spacing error of the CAVs are measurable,and the velocity error of the HDVs are measurable.  </li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">function</span><span class="w"> </span>[y]<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">measure_mixed_traffic</span><span class="p">(</span>vel,pos,ID,v_star,s_star,type<span class="p">)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">pos_cav</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">ID</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span><span class="w">          </span><span class="c">% position of CAVs</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="k">switch</span><span class="w"> </span><span class="nb">type</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">        </span><span class="n">spacing</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pos</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[(</span><span class="n">vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">             </span><span class="p">(</span><span class="n">spacing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_star</span><span class="p">)</span><span class="o">&#39;</span><span class="p">];</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">        </span><span class="n">spacing</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pos</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[(</span><span class="n">vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_star</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">             </span><span class="p">(</span><span class="n">spacing</span><span class="p">(</span><span class="n">pos_cav</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_star</span><span class="p">)</span><span class="o">&#39;</span><span class="p">];</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="k">end</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="k">end</span>
</code></pre></div>
</details>

<h5 id="qp_deep_lccm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/_fcn/qp_DeeP_LCC.m">qp_DeeP_LCC.m</a><a class="headerlink" href="#qp_deep_lccm" title="Permanent link">&para;</a></h5>
<p>Input:</p>
<ul>
<li>Up &amp; Uf:             Hankel matrix of pre-collected input data</li>
<li>Yp &amp; Yf:             Hankel matrix of pre-collected output data</li>
<li>Ep &amp; Ef:             Hankel matrix of pre-collected external input data</li>
<li>uini &amp; yini &amp; eini:  past data of length Tini in control process</li>
<li>Q &amp; R:               weight coefficient matrix in performance cost</li>
<li>r:                   reference trajectory</li>
<li>lambda_g &amp; lambda_y: coefficient in regulation for nonlinearty and uncertainty</li>
<li>u_limit &amp; s_limit:   bound on control input &amp; spacing</li>
</ul>
<p>Output:</p>
<ul>
<li>u_opt:               designed optimal future control input</li>
<li>y_opt:               predicted output in the optimal future control input</li>
<li>problem_status:      problem status in optimization calculation</li>
</ul>
<p>Optimization formulation:</p>
<p>minimize
<script type="math/tex; mode=display">
||y||_{Q_blk}^2 + ||u||_{R_blk}^2 + lambda_g||g||_2^2 + lambda_y||sigma_y||_2^2 </script>
</p>
<p>subject to:
<script type="math/tex; mode=display">\begin{bmatrix}
{Up}\\
{Ep}\\
{Up}\\
{Uf}\\
{Ef}\\
{Yf}\\
\end{bmatrix} g = \begin{bmatrix}
{uini}\\
{eini}\\
{yini}\\
{u}\\
{e}\\
{y}\\
\end{bmatrix} + \begin{bmatrix}
{0}\\
{0}\\
{sigma_y}\\
{0}\\
{0}\\
{0}\\
\end{bmatrix}</script>
where e = 0, u in u_limit, [0 I_m]y in s_limit </p>
<p>We transform the problem into <strong>standard quadratic programming</strong> for calculation.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">function</span><span class="err"> [</span><span class="nf">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">problem_status</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_DeeP_LCC</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span><span class="n">Yp</span><span class="p">,</span><span class="n">Uf</span><span class="p">,</span><span class="n">Yf</span><span class="p">,</span><span class="n">Ep</span><span class="p">,</span><span class="n">Ef</span><span class="p">,</span><span class="k">...</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">eini</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">lambda_g</span><span class="p">,</span><span class="n">lambda_y</span><span class="p">,</span><span class="n">u_limit</span><span class="p">,</span><span class="n">s_limit</span><span class="p">)</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c">% whether there exists input/output constraints</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="k">if</span><span class="w"> </span><span class="nb">nargin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">15</span><span class="w">          </span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="n">constraint_bool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="k">else</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">    </span><span class="n">constraint_bool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="k">end</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="c">% ------------</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="c">% parameters</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="c">% ------------</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="n">m</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">uini</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">                </span><span class="c">% dimension of control input</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="n">p</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">yini</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">                </span><span class="c">% dimension of output</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="n">Tini</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">m</span><span class="p">;</span><span class="w">                </span><span class="c">% horizon of past data</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="n">N</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">Uf</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">m</span><span class="p">;</span><span class="w">                </span><span class="c">% horizon of future data</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="n">T</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tini</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">   </span><span class="c">% time length of pre-collected data</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="c">% reshape past data into one single trajectory</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="c">% uini = col(u(-Tini),u(-Tini+1),...,u(-1)) (similarly for yini and eini)</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="n">uini_col</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">uini</span><span class="p">,[</span><span class="n">m</span><span class="o">*</span><span class="n">Tini</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="n">yini_col</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">yini</span><span class="p">,[</span><span class="n">p</span><span class="o">*</span><span class="n">Tini</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="n">eini_col</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">eini</span><span class="p">,[</span><span class="n">Tini</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="n">r_col</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">r</span><span class="p">,[</span><span class="n">p</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="n">Q_blk</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="n">R_blk</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">    </span><span class="n">Q_blk</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">,(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="w">    </span><span class="n">R_blk</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">m</span><span class="p">,(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">R</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="k">end</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="c">% ---------------------</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="c">% Standard QP in MATLAB</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="c">% [x,fval,exitflag,output,lambda]=quadprog(H,f,A,b,B,c,l,u,x0,options)</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="c">% minimize     0.5*x&#39;*H*x+f&#39;*x    </span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="c">% subject to         A*x          &lt;= b </span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="c">%                    B*x           = c</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="c">%                    l &lt;= x &lt;= u </span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="c">% ---------------------</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="c">% Coefficient</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="n">H</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">Yf</span><span class="o">&#39;*</span><span class="n">Q_blk</span><span class="o">*</span><span class="n">Yf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Uf</span><span class="o">&#39;*</span><span class="n">R_blk</span><span class="o">*</span><span class="n">Uf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lambda_g</span><span class="o">*</span><span class="nb">eye</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">Tini</span><span class="o">-</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lambda_y</span><span class="o">*</span><span class="n">Yp</span><span class="o">&#39;*</span><span class="n">Yp</span><span class="p">;</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="n">f</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="n">lambda_y</span><span class="o">*</span><span class="n">Yp</span><span class="o">&#39;*</span><span class="n">yini_col</span><span class="p">;</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="n">B</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">Up</span><span class="p">;</span><span class="n">Ep</span><span class="p">;</span><span class="n">Ef</span><span class="p">];</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="n">c</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">uini_col</span><span class="p">;</span><span class="n">eini_col</span><span class="p">;</span><span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)];</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span><span class="w"> </span><span class="c">% there exists input/output constraints</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a><span class="w">    </span><span class="n">Sf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">p</span><span class="o">-</span><span class="n">m</span><span class="p">),</span><span class="nb">eye</span><span class="p">(</span><span class="n">m</span><span class="p">)];</span>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="w">    </span><span class="n">Sf_blk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Sf</span><span class="p">;</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="n">N</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a><span class="w">        </span><span class="n">Sf_blk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">blkdiag</span><span class="p">(</span><span class="n">Sf_blk</span><span class="p">,</span><span class="n">Sf</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">Uf</span><span class="p">;</span><span class="o">-</span><span class="n">Uf</span><span class="p">;</span><span class="n">Sf_blk</span><span class="o">*</span><span class="n">Yf</span><span class="p">;</span><span class="o">-</span><span class="n">Sf_blk</span><span class="o">*</span><span class="n">Yf</span><span class="p">];</span>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">u_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">u_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="k">...</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a><span class="w">        </span><span class="nb">max</span><span class="p">(</span><span class="n">s_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">s_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)];</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a><span class="k">else</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a><span class="k">end</span>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a><span class="n">options</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">optimoptions</span><span class="p">(</span><span class="s">&#39;quadprog&#39;</span><span class="p">);</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a><span class="n">options</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">optimoptions</span><span class="p">(</span><span class="n">options</span><span class="p">,</span><span class="s">&#39;MaxIterations&#39;</span><span class="p">,</span><span class="mf">1e4</span><span class="p">);</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a><span class="c">% options = optimoptions(&#39;quadprog&#39;,&#39;MaxIterations&#39;,1e4);</span>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a><span class="c">% Optimization</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a><span class="p">[</span><span class="n">g_opt</span><span class="p">,</span><span class="n">fval</span><span class="p">,</span><span class="n">exitflag</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">lambda</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">quadprog</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">c</span><span class="p">,[],[],[],</span><span class="n">options</span><span class="p">);</span>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a><span class="c">% Solution</span>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a><span class="n">u_opt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">Uf</span><span class="o">*</span><span class="n">g_opt</span><span class="p">;</span>
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a><span class="n">y_opt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">Yf</span><span class="o">*</span><span class="n">g_opt</span><span class="p">;</span>
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a><span class="n">problem_status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">exitflag</span><span class="p">;</span>
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a><span class="c">% % For infeasible cases</span>
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a><span class="c">% if exitflag ~= 1</span>
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a><span class="c">%     u_opt = previous_u_opt;</span>
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a><span class="c">% end</span>
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a><span class="k">end</span>
</code></pre></div>
</details>

<h5 id="qp_mpcm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/_fcn/qp_MPC.m">qp_MPC.m</a><a class="headerlink" href="#qp_mpcm" title="Permanent link">&para;</a></h5>
<p>Input:</p>
<ul>
<li>ID:                 vehicle ID</li>
<li>Ts:                 sampling time</li>
<li>hdv_type:           type of HDV car-following model</li>
<li>measure_type:       measure type for output definition</li>
<li>v_star:             equilibrium velocity</li>
<li>uini &amp; yini:        past data of length Tini in control process</li>
<li>N:                  future time length (predicted horizon)</li>
<li>Q &amp; R:              weight coefficient matrix in performance cost</li>
<li>r:                  reference trajectory</li>
<li>u_limit &amp; s_limit:  bound on control input &amp; spacing</li>
<li>previous_u_opt:     control input in previous time step</li>
</ul>
<p>Output:</p>
<ul>
<li>u_opt:               designed optimal future control input</li>
<li>y_opt:               predicted output in the optimal future control input</li>
<li>problem_status:      problem status in optimization calculation</li>
</ul>
<p>Optimization Formulation:</p>
<p>mininize <script type="math/tex; mode=display">||y||_{Q_blk}^2 + ||u||_{R_blk}^2 </script>
</p>
<p>subject to:</p>
<ul>
<li>xini is estimated from past data uini,yini </li>
<li>x    = Ax + Bu</li>
<li>y    = Cx</li>
</ul>
<p>We transform the problem into <strong>standard quadratic programming</strong> for calculation</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">function</span><span class="err"> [</span><span class="nf">u_opt</span><span class="p">,</span><span class="n">y_opt</span><span class="p">,</span><span class="n">problem_status</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">qp_MPC</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">Ts</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="n">measure_type</span><span class="p">,</span><span class="k">...</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="n">v_star</span><span class="p">,</span><span class="n">uini</span><span class="p">,</span><span class="n">yini</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">u_limit</span><span class="p">,</span><span class="n">s_limit</span><span class="p">,</span><span class="n">previous_u_opt</span><span class="p">)</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="c">%  Calculate via Linear model</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="k">if</span><span class="w"> </span><span class="nb">nargin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="w">          </span><span class="c">% whether there exists input/output constraints</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span><span class="n">constraint_bool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="k">else</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">    </span><span class="n">constraint_bool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="k">end</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="c">%  linear model</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">]</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">traffic_linear_model</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">Ts</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="n">measure_type</span><span class="p">,</span><span class="n">v_star</span><span class="p">);</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="c">%  dimension</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="n">m</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">uini</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">     </span><span class="c">% dimension of control input</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="n">p</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">yini</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">     </span><span class="c">% dimension of output</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="n">n</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">        </span><span class="c">% dimension of state</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="n">Tini</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">uini</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w">     </span><span class="c">% horizon of past data</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="c">% reshape past data into one single trajectory</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="c">% uini = col(u(-Tini),u(-Tini+1),...,u(-1)) (similarly for yini and eini)</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="n">uini_col</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">uini</span><span class="p">,[</span><span class="n">m</span><span class="o">*</span><span class="n">Tini</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="n">yini_col</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">yini</span><span class="p">,[</span><span class="n">p</span><span class="o">*</span><span class="n">Tini</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="n">Obsv_Tini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">Tini</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">    </span><span class="n">Obsv_Tini</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">,:)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">C</span><span class="o">*</span><span class="n">A</span>^<span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="k">end</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="n">Toep_Tini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">Tini</span><span class="p">,</span><span class="n">m</span><span class="o">*</span><span class="n">Tini</span><span class="p">);</span>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="n">Toep_Tini</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">C</span><span class="o">*</span><span class="n">B</span><span class="p">;</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="n">Tini</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="w">        </span><span class="n">Toep_Tini</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">,(</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">j</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">C</span><span class="o">*</span><span class="n">A</span>^<span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nb">j</span><span class="p">)</span><span class="o">*</span><span class="n">B</span><span class="p">;</span>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="k">end</span>
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a><span class="n">Obsv_N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a><span class="w">    </span><span class="n">Obsv_N</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">,:)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">C</span><span class="o">*</span><span class="n">A</span>^<span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a><span class="k">end</span>
<a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>
<a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a><span class="n">Toep_N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a><span class="n">Toep_N</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">C</span><span class="o">*</span><span class="n">B</span><span class="p">;</span>
<a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="n">N</span>
<a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a><span class="w">        </span><span class="n">Toep_N</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">,(</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">j</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">C</span><span class="o">*</span><span class="n">A</span>^<span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nb">j</span><span class="p">)</span><span class="o">*</span><span class="n">B</span><span class="p">;</span>
<a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a><span class="k">end</span>
<a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>
<a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a><span class="n">Ctrb_Tini</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="o">*</span><span class="n">Tini</span><span class="p">);</span>
<a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span>
<a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a><span class="w">   </span><span class="n">Ctrb_Tini</span><span class="p">(:,(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">A</span>^<span class="p">(</span><span class="n">Tini</span><span class="o">-</span><span class="nb">i</span><span class="p">)</span><span class="o">*</span><span class="n">B</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a><span class="k">end</span>
<a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a>
<a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a><span class="n">x_1</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="nb">pinv</span><span class="p">(</span><span class="n">Obsv_Tini</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">yini_col</span><span class="o">-</span><span class="n">Toep_Tini</span><span class="o">*</span><span class="n">uini_col</span><span class="p">);</span>
<a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a><span class="n">x_Tini_plus1</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">A</span>^<span class="n">Tini</span><span class="o">*</span><span class="n">x_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Ctrb_Tini</span><span class="o">*</span><span class="n">uini_col</span><span class="p">;</span>
<a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a>
<a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a><span class="n">r_col</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">r</span><span class="p">,[</span><span class="n">p</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a>
<a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a>
<a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a><span class="n">Q_blk</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a><span class="n">R_blk</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a><span class="w">    </span><span class="n">Q_blk</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">,(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a><span class="w">    </span><span class="n">R_blk</span><span class="p">((</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">m</span><span class="p">,(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">i</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">R</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a><span class="k">end</span>
<a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a>
<a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a><span class="n">Cu</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">Obsv_N</span><span class="o">*</span><span class="p">(</span><span class="n">Ctrb_Tini</span><span class="o">-</span><span class="n">A</span>^<span class="n">Tini</span><span class="o">*</span><span class="nb">pinv</span><span class="p">(</span><span class="n">Obsv_Tini</span><span class="p">)</span><span class="o">*</span><span class="n">Toep_Tini</span><span class="p">)</span><span class="o">*</span><span class="n">uini_col</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Obsv_N</span><span class="o">*</span><span class="n">A</span>^<span class="n">Tini</span><span class="o">*</span><span class="nb">pinv</span><span class="p">(</span><span class="n">Obsv_Tini</span><span class="p">)</span><span class="o">*</span><span class="n">yini_col</span><span class="p">;</span>
<a id="__codelineno-24-72" name="__codelineno-24-72" href="#__codelineno-24-72"></a><span class="c">% ---------------------</span>
<a id="__codelineno-24-73" name="__codelineno-24-73" href="#__codelineno-24-73"></a><span class="c">% Standard QP in MATLAB</span>
<a id="__codelineno-24-74" name="__codelineno-24-74" href="#__codelineno-24-74"></a><span class="c">% [x,fval,exitflag,output,lambda]=quadprog(H,f,A,b,B,c,l,u,x0,options)</span>
<a id="__codelineno-24-75" name="__codelineno-24-75" href="#__codelineno-24-75"></a><span class="c">% minimize     0.5*x&#39;*H*x+f&#39;*x    </span>
<a id="__codelineno-24-76" name="__codelineno-24-76" href="#__codelineno-24-76"></a><span class="c">% subject to         A*x          &lt;= b </span>
<a id="__codelineno-24-77" name="__codelineno-24-77" href="#__codelineno-24-77"></a><span class="c">%                    B*x           = c</span>
<a id="__codelineno-24-78" name="__codelineno-24-78" href="#__codelineno-24-78"></a><span class="c">%                    l &lt;= x &lt;= u </span>
<a id="__codelineno-24-79" name="__codelineno-24-79" href="#__codelineno-24-79"></a><span class="c">% ---------------------</span>
<a id="__codelineno-24-80" name="__codelineno-24-80" href="#__codelineno-24-80"></a>
<a id="__codelineno-24-81" name="__codelineno-24-81" href="#__codelineno-24-81"></a>
<a id="__codelineno-24-82" name="__codelineno-24-82" href="#__codelineno-24-82"></a><span class="c">% Coefficient</span>
<a id="__codelineno-24-83" name="__codelineno-24-83" href="#__codelineno-24-83"></a><span class="n">H</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">Toep_N</span><span class="o">&#39;*</span><span class="n">Q_blk</span><span class="o">*</span><span class="n">Toep_N</span><span class="o">+</span><span class="n">R_blk</span><span class="p">;</span>
<a id="__codelineno-24-84" name="__codelineno-24-84" href="#__codelineno-24-84"></a><span class="n">f</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">Toep_N</span><span class="o">&#39;*</span><span class="n">Q_blk</span><span class="o">*</span><span class="n">Obsv_N</span><span class="o">*</span><span class="n">x_Tini_plus1</span><span class="p">;</span>
<a id="__codelineno-24-85" name="__codelineno-24-85" href="#__codelineno-24-85"></a>
<a id="__codelineno-24-86" name="__codelineno-24-86" href="#__codelineno-24-86"></a><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span><span class="w"> </span><span class="c">% there exists input/output constraints</span>
<a id="__codelineno-24-87" name="__codelineno-24-87" href="#__codelineno-24-87"></a><span class="w">    </span><span class="n">Sf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">p</span><span class="o">-</span><span class="n">m</span><span class="p">),</span><span class="nb">eye</span><span class="p">(</span><span class="n">m</span><span class="p">)];</span>
<a id="__codelineno-24-88" name="__codelineno-24-88" href="#__codelineno-24-88"></a><span class="w">    </span><span class="n">Sf_blk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Sf</span><span class="p">;</span>
<a id="__codelineno-24-89" name="__codelineno-24-89" href="#__codelineno-24-89"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="n">N</span>
<a id="__codelineno-24-90" name="__codelineno-24-90" href="#__codelineno-24-90"></a><span class="w">        </span><span class="n">Sf_blk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">blkdiag</span><span class="p">(</span><span class="n">Sf_blk</span><span class="p">,</span><span class="n">Sf</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-24-91" name="__codelineno-24-91" href="#__codelineno-24-91"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-24-92" name="__codelineno-24-92" href="#__codelineno-24-92"></a><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">eye</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">);</span><span class="o">-</span><span class="nb">eye</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">);</span><span class="k">...</span>
<a id="__codelineno-24-93" name="__codelineno-24-93" href="#__codelineno-24-93"></a><span class="w">        </span><span class="n">Sf_blk</span><span class="o">*</span><span class="n">Toep_N</span><span class="p">;</span><span class="o">-</span><span class="n">Sf_blk</span><span class="o">*</span><span class="n">Toep_N</span><span class="p">];</span>
<a id="__codelineno-24-94" name="__codelineno-24-94" href="#__codelineno-24-94"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">u_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">u_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="k">...</span>
<a id="__codelineno-24-95" name="__codelineno-24-95" href="#__codelineno-24-95"></a><span class="w">        </span><span class="nb">max</span><span class="p">(</span><span class="n">s_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">Sf_blk</span><span class="o">*</span><span class="n">Cu</span><span class="p">;</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">s_limit</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">Sf_blk</span><span class="o">*</span><span class="n">Cu</span><span class="p">];</span>
<a id="__codelineno-24-96" name="__codelineno-24-96" href="#__codelineno-24-96"></a><span class="k">else</span>
<a id="__codelineno-24-97" name="__codelineno-24-97" href="#__codelineno-24-97"></a><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<a id="__codelineno-24-98" name="__codelineno-24-98" href="#__codelineno-24-98"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<a id="__codelineno-24-99" name="__codelineno-24-99" href="#__codelineno-24-99"></a><span class="k">end</span>
<a id="__codelineno-24-100" name="__codelineno-24-100" href="#__codelineno-24-100"></a>
<a id="__codelineno-24-101" name="__codelineno-24-101" href="#__codelineno-24-101"></a><span class="c">% Optimization</span>
<a id="__codelineno-24-102" name="__codelineno-24-102" href="#__codelineno-24-102"></a><span class="p">[</span><span class="n">u_opt</span><span class="p">,</span><span class="n">fval</span><span class="p">,</span><span class="n">exitflag</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">lambda</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">quadprog</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,[],[]);</span>
<a id="__codelineno-24-103" name="__codelineno-24-103" href="#__codelineno-24-103"></a>
<a id="__codelineno-24-104" name="__codelineno-24-104" href="#__codelineno-24-104"></a><span class="c">% For infeasible cases</span>
<a id="__codelineno-24-105" name="__codelineno-24-105" href="#__codelineno-24-105"></a><span class="k">if</span><span class="w"> </span><span class="n">exitflag</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-24-106" name="__codelineno-24-106" href="#__codelineno-24-106"></a><span class="w">    </span><span class="n">u_opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">previous_u_opt</span><span class="p">;</span>
<a id="__codelineno-24-107" name="__codelineno-24-107" href="#__codelineno-24-107"></a><span class="k">end</span>
<a id="__codelineno-24-108" name="__codelineno-24-108" href="#__codelineno-24-108"></a>
<a id="__codelineno-24-109" name="__codelineno-24-109" href="#__codelineno-24-109"></a><span class="c">% Solution</span>
<a id="__codelineno-24-110" name="__codelineno-24-110" href="#__codelineno-24-110"></a><span class="n">y_opt</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">Obsv_N</span><span class="o">*</span><span class="n">x_Tini_plus1</span><span class="o">+</span><span class="n">Toep_N</span><span class="o">*</span><span class="n">u_opt</span><span class="p">;</span>
<a id="__codelineno-24-111" name="__codelineno-24-111" href="#__codelineno-24-111"></a><span class="n">problem_status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">exitflag</span><span class="p">;</span>
<a id="__codelineno-24-112" name="__codelineno-24-112" href="#__codelineno-24-112"></a>
<a id="__codelineno-24-113" name="__codelineno-24-113" href="#__codelineno-24-113"></a>
<a id="__codelineno-24-114" name="__codelineno-24-114" href="#__codelineno-24-114"></a>
<a id="__codelineno-24-115" name="__codelineno-24-115" href="#__codelineno-24-115"></a><span class="k">end</span>
</code></pre></div>
</details>

<h5 id="traffic_linear_modelm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/_fcn/traffic_linear_model.m">traffic_linear_model.m</a><a class="headerlink" href="#traffic_linear_modelm" title="Permanent link">&para;</a></h5>
<p>This function is used for CLCC model.</p>
<ul>
<li>ID: vehicle ID</li>
<li>Ts: sampling time</li>
<li>hdv_type:     type of HDV car-following model</li>
<li>measure_type: measure type</li>
</ul>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">function</span><span class="w"> </span><span class="nf">[pos_cav, n_vehicle, n_cav, A, Ad,Bd,Cd] = traffic_linear_model</span><span class="p">(</span>ID,Ts,hdv_type,measure_type,v_star<span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="k">switch</span><span class="w"> </span><span class="n">hdv_type</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">        </span><span class="c">% Driver Model: OVM</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">        </span><span class="nb">alpha</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mf">0.6</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">        </span><span class="nb">beta</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mf">0.9</span><span class="p">;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">        </span><span class="n">s_st</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">        </span><span class="n">s_go</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">35</span><span class="p">;</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">        </span><span class="n">v_max</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">        </span><span class="c">% Equilibrium spacing</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">        </span><span class="n">s_star</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">v_star</span><span class="o">/</span><span class="n">v_max</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="n">s_go</span><span class="o">-</span><span class="n">s_st</span><span class="p">)</span><span class="o">+</span><span class="n">s_st</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">        </span><span class="c">% Linear coefficients</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">        </span><span class="n">alpha1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">alpha</span><span class="o">*</span><span class="n">v_max</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">/</span><span class="p">(</span><span class="n">s_go</span><span class="o">-</span><span class="n">s_st</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="n">s_star</span><span class="o">-</span><span class="n">s_st</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s_go</span><span class="o">-</span><span class="n">s_st</span><span class="p">));</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">        </span><span class="n">alpha2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">alpha</span><span class="o">+</span><span class="nb">beta</span><span class="p">;</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">        </span><span class="n">alpha3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">beta</span><span class="p">;</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">        </span><span class="c">% Driver Model: IDM</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">        </span><span class="n">v_max</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">        </span><span class="n">T_gap</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">        </span><span class="n">a</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">        </span><span class="n">b</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">        </span><span class="n">delta</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">        </span><span class="n">s_st</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">        </span><span class="c">% Equilibrium spacing</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">        </span><span class="n">s_star</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">s_st</span><span class="o">+</span><span class="n">T_gap</span><span class="o">*</span><span class="n">v_star</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">v_star</span><span class="o">/</span><span class="n">v_max</span><span class="p">)</span>^<span class="n">delta</span><span class="p">);</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">        </span><span class="c">% Linear coefficients</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">        </span><span class="n">alpha1</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">s_st</span><span class="o">+</span><span class="n">T_gap</span><span class="o">*</span><span class="n">v_star</span><span class="p">)</span>^<span class="mi">2</span><span class="o">/</span><span class="n">s_star</span>^<span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">        </span><span class="n">alpha2</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">v_star</span><span class="o">*</span><span class="p">(</span><span class="n">s_st</span><span class="o">+</span><span class="n">T_gap</span><span class="o">*</span><span class="n">v_star</span><span class="p">)</span><span class="o">/</span><span class="n">s_star</span>^<span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v_star</span>^<span class="mi">3</span><span class="o">/</span><span class="n">v_max</span>^<span class="mi">4</span><span class="o">+</span><span class="n">T_gap</span><span class="o">*</span><span class="p">(</span><span class="n">s_st</span><span class="o">+</span><span class="n">T_gap</span><span class="o">*</span><span class="n">v_star</span><span class="p">)</span><span class="o">/</span><span class="n">s_star</span>^<span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="w">        </span><span class="n">alpha3</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">v_star</span><span class="o">*</span><span class="p">(</span><span class="n">s_st</span><span class="o">+</span><span class="n">T_gap</span><span class="o">*</span><span class="n">v_star</span><span class="p">)</span><span class="o">/</span><span class="n">s_star</span>^<span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="k">end</span>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="n">pos_cav</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">ID</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span><span class="w">          </span><span class="c">% position of CAVs</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="n">n_vehicle</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="n">n_cav</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">pos_cav</span><span class="p">);</span><span class="w">      </span><span class="c">% number of CAVs</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="n">A</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="n">P1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">alpha1</span><span class="p">,</span><span class="o">-</span><span class="n">alpha2</span><span class="p">];</span>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a><span class="n">P2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span><span class="mi">0</span><span class="p">,</span><span class="n">alpha3</span><span class="p">];</span>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="n">S1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="n">S2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">P1</span><span class="p">;</span>
<a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="w">        </span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">P1</span><span class="p">;</span>
<a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a><span class="w">        </span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">P2</span><span class="p">;</span>
<a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a><span class="w">        </span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">S1</span><span class="p">;</span>
<a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a><span class="w">        </span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">S2</span><span class="p">;</span>
<a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a><span class="k">end</span>
<a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a>
<a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a><span class="n">B</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">,</span><span class="n">n_cav</span><span class="p">);</span>
<a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_cav</span>
<a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a><span class="w">   </span><span class="n">B</span><span class="p">(</span><span class="n">pos_cav</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a><span class="k">end</span>
<a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a>
<a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a><span class="k">switch</span><span class="w"> </span><span class="n">measure_type</span>
<a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a><span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">);</span>
<a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a><span class="w">            </span><span class="n">C</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-25-66" name="__codelineno-25-66" href="#__codelineno-25-66"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-25-67" name="__codelineno-25-67" href="#__codelineno-25-67"></a><span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">);</span>
<a id="__codelineno-25-68" name="__codelineno-25-68" href="#__codelineno-25-68"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-25-69" name="__codelineno-25-69" href="#__codelineno-25-69"></a><span class="w">            </span><span class="n">C</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-70" name="__codelineno-25-70" href="#__codelineno-25-70"></a><span class="w">            </span><span class="n">C</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">+</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-71" name="__codelineno-25-71" href="#__codelineno-25-71"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-25-72" name="__codelineno-25-72" href="#__codelineno-25-72"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-25-73" name="__codelineno-25-73" href="#__codelineno-25-73"></a><span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">+</span><span class="n">n_cav</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">);</span>
<a id="__codelineno-25-74" name="__codelineno-25-74" href="#__codelineno-25-74"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-25-75" name="__codelineno-25-75" href="#__codelineno-25-75"></a><span class="w">            </span><span class="n">C</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-76" name="__codelineno-25-76" href="#__codelineno-25-76"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-25-77" name="__codelineno-25-77" href="#__codelineno-25-77"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_cav</span>
<a id="__codelineno-25-78" name="__codelineno-25-78" href="#__codelineno-25-78"></a><span class="w">            </span><span class="n">C</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">+</span><span class="nb">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">pos_cav</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-79" name="__codelineno-25-79" href="#__codelineno-25-79"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-25-80" name="__codelineno-25-80" href="#__codelineno-25-80"></a><span class="k">end</span>
<a id="__codelineno-25-81" name="__codelineno-25-81" href="#__codelineno-25-81"></a>
<a id="__codelineno-25-82" name="__codelineno-25-82" href="#__codelineno-25-82"></a>
<a id="__codelineno-25-83" name="__codelineno-25-83" href="#__codelineno-25-83"></a><span class="n">Ad</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">Ts</span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">);</span>
<a id="__codelineno-25-84" name="__codelineno-25-84" href="#__codelineno-25-84"></a><span class="n">Bd</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">B</span><span class="o">*</span><span class="n">Ts</span><span class="p">;</span>
<a id="__codelineno-25-85" name="__codelineno-25-85" href="#__codelineno-25-85"></a><span class="n">Cd</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">C</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-25-86" name="__codelineno-25-86" href="#__codelineno-25-86"></a>
<a id="__codelineno-25-87" name="__codelineno-25-87" href="#__codelineno-25-87"></a><span class="k">end</span>
</code></pre></div>
</details>

<h4 id="data-generation">Data Generation<a class="headerlink" href="#data-generation" title="Permanent link">&para;</a></h4>
<h5 id="data_hdvparameterm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/data_hdvParameter.m">data_hdvParameter.m</a><a class="headerlink" href="#data_hdvparameterm" title="Permanent link">&para;</a></h5>
<p>This function is used for generating heterogeneous HDV paramters.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">hdv_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">v_star</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c">% -------------------</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="c">% ID          = [0,0,1,0,0,1,0,0];    % ID of vehicle types</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">                                    </span><span class="c">% 1: CAV  0: HDV</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="c">% -------------------</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="c">% Homegeneous setup for OVM</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="nb">alpha</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mf">0.6</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="nb">beta</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mf">0.9</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="n">s_go</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">25</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="n">s_st</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="n">v_max</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="c">% Equilibrium spacing</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="n">s_star</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">v_star</span><span class="o">/</span><span class="n">v_max</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">./</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="n">s_go</span><span class="o">-</span><span class="n">s_st</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s_st</span><span class="p">;</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="n">hdv_parameter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="k">...</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">            </span><span class="s">&#39;alpha&#39;</span><span class="p">,</span><span class="nb">alpha</span><span class="p">,</span><span class="s">&#39;beta&#39;</span><span class="p">,</span><span class="nb">beta</span><span class="p">,</span><span class="s">&#39;s_st&#39;</span><span class="p">,</span><span class="n">s_st</span><span class="p">,</span><span class="s">&#39;s_go&#39;</span><span class="p">,</span><span class="n">s_go</span><span class="p">,</span><span class="s">&#39;v_max&#39;</span><span class="p">,</span><span class="n">v_max</span><span class="p">,</span><span class="s">&#39;s_star&#39;</span><span class="p">,</span><span class="n">s_star</span><span class="p">);</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="nb">save</span><span class="p">(</span><span class="s">&#39;_data/hdv_ovm_homogeneous.mat&#39;</span><span class="p">,</span><span class="s">&#39;hdv_parameter&#39;</span><span class="p">);</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="k">switch</span><span class="w"> </span><span class="n">hdv_type</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">        </span><span class="c">% Driver Model: OVM</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">        </span><span class="nb">alpha</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mf">0.4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.4</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">        </span><span class="nb">beta</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mf">0.7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.4</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">        </span><span class="n">s_go</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">        </span><span class="n">s_st</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">        </span><span class="n">v_max</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">        </span><span class="c">% Manual set for parameters        </span>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="w">        </span><span class="nb">alpha</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.45</span><span class="p">;</span><span class="mf">0.75</span><span class="p">;</span><span class="mf">0.60</span><span class="p">;</span><span class="mf">0.70</span><span class="p">;</span><span class="mf">0.50</span><span class="p">;</span><span class="mf">0.60</span><span class="p">;</span><span class="mf">0.40</span><span class="p">;</span><span class="mf">0.80</span><span class="p">];</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="w">        </span><span class="nb">beta</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.60</span><span class="p">;</span><span class="mf">0.95</span><span class="p">;</span><span class="mf">0.90</span><span class="p">;</span><span class="mf">0.95</span><span class="p">;</span><span class="mf">0.75</span><span class="p">;</span><span class="mf">0.90</span><span class="p">;</span><span class="mf">0.80</span><span class="p">;</span><span class="mf">1.00</span><span class="p">];</span>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="w">        </span><span class="n">s_go</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">38</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">31</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">35</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">33</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">37</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">35</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">39</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">34</span><span class="w"> </span><span class="s">]</span><span class="p">;</span>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="w">        </span><span class="c">% Consider nominal parameter for the CAV position, which only works</span>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="w">        </span><span class="c">% in comparison for all the vehicles are HDVs</span>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">        </span><span class="nb">alpha</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mf">0.6</span><span class="p">;</span>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">        </span><span class="nb">alpha</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mf">0.6</span><span class="p">;</span>
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">        </span><span class="nb">beta</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.9</span><span class="p">;</span>
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">        </span><span class="nb">beta</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.9</span><span class="p">;</span>
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="w">        </span><span class="n">s_go</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">35</span><span class="p">;</span>
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="w">        </span><span class="n">s_go</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">35</span><span class="p">;</span>
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a>
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a><span class="w">        </span><span class="c">% Equilibrium spacing</span>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="w">        </span><span class="n">s_star</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">v_star</span><span class="o">/</span><span class="n">v_max</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">./</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="n">s_go</span><span class="o">-</span><span class="n">s_st</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s_st</span><span class="p">;</span>
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a>
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a><span class="w">        </span><span class="c">% Driver Model: IDM</span>
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a><span class="w">        </span><span class="n">v_max</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a><span class="w">        </span><span class="n">T_gap</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a><span class="w">        </span><span class="n">a</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a><span class="w">        </span><span class="n">b</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a><span class="w">        </span><span class="n">delta</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a><span class="w">        </span><span class="n">s_st</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a>
<a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a><span class="w">        </span><span class="c">% Equilibrium spacing</span>
<a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a><span class="w">        </span><span class="n">s_star</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">s_st</span><span class="o">+</span><span class="n">T_gap</span><span class="o">.*</span><span class="n">v_star</span><span class="p">)</span><span class="o">./</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">v_star</span><span class="o">/</span><span class="n">v_max</span><span class="p">)</span>^<span class="n">delta</span><span class="p">);</span>
<a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a><span class="k">end</span>
<a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a>
<a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a><span class="k">switch</span><span class="w"> </span><span class="n">hdv_type</span>
<a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a><span class="w">        </span><span class="n">hdv_parameter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="k">...</span>
<a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a><span class="w">            </span><span class="s">&#39;alpha&#39;</span><span class="p">,</span><span class="nb">alpha</span><span class="p">,</span><span class="s">&#39;beta&#39;</span><span class="p">,</span><span class="nb">beta</span><span class="p">,</span><span class="s">&#39;s_st&#39;</span><span class="p">,</span><span class="n">s_st</span><span class="p">,</span><span class="s">&#39;s_go&#39;</span><span class="p">,</span><span class="n">s_go</span><span class="p">,</span><span class="s">&#39;v_max&#39;</span><span class="p">,</span><span class="n">v_max</span><span class="p">,</span><span class="s">&#39;s_star&#39;</span><span class="p">,</span><span class="n">s_star</span><span class="p">);</span>
<a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a><span class="w">        </span><span class="nb">save</span><span class="p">(</span><span class="s">&#39;_data/hdv_ovm.mat&#39;</span><span class="p">,</span><span class="s">&#39;hdv_parameter&#39;</span><span class="p">);</span>
<a id="__codelineno-26-66" name="__codelineno-26-66" href="#__codelineno-26-66"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-26-67" name="__codelineno-26-67" href="#__codelineno-26-67"></a><span class="w">        </span><span class="n">hdv_parameter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="n">hdv_type</span><span class="p">,</span><span class="k">...</span>
<a id="__codelineno-26-68" name="__codelineno-26-68" href="#__codelineno-26-68"></a><span class="w">            </span><span class="s">&#39;v_max&#39;</span><span class="p">,</span><span class="n">v_max</span><span class="p">,</span><span class="s">&#39;T_gap&#39;</span><span class="p">,</span><span class="n">T_gap</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="s">&#39;delta&#39;</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="s">&#39;s_st&#39;</span><span class="p">,</span><span class="n">s_st</span><span class="p">,</span><span class="s">&#39;s_star&#39;</span><span class="p">,</span><span class="n">s_star</span><span class="p">);</span>
<a id="__codelineno-26-69" name="__codelineno-26-69" href="#__codelineno-26-69"></a><span class="w">        </span><span class="nb">save</span><span class="p">(</span><span class="s">&#39;_data/hdv_idm.mat&#39;</span><span class="p">,</span><span class="s">&#39;hdv_parameter&#39;</span><span class="p">);</span>
<a id="__codelineno-26-70" name="__codelineno-26-70" href="#__codelineno-26-70"></a><span class="k">end</span>
</code></pre></div>
</details>

<h5 id="data_trajectorydatacollectionm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/data_trajectoryDataCollection.m">data_trajectoryDataCollection.m</a><a class="headerlink" href="#data_trajectorydatacollectionm" title="Permanent link">&para;</a></h5>
<p>This function is used for data collection for random times.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">data_total_number</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">h_wait</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">waitbar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;please wait&#39;</span><span class="p">);</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="k">for</span><span class="w"> </span><span class="n">i_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">data_total_number</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="c">%   Parameter setup</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="c">% Type for HDV car-following model</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="n">hdv_type</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. OVM   2. IDM</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="c">% Uncertainty for HDV behavior</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="n">acel_noise</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% A white noise signal on HDV&#39;s original acceleration</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="c">% Data set</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="n">data_str</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;3&#39;</span><span class="p">;</span><span class="w">  </span><span class="c">% 1. random ovm  2. manual ovm  3. homogeneous ovm</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="c">% Parameters in Simulation</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="n">total_time</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w">              </span><span class="c">% Total Simulation Time</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="n">Tstep</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span><span class="w">            </span><span class="c">% Time Step</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="n">total_time_step</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">;</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="c">% DeePC Formulation</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="n">T</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">      </span><span class="c">% length of data samples</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="n">Tini</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">        </span><span class="c">% length of past data</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="n">N</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w">        </span><span class="c">% length of predicted horizon</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="n">weight_v</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c">% weight coefficient for velocity error</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="n">weight_s</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for spacing error   </span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="n">weight_u</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for control input</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="n">lambda_g</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c">% penalty on ||g||_2^2 in objective</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="n">lambda_y</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">1e3</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||sigma_y||_2^2 in objective</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="c">% System Dynamics</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="c">% vel_noise = 0.1;         % noise signal in velocity signal</span>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="c">% ------------------------------------------</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="c">% Parameters in Mixed Traffic</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="c">% ------------------------------------------</span>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a><span class="n">ID</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span><span class="w">    </span><span class="c">% ID of vehicle types</span>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a><span class="w">                                    </span><span class="c">% 1: CAV  0: HDV</span>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a><span class="n">pos_cav</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">ID</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span><span class="w">          </span><span class="c">% position of CAVs</span>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a><span class="n">n_vehicle</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a><span class="n">n_cav</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">pos_cav</span><span class="p">);</span><span class="w">      </span><span class="c">% number of CAVs</span>
<a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a><span class="n">n_hdv</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">-</span><span class="n">n_cav</span><span class="p">;</span><span class="w">      </span><span class="c">% number of HDVs</span>
<a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a>
<a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a><span class="n">mix</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">                    </span><span class="c">% whether mixed traffic flow</span>
<a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>
<a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a><span class="n">v_star</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w">                   </span><span class="c">% Equilibrium velocity</span>
<a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a><span class="n">s_star</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">                   </span><span class="c">% Equilibrium spacing for CAV</span>
<a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>
<a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a><span class="k">switch</span><span class="w"> </span><span class="n">hdv_type</span>
<a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a><span class="w">        </span><span class="c">% Driver Model: OVM</span>
<a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a><span class="w">        </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data/hdv_ovm_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">data_str</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a><span class="w">        </span><span class="c">% Driver Model: IDM</span>
<a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a><span class="w">        </span><span class="nb">load</span><span class="p">(</span><span class="s">&#39;_data/hdv_idm.mat&#39;</span><span class="p">);</span>
<a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a><span class="c">%         v_max   = 30;</span>
<a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a><span class="c">%         T_gap   = 1;</span>
<a id="__codelineno-27-62" name="__codelineno-27-62" href="#__codelineno-27-62"></a><span class="c">%         a       = 1;</span>
<a id="__codelineno-27-63" name="__codelineno-27-63" href="#__codelineno-27-63"></a><span class="c">%         b       = 1.5;</span>
<a id="__codelineno-27-64" name="__codelineno-27-64" href="#__codelineno-27-64"></a><span class="c">%         delta   = 4;</span>
<a id="__codelineno-27-65" name="__codelineno-27-65" href="#__codelineno-27-65"></a><span class="c">%         s_st    = 5;</span>
<a id="__codelineno-27-66" name="__codelineno-27-66" href="#__codelineno-27-66"></a><span class="c">%         % Equilibrium spacing</span>
<a id="__codelineno-27-67" name="__codelineno-27-67" href="#__codelineno-27-67"></a><span class="c">%         s_star  = (s_st+T_gap*v_star)/sqrt(1-(v_star/v_max)^delta);        </span>
<a id="__codelineno-27-68" name="__codelineno-27-68" href="#__codelineno-27-68"></a><span class="k">end</span>
<a id="__codelineno-27-69" name="__codelineno-27-69" href="#__codelineno-27-69"></a>
<a id="__codelineno-27-70" name="__codelineno-27-70" href="#__codelineno-27-70"></a><span class="n">acel_max</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-27-71" name="__codelineno-27-71" href="#__codelineno-27-71"></a><span class="n">dcel_max</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-27-72" name="__codelineno-27-72" href="#__codelineno-27-72"></a>
<a id="__codelineno-27-73" name="__codelineno-27-73" href="#__codelineno-27-73"></a><span class="c">% What is measurable</span>
<a id="__codelineno-27-74" name="__codelineno-27-74" href="#__codelineno-27-74"></a><span class="c">% for measure_type    = 2:3</span>
<a id="__codelineno-27-75" name="__codelineno-27-75" href="#__codelineno-27-75"></a><span class="n">measure_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-27-76" name="__codelineno-27-76" href="#__codelineno-27-76"></a><span class="c">% 1. Only the velocity errors of all the vehicles are measurable;</span>
<a id="__codelineno-27-77" name="__codelineno-27-77" href="#__codelineno-27-77"></a><span class="c">% 2. All the states, including velocity error and spacing error are measurable;</span>
<a id="__codelineno-27-78" name="__codelineno-27-78" href="#__codelineno-27-78"></a><span class="c">% 3. Velocity error and spacing error of the CAVs are measurable, </span>
<a id="__codelineno-27-79" name="__codelineno-27-79" href="#__codelineno-27-79"></a><span class="c">%    and the velocity error of the HDVs are measurable.</span>
<a id="__codelineno-27-80" name="__codelineno-27-80" href="#__codelineno-27-80"></a>
<a id="__codelineno-27-81" name="__codelineno-27-81" href="#__codelineno-27-81"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-82" name="__codelineno-27-82" href="#__codelineno-27-82"></a><span class="c">%  size in DeePC</span>
<a id="__codelineno-27-83" name="__codelineno-27-83" href="#__codelineno-27-83"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-84" name="__codelineno-27-84" href="#__codelineno-27-84"></a>
<a id="__codelineno-27-85" name="__codelineno-27-85" href="#__codelineno-27-85"></a><span class="n">n_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span><span class="w">    </span><span class="c">% number of state variables</span>
<a id="__codelineno-27-86" name="__codelineno-27-86" href="#__codelineno-27-86"></a><span class="n">m_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span><span class="w">          </span><span class="c">% number of input variables</span>
<a id="__codelineno-27-87" name="__codelineno-27-87" href="#__codelineno-27-87"></a><span class="k">switch</span><span class="w"> </span><span class="n">measure_type</span><span class="w">     </span><span class="c">% number of output variables</span>
<a id="__codelineno-27-88" name="__codelineno-27-88" href="#__codelineno-27-88"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-27-89" name="__codelineno-27-89" href="#__codelineno-27-89"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="p">;</span>
<a id="__codelineno-27-90" name="__codelineno-27-90" href="#__codelineno-27-90"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-27-91" name="__codelineno-27-91" href="#__codelineno-27-91"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span>
<a id="__codelineno-27-92" name="__codelineno-27-92" href="#__codelineno-27-92"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-27-93" name="__codelineno-27-93" href="#__codelineno-27-93"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span>
<a id="__codelineno-27-94" name="__codelineno-27-94" href="#__codelineno-27-94"></a><span class="k">end</span>
<a id="__codelineno-27-95" name="__codelineno-27-95" href="#__codelineno-27-95"></a>
<a id="__codelineno-27-96" name="__codelineno-27-96" href="#__codelineno-27-96"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-27-97" name="__codelineno-27-97" href="#__codelineno-27-97"></a><span class="c">%   Scenario initialization</span>
<a id="__codelineno-27-98" name="__codelineno-27-98" href="#__codelineno-27-98"></a><span class="c">%-------------------------------------------------------------------------- </span>
<a id="__codelineno-27-99" name="__codelineno-27-99" href="#__codelineno-27-99"></a>
<a id="__codelineno-27-100" name="__codelineno-27-100" href="#__codelineno-27-100"></a><span class="c">% There is one head vehicle at the very beginning</span>
<a id="__codelineno-27-101" name="__codelineno-27-101" href="#__codelineno-27-101"></a><span class="n">S</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time_step</span><span class="p">,</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-27-102" name="__codelineno-27-102" href="#__codelineno-27-102"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-27-103" name="__codelineno-27-103" href="#__codelineno-27-103"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-27-104" name="__codelineno-27-104" href="#__codelineno-27-104"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">hdv_parameter</span><span class="p">.</span><span class="n">s_star</span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-27-105" name="__codelineno-27-105" href="#__codelineno-27-105"></a><span class="k">end</span>
<a id="__codelineno-27-106" name="__codelineno-27-106" href="#__codelineno-27-106"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">v_star</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-27-107" name="__codelineno-27-107" href="#__codelineno-27-107"></a>
<a id="__codelineno-27-108" name="__codelineno-27-108" href="#__codelineno-27-108"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-27-109" name="__codelineno-27-109" href="#__codelineno-27-109"></a><span class="c">%   Data collection</span>
<a id="__codelineno-27-110" name="__codelineno-27-110" href="#__codelineno-27-110"></a><span class="c">%-------------------------------------------------------------------------- </span>
<a id="__codelineno-27-111" name="__codelineno-27-111" href="#__codelineno-27-111"></a>
<a id="__codelineno-27-112" name="__codelineno-27-112" href="#__codelineno-27-112"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-113" name="__codelineno-27-113" href="#__codelineno-27-113"></a><span class="c">%  persistently exciting input data</span>
<a id="__codelineno-27-114" name="__codelineno-27-114" href="#__codelineno-27-114"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-115" name="__codelineno-27-115" href="#__codelineno-27-115"></a><span class="n">ud</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">m_ctr</span><span class="p">,</span><span class="n">T</span><span class="p">);</span>
<a id="__codelineno-27-116" name="__codelineno-27-116" href="#__codelineno-27-116"></a><span class="n">ed</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="p">);</span>
<a id="__codelineno-27-117" name="__codelineno-27-117" href="#__codelineno-27-117"></a><span class="n">yd</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p_ctr</span><span class="p">,</span><span class="n">T</span><span class="p">);</span>
<a id="__codelineno-27-118" name="__codelineno-27-118" href="#__codelineno-27-118"></a>
<a id="__codelineno-27-119" name="__codelineno-27-119" href="#__codelineno-27-119"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-120" name="__codelineno-27-120" href="#__codelineno-27-120"></a><span class="c">%  generate output data</span>
<a id="__codelineno-27-121" name="__codelineno-27-121" href="#__codelineno-27-121"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-122" name="__codelineno-27-122" href="#__codelineno-27-122"></a><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-27-123" name="__codelineno-27-123" href="#__codelineno-27-123"></a><span class="w">    </span><span class="c">% Update acceleration</span>
<a id="__codelineno-27-124" name="__codelineno-27-124" href="#__codelineno-27-124"></a><span class="w">    </span><span class="n">acel</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="n">HDV_dynamics</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,:),</span><span class="n">hdv_parameter</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<a id="__codelineno-27-125" name="__codelineno-27-125" href="#__codelineno-27-125"></a><span class="w">                         </span><span class="o">-</span><span class="n">acel_noise</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">acel_noise</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-27-126" name="__codelineno-27-126" href="#__codelineno-27-126"></a>
<a id="__codelineno-27-127" name="__codelineno-27-127" href="#__codelineno-27-127"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">         </span><span class="c">% the head vehicle</span>
<a id="__codelineno-27-128" name="__codelineno-27-128" href="#__codelineno-27-128"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">acel</span><span class="p">;</span><span class="w">      </span><span class="c">% all the vehicles using HDV model</span>
<a id="__codelineno-27-129" name="__codelineno-27-129" href="#__codelineno-27-129"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pos_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">ud</span><span class="p">(:,</span><span class="n">k</span><span class="p">);</span><span class="w">   </span><span class="c">% the CAVs</span>
<a id="__codelineno-27-130" name="__codelineno-27-130" href="#__codelineno-27-130"></a>
<a id="__codelineno-27-131" name="__codelineno-27-131" href="#__codelineno-27-131"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-27-132" name="__codelineno-27-132" href="#__codelineno-27-132"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ed</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span><span class="w">   </span><span class="c">% the velocity of the head vehicle</span>
<a id="__codelineno-27-133" name="__codelineno-27-133" href="#__codelineno-27-133"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">);</span><span class="w">    </span>
<a id="__codelineno-27-134" name="__codelineno-27-134" href="#__codelineno-27-134"></a>
<a id="__codelineno-27-135" name="__codelineno-27-135" href="#__codelineno-27-135"></a><span class="w">    </span><span class="n">yd</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-27-136" name="__codelineno-27-136" href="#__codelineno-27-136"></a><span class="k">end</span>
<a id="__codelineno-27-137" name="__codelineno-27-137" href="#__codelineno-27-137"></a><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-27-138" name="__codelineno-27-138" href="#__codelineno-27-138"></a><span class="n">yd</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-27-139" name="__codelineno-27-139" href="#__codelineno-27-139"></a>
<a id="__codelineno-27-140" name="__codelineno-27-140" href="#__codelineno-27-140"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-141" name="__codelineno-27-141" href="#__codelineno-27-141"></a><span class="c">%  organize past data and future data</span>
<a id="__codelineno-27-142" name="__codelineno-27-142" href="#__codelineno-27-142"></a><span class="c">% ------------------</span>
<a id="__codelineno-27-143" name="__codelineno-27-143" href="#__codelineno-27-143"></a><span class="n">U</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">hankel_matrix</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">Tini</span><span class="o">+</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-27-144" name="__codelineno-27-144" href="#__codelineno-27-144"></a><span class="n">Up</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="o">*</span><span class="n">m_ctr</span><span class="p">,:);</span>
<a id="__codelineno-27-145" name="__codelineno-27-145" href="#__codelineno-27-145"></a><span class="n">Uf</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">U</span><span class="p">((</span><span class="n">Tini</span><span class="o">*</span><span class="n">m_ctr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="k">end</span><span class="p">,:);</span>
<a id="__codelineno-27-146" name="__codelineno-27-146" href="#__codelineno-27-146"></a>
<a id="__codelineno-27-147" name="__codelineno-27-147" href="#__codelineno-27-147"></a><span class="n">E</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">hankel_matrix</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span><span class="n">Tini</span><span class="o">+</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-27-148" name="__codelineno-27-148" href="#__codelineno-27-148"></a><span class="n">Ep</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">E</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="p">,:);</span>
<a id="__codelineno-27-149" name="__codelineno-27-149" href="#__codelineno-27-149"></a><span class="n">Ef</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">E</span><span class="p">((</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="k">end</span><span class="p">,:);</span>
<a id="__codelineno-27-150" name="__codelineno-27-150" href="#__codelineno-27-150"></a>
<a id="__codelineno-27-151" name="__codelineno-27-151" href="#__codelineno-27-151"></a><span class="n">Y</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">hankel_matrix</span><span class="p">(</span><span class="n">yd</span><span class="p">,</span><span class="n">Tini</span><span class="o">+</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-27-152" name="__codelineno-27-152" href="#__codelineno-27-152"></a><span class="n">Yp</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="o">*</span><span class="n">p_ctr</span><span class="p">,:);</span>
<a id="__codelineno-27-153" name="__codelineno-27-153" href="#__codelineno-27-153"></a><span class="n">Yf</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">Y</span><span class="p">((</span><span class="n">Tini</span><span class="o">*</span><span class="n">p_ctr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="k">end</span><span class="p">,:);</span>
<a id="__codelineno-27-154" name="__codelineno-27-154" href="#__codelineno-27-154"></a>
<a id="__codelineno-27-155" name="__codelineno-27-155" href="#__codelineno-27-155"></a><span class="n">str</span><span class="p">=[</span><span class="s">&#39;Processing...&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="o">/</span><span class="n">data_total_number</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span><span class="s">&#39;%&#39;</span><span class="p">];</span>
<a id="__codelineno-27-156" name="__codelineno-27-156" href="#__codelineno-27-156"></a><span class="w">    </span><span class="nb">waitbar</span><span class="p">(</span><span class="n">i_data</span><span class="o">/</span><span class="n">data_total_number</span><span class="p">,</span><span class="n">h_wait</span><span class="p">,</span><span class="n">str</span><span class="p">);</span>
<a id="__codelineno-27-157" name="__codelineno-27-157" href="#__codelineno-27-157"></a>
<a id="__codelineno-27-158" name="__codelineno-27-158" href="#__codelineno-27-158"></a><span class="nb">save</span><span class="p">([</span><span class="s">&#39;_data\trajectory_data_collection\data&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">data_str</span><span class="p">),</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-27-159" name="__codelineno-27-159" href="#__codelineno-27-159"></a><span class="w">    </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;Up&#39;</span><span class="p">,</span><span class="s">&#39;Yp&#39;</span><span class="p">,</span><span class="s">&#39;Uf&#39;</span><span class="p">,</span><span class="s">&#39;Yf&#39;</span><span class="p">,</span><span class="s">&#39;Ep&#39;</span><span class="p">,</span><span class="s">&#39;Ef&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">);</span>
<a id="__codelineno-27-160" name="__codelineno-27-160" href="#__codelineno-27-160"></a>
<a id="__codelineno-27-161" name="__codelineno-27-161" href="#__codelineno-27-161"></a><span class="k">end</span>
<a id="__codelineno-27-162" name="__codelineno-27-162" href="#__codelineno-27-162"></a>
<a id="__codelineno-27-163" name="__codelineno-27-163" href="#__codelineno-27-163"></a><span class="nb">close</span><span class="p">(</span><span class="n">h_wait</span><span class="p">);</span>
</code></pre></div>
</details>

<h5 id="data_trajectorydatacollection_hdvtrajectoryprocessm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/data_trajectoryDataCollection_HDVTrajectoryProcess.m">data_trajectoryDataCollection_HDVTrajectoryProcess.m</a><a class="headerlink" href="#data_trajectorydatacollection_hdvtrajectoryprocessm" title="Permanent link">&para;</a></h5>
<p>This function is used for data collection for random times.
It serves the same purpose as <a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/data_trajectoryDataCollection.m">data_trajectoryDataCollection.m</a>. It was created for testing purpose. It has no impact if not used at all.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c">% Data set</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="n">data_str</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p">;</span><span class="w">  </span><span class="c">% 1. random ovm  2. manual ovm  3. homogeneous ovm</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="c">% Mix or not</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="n">mix</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 0. all HDVs; 1. mix</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c">% Type of the controller</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="n">controller_type</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. DeePC  2. MPC  3.SPC  4. SPC without Regulation</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="c">% Type for HDV car-following model</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="n">hdv_type</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. OVM   2. IDM</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="c">% Uncertainty for HDV behavior</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="n">acel_noise</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% A white noise signal on HDV&#39;s original acceleration</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="c">% Perturbation amplitude</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="n">per_type</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">   </span><span class="c">% 1. sinuoid perturbation 2. brake perturbation 3. ngsim simulation</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="n">per_amp</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="c">% Whether there exists constraints</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="n">constraint_bool</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="n">i_data</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">     </span><span class="c">% Data set number</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="k">if</span><span class="w"> </span><span class="n">per_type</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">        </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\simulation_data\HDV\constrained_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">        </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;DeePC&#39;</span><span class="p">;</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">        </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\simulation_data\HDV\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;_lambdaG_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_g</span><span class="p">),</span><span class="s">&#39;_lambdaY_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_y</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">        </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;DeePC&#39;</span><span class="p">;</span>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="k">else</span><span class="w"> </span><span class="c">% ngsim simulation</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">    </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\simulation_data\HDV\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">        </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">    </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;HDV&#39;</span><span class="p">;</span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="k">end</span>
<a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>
<a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="c">%   Parameter setup</span>
<a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>
<a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="c">% Parameters in Simulation</span>
<a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="n">total_time</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w">              </span><span class="c">% Total Simulation Time</span>
<a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a><span class="n">Tstep</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span><span class="w">            </span><span class="c">% Time Step</span>
<a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a><span class="n">total_time_step</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">;</span>
<a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a>
<a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a><span class="c">% DeePC Formulation</span>
<a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a><span class="n">T</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">      </span><span class="c">% length of data samples</span>
<a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a><span class="n">Tini</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">        </span><span class="c">% length of past data</span>
<a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a><span class="n">N</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w">        </span><span class="c">% length of predicted horizon</span>
<a id="__codelineno-28-48" name="__codelineno-28-48" href="#__codelineno-28-48"></a>
<a id="__codelineno-28-49" name="__codelineno-28-49" href="#__codelineno-28-49"></a><span class="n">weight_v</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c">% weight coefficient for velocity error</span>
<a id="__codelineno-28-50" name="__codelineno-28-50" href="#__codelineno-28-50"></a><span class="n">weight_s</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for spacing error   </span>
<a id="__codelineno-28-51" name="__codelineno-28-51" href="#__codelineno-28-51"></a><span class="n">weight_u</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for control input</span>
<a id="__codelineno-28-52" name="__codelineno-28-52" href="#__codelineno-28-52"></a>
<a id="__codelineno-28-53" name="__codelineno-28-53" href="#__codelineno-28-53"></a><span class="n">lambda_g</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c">% penalty on ||g||_2^2 in objective</span>
<a id="__codelineno-28-54" name="__codelineno-28-54" href="#__codelineno-28-54"></a><span class="n">lambda_y</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">1e3</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||sigma_y||_2^2 in objective</span>
<a id="__codelineno-28-55" name="__codelineno-28-55" href="#__codelineno-28-55"></a>
<a id="__codelineno-28-56" name="__codelineno-28-56" href="#__codelineno-28-56"></a><span class="c">% System Dynamics</span>
<a id="__codelineno-28-57" name="__codelineno-28-57" href="#__codelineno-28-57"></a><span class="c">% vel_noise = 0.1;         % noise signal in velocity signal</span>
<a id="__codelineno-28-58" name="__codelineno-28-58" href="#__codelineno-28-58"></a>
<a id="__codelineno-28-59" name="__codelineno-28-59" href="#__codelineno-28-59"></a><span class="c">% ------------------------------------------</span>
<a id="__codelineno-28-60" name="__codelineno-28-60" href="#__codelineno-28-60"></a><span class="c">% Parameters in Mixed Traffic</span>
<a id="__codelineno-28-61" name="__codelineno-28-61" href="#__codelineno-28-61"></a><span class="c">% ------------------------------------------</span>
<a id="__codelineno-28-62" name="__codelineno-28-62" href="#__codelineno-28-62"></a><span class="n">ID</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span><span class="w">    </span><span class="c">% ID of vehicle types</span>
<a id="__codelineno-28-63" name="__codelineno-28-63" href="#__codelineno-28-63"></a><span class="w">                                    </span><span class="c">% 1: CAV  0: HDV</span>
<a id="__codelineno-28-64" name="__codelineno-28-64" href="#__codelineno-28-64"></a><span class="n">pos_cav</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">ID</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span><span class="w">          </span><span class="c">% position of CAVs</span>
<a id="__codelineno-28-65" name="__codelineno-28-65" href="#__codelineno-28-65"></a><span class="n">n_vehicle</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-28-66" name="__codelineno-28-66" href="#__codelineno-28-66"></a><span class="n">n_cav</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">pos_cav</span><span class="p">);</span><span class="w">      </span><span class="c">% number of CAVs</span>
<a id="__codelineno-28-67" name="__codelineno-28-67" href="#__codelineno-28-67"></a><span class="n">n_hdv</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">-</span><span class="n">n_cav</span><span class="p">;</span><span class="w">      </span><span class="c">% number of HDVs</span>
<a id="__codelineno-28-68" name="__codelineno-28-68" href="#__codelineno-28-68"></a>
<a id="__codelineno-28-69" name="__codelineno-28-69" href="#__codelineno-28-69"></a><span class="n">mix</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">                    </span><span class="c">% whether mixed traffic flow</span>
<a id="__codelineno-28-70" name="__codelineno-28-70" href="#__codelineno-28-70"></a>
<a id="__codelineno-28-71" name="__codelineno-28-71" href="#__codelineno-28-71"></a><span class="n">v_star</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w">                   </span><span class="c">% Equilibrium velocity</span>
<a id="__codelineno-28-72" name="__codelineno-28-72" href="#__codelineno-28-72"></a><span class="n">s_star</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">                   </span><span class="c">% Equilibrium spacing for CAV</span>
<a id="__codelineno-28-73" name="__codelineno-28-73" href="#__codelineno-28-73"></a>
<a id="__codelineno-28-74" name="__codelineno-28-74" href="#__codelineno-28-74"></a>
<a id="__codelineno-28-75" name="__codelineno-28-75" href="#__codelineno-28-75"></a>
<a id="__codelineno-28-76" name="__codelineno-28-76" href="#__codelineno-28-76"></a><span class="n">acel_max</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-28-77" name="__codelineno-28-77" href="#__codelineno-28-77"></a><span class="n">dcel_max</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-28-78" name="__codelineno-28-78" href="#__codelineno-28-78"></a>
<a id="__codelineno-28-79" name="__codelineno-28-79" href="#__codelineno-28-79"></a><span class="c">% What is measurable</span>
<a id="__codelineno-28-80" name="__codelineno-28-80" href="#__codelineno-28-80"></a><span class="c">% for measure_type    = 2:3</span>
<a id="__codelineno-28-81" name="__codelineno-28-81" href="#__codelineno-28-81"></a><span class="n">measure_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-28-82" name="__codelineno-28-82" href="#__codelineno-28-82"></a><span class="c">% 1. Only the velocity errors of all the vehicles are measurable;</span>
<a id="__codelineno-28-83" name="__codelineno-28-83" href="#__codelineno-28-83"></a><span class="c">% 2. All the states, including velocity error and spacing error are measurable;</span>
<a id="__codelineno-28-84" name="__codelineno-28-84" href="#__codelineno-28-84"></a><span class="c">% 3. Velocity error and spacing error of the CAVs are measurable, </span>
<a id="__codelineno-28-85" name="__codelineno-28-85" href="#__codelineno-28-85"></a><span class="c">%    and the velocity error of the HDVs are measurable.</span>
<a id="__codelineno-28-86" name="__codelineno-28-86" href="#__codelineno-28-86"></a>
<a id="__codelineno-28-87" name="__codelineno-28-87" href="#__codelineno-28-87"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-88" name="__codelineno-28-88" href="#__codelineno-28-88"></a><span class="c">%  size in DeePC</span>
<a id="__codelineno-28-89" name="__codelineno-28-89" href="#__codelineno-28-89"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-90" name="__codelineno-28-90" href="#__codelineno-28-90"></a>
<a id="__codelineno-28-91" name="__codelineno-28-91" href="#__codelineno-28-91"></a><span class="n">n_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span><span class="w">    </span><span class="c">% number of state variables</span>
<a id="__codelineno-28-92" name="__codelineno-28-92" href="#__codelineno-28-92"></a><span class="n">m_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span><span class="w">          </span><span class="c">% number of input variables</span>
<a id="__codelineno-28-93" name="__codelineno-28-93" href="#__codelineno-28-93"></a><span class="k">switch</span><span class="w"> </span><span class="n">measure_type</span><span class="w">     </span><span class="c">% number of output variables</span>
<a id="__codelineno-28-94" name="__codelineno-28-94" href="#__codelineno-28-94"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-28-95" name="__codelineno-28-95" href="#__codelineno-28-95"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="p">;</span>
<a id="__codelineno-28-96" name="__codelineno-28-96" href="#__codelineno-28-96"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-28-97" name="__codelineno-28-97" href="#__codelineno-28-97"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">n_vehicle</span><span class="p">;</span>
<a id="__codelineno-28-98" name="__codelineno-28-98" href="#__codelineno-28-98"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-28-99" name="__codelineno-28-99" href="#__codelineno-28-99"></a><span class="w">        </span><span class="n">p_ctr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n_vehicle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_cav</span><span class="p">;</span>
<a id="__codelineno-28-100" name="__codelineno-28-100" href="#__codelineno-28-100"></a><span class="k">end</span>
<a id="__codelineno-28-101" name="__codelineno-28-101" href="#__codelineno-28-101"></a>
<a id="__codelineno-28-102" name="__codelineno-28-102" href="#__codelineno-28-102"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-28-103" name="__codelineno-28-103" href="#__codelineno-28-103"></a><span class="c">%   Scenario initialization</span>
<a id="__codelineno-28-104" name="__codelineno-28-104" href="#__codelineno-28-104"></a><span class="c">%-------------------------------------------------------------------------- </span>
<a id="__codelineno-28-105" name="__codelineno-28-105" href="#__codelineno-28-105"></a>
<a id="__codelineno-28-106" name="__codelineno-28-106" href="#__codelineno-28-106"></a><span class="c">% There is one head vehicle at the very beginning</span>
<a id="__codelineno-28-107" name="__codelineno-28-107" href="#__codelineno-28-107"></a><span class="n">S</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time_step</span><span class="p">,</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-28-108" name="__codelineno-28-108" href="#__codelineno-28-108"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-28-109" name="__codelineno-28-109" href="#__codelineno-28-109"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-28-110" name="__codelineno-28-110" href="#__codelineno-28-110"></a><span class="w">    </span><span class="c">% S(1,i,1) = S(1,i-1,1) - hdv_parameter.s_star(i-1);</span>
<a id="__codelineno-28-111" name="__codelineno-28-111" href="#__codelineno-28-111"></a><span class="w">    </span><span class="c">% S(1,i,1) = S(1,i-1,1) - s_star(i-1);</span>
<a id="__codelineno-28-112" name="__codelineno-28-112" href="#__codelineno-28-112"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_star</span><span class="p">;</span>
<a id="__codelineno-28-113" name="__codelineno-28-113" href="#__codelineno-28-113"></a><span class="k">end</span>
<a id="__codelineno-28-114" name="__codelineno-28-114" href="#__codelineno-28-114"></a><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">v_star</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-28-115" name="__codelineno-28-115" href="#__codelineno-28-115"></a>
<a id="__codelineno-28-116" name="__codelineno-28-116" href="#__codelineno-28-116"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-28-117" name="__codelineno-28-117" href="#__codelineno-28-117"></a><span class="c">%   Data collection</span>
<a id="__codelineno-28-118" name="__codelineno-28-118" href="#__codelineno-28-118"></a><span class="c">%-------------------------------------------------------------------------- </span>
<a id="__codelineno-28-119" name="__codelineno-28-119" href="#__codelineno-28-119"></a>
<a id="__codelineno-28-120" name="__codelineno-28-120" href="#__codelineno-28-120"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-121" name="__codelineno-28-121" href="#__codelineno-28-121"></a><span class="c">%  persistently exciting input data</span>
<a id="__codelineno-28-122" name="__codelineno-28-122" href="#__codelineno-28-122"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-123" name="__codelineno-28-123" href="#__codelineno-28-123"></a><span class="n">ud</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mf">0.1</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">m_ctr</span><span class="p">,</span><span class="n">T</span><span class="p">);</span>
<a id="__codelineno-28-124" name="__codelineno-28-124" href="#__codelineno-28-124"></a><span class="n">ed</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="p">);</span>
<a id="__codelineno-28-125" name="__codelineno-28-125" href="#__codelineno-28-125"></a><span class="n">yd</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">p_ctr</span><span class="p">,</span><span class="n">T</span><span class="p">);</span>
<a id="__codelineno-28-126" name="__codelineno-28-126" href="#__codelineno-28-126"></a>
<a id="__codelineno-28-127" name="__codelineno-28-127" href="#__codelineno-28-127"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-128" name="__codelineno-28-128" href="#__codelineno-28-128"></a><span class="c">%  generate output data</span>
<a id="__codelineno-28-129" name="__codelineno-28-129" href="#__codelineno-28-129"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-130" name="__codelineno-28-130" href="#__codelineno-28-130"></a><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-28-131" name="__codelineno-28-131" href="#__codelineno-28-131"></a><span class="w">    </span><span class="c">% Update acceleration</span>
<a id="__codelineno-28-132" name="__codelineno-28-132" href="#__codelineno-28-132"></a><span class="w">    </span><span class="n">acel</span><span class="w">               </span><span class="p">=</span><span class="w"> </span><span class="n">HDV_dynamics</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,:),</span><span class="n">hdv_parameter</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<a id="__codelineno-28-133" name="__codelineno-28-133" href="#__codelineno-28-133"></a><span class="w">                         </span><span class="o">-</span><span class="n">acel_noise</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">acel_noise</span><span class="o">*</span><span class="nb">rand</span><span class="p">(</span><span class="n">n_vehicle</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-28-134" name="__codelineno-28-134" href="#__codelineno-28-134"></a>
<a id="__codelineno-28-135" name="__codelineno-28-135" href="#__codelineno-28-135"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">         </span><span class="c">% the head vehicle</span>
<a id="__codelineno-28-136" name="__codelineno-28-136" href="#__codelineno-28-136"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="n">acel</span><span class="p">;</span><span class="w">      </span><span class="c">% all the vehicles using HDV model</span>
<a id="__codelineno-28-137" name="__codelineno-28-137" href="#__codelineno-28-137"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pos_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">ud</span><span class="p">(:,</span><span class="n">k</span><span class="p">);</span><span class="w">   </span><span class="c">% the CAVs</span>
<a id="__codelineno-28-138" name="__codelineno-28-138" href="#__codelineno-28-138"></a>
<a id="__codelineno-28-139" name="__codelineno-28-139" href="#__codelineno-28-139"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-28-140" name="__codelineno-28-140" href="#__codelineno-28-140"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ed</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v_star</span><span class="p">;</span><span class="w">   </span><span class="c">% the velocity of the head vehicle</span>
<a id="__codelineno-28-141" name="__codelineno-28-141" href="#__codelineno-28-141"></a><span class="w">    </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tstep</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">2</span><span class="p">);</span><span class="w">    </span>
<a id="__codelineno-28-142" name="__codelineno-28-142" href="#__codelineno-28-142"></a>
<a id="__codelineno-28-143" name="__codelineno-28-143" href="#__codelineno-28-143"></a><span class="w">    </span><span class="n">yd</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-28-144" name="__codelineno-28-144" href="#__codelineno-28-144"></a><span class="k">end</span>
<a id="__codelineno-28-145" name="__codelineno-28-145" href="#__codelineno-28-145"></a><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-28-146" name="__codelineno-28-146" href="#__codelineno-28-146"></a><span class="n">yd</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">measure_mixed_traffic</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">S</span><span class="p">(</span><span class="n">k</span><span class="p">,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">ID</span><span class="p">,</span><span class="n">v_star</span><span class="p">,</span><span class="n">s_star</span><span class="p">,</span><span class="n">measure_type</span><span class="p">);</span>
<a id="__codelineno-28-147" name="__codelineno-28-147" href="#__codelineno-28-147"></a>
<a id="__codelineno-28-148" name="__codelineno-28-148" href="#__codelineno-28-148"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-149" name="__codelineno-28-149" href="#__codelineno-28-149"></a><span class="c">%  organize past data and future data</span>
<a id="__codelineno-28-150" name="__codelineno-28-150" href="#__codelineno-28-150"></a><span class="c">% ------------------</span>
<a id="__codelineno-28-151" name="__codelineno-28-151" href="#__codelineno-28-151"></a><span class="n">U</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">hankel_matrix</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">Tini</span><span class="o">+</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-28-152" name="__codelineno-28-152" href="#__codelineno-28-152"></a><span class="n">Up</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="o">*</span><span class="n">m_ctr</span><span class="p">,:);</span>
<a id="__codelineno-28-153" name="__codelineno-28-153" href="#__codelineno-28-153"></a><span class="n">Uf</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">U</span><span class="p">((</span><span class="n">Tini</span><span class="o">*</span><span class="n">m_ctr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="k">end</span><span class="p">,:);</span>
<a id="__codelineno-28-154" name="__codelineno-28-154" href="#__codelineno-28-154"></a>
<a id="__codelineno-28-155" name="__codelineno-28-155" href="#__codelineno-28-155"></a><span class="n">E</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">hankel_matrix</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span><span class="n">Tini</span><span class="o">+</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-28-156" name="__codelineno-28-156" href="#__codelineno-28-156"></a><span class="n">Ep</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">E</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="p">,:);</span>
<a id="__codelineno-28-157" name="__codelineno-28-157" href="#__codelineno-28-157"></a><span class="n">Ef</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">E</span><span class="p">((</span><span class="n">Tini</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="k">end</span><span class="p">,:);</span>
<a id="__codelineno-28-158" name="__codelineno-28-158" href="#__codelineno-28-158"></a>
<a id="__codelineno-28-159" name="__codelineno-28-159" href="#__codelineno-28-159"></a><span class="n">Y</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">hankel_matrix</span><span class="p">(</span><span class="n">yd</span><span class="p">,</span><span class="n">Tini</span><span class="o">+</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-28-160" name="__codelineno-28-160" href="#__codelineno-28-160"></a><span class="n">Yp</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Tini</span><span class="o">*</span><span class="n">p_ctr</span><span class="p">,:);</span>
<a id="__codelineno-28-161" name="__codelineno-28-161" href="#__codelineno-28-161"></a><span class="n">Yf</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">Y</span><span class="p">((</span><span class="n">Tini</span><span class="o">*</span><span class="n">p_ctr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="k">end</span><span class="p">,:);</span>
<a id="__codelineno-28-162" name="__codelineno-28-162" href="#__codelineno-28-162"></a>
<a id="__codelineno-28-163" name="__codelineno-28-163" href="#__codelineno-28-163"></a><span class="n">str</span><span class="p">=[</span><span class="s">&#39;Processing...&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="o">/</span><span class="n">data_total_number</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span><span class="s">&#39;%&#39;</span><span class="p">];</span>
<a id="__codelineno-28-164" name="__codelineno-28-164" href="#__codelineno-28-164"></a><span class="w">    </span><span class="nb">waitbar</span><span class="p">(</span><span class="n">i_data</span><span class="o">/</span><span class="n">data_total_number</span><span class="p">,</span><span class="n">h_wait</span><span class="p">,</span><span class="n">str</span><span class="p">);</span>
<a id="__codelineno-28-165" name="__codelineno-28-165" href="#__codelineno-28-165"></a>
<a id="__codelineno-28-166" name="__codelineno-28-166" href="#__codelineno-28-166"></a><span class="nb">save</span><span class="p">([</span><span class="s">&#39;_data\trajectory_data_collection\data&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">data_str</span><span class="p">),</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">],</span><span class="k">...</span>
<a id="__codelineno-28-167" name="__codelineno-28-167" href="#__codelineno-28-167"></a><span class="w">    </span><span class="s">&#39;hdv_type&#39;</span><span class="p">,</span><span class="s">&#39;acel_noise&#39;</span><span class="p">,</span><span class="s">&#39;Up&#39;</span><span class="p">,</span><span class="s">&#39;Yp&#39;</span><span class="p">,</span><span class="s">&#39;Uf&#39;</span><span class="p">,</span><span class="s">&#39;Yf&#39;</span><span class="p">,</span><span class="s">&#39;Ep&#39;</span><span class="p">,</span><span class="s">&#39;Ef&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;Tini&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;ID&#39;</span><span class="p">,</span><span class="s">&#39;Tstep&#39;</span><span class="p">,</span><span class="s">&#39;v_star&#39;</span><span class="p">);</span>
<a id="__codelineno-28-168" name="__codelineno-28-168" href="#__codelineno-28-168"></a>
<a id="__codelineno-28-169" name="__codelineno-28-169" href="#__codelineno-28-169"></a><span class="c">%end</span>
<a id="__codelineno-28-170" name="__codelineno-28-170" href="#__codelineno-28-170"></a>
<a id="__codelineno-28-171" name="__codelineno-28-171" href="#__codelineno-28-171"></a><span class="nb">close</span><span class="p">(</span><span class="n">h_wait</span><span class="p">);</span>
</code></pre></div>
</details>

<h5 id="nedc_trajectorym"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/nedc_trajectory.m">nedc_trajectory.m</a><a class="headerlink" href="#nedc_trajectorym" title="Permanent link">&para;</a></h5>
<p>Defining velocity of the head vehicle based on nedc.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">Tstep</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">total_time</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">14</span><span class="o">+</span><span class="mi">20</span><span class="p">;</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="nb">time</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">total_time</span><span class="p">;</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">vel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="n">cruise_time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="n">change_time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="mi">50</span><span class="p">);</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">13</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="p">));</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">30</span><span class="o">/</span><span class="mi">35</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="p">));</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">20</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="p">));</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">120</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">14</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">120</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">50</span><span class="o">/</span><span class="mi">14</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="p">));</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">14</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="w">   </span><span class="k">end</span>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a><span class="k">end</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a><span class="nb">save</span><span class="p">(</span><span class="s">&#39;nedc.mat&#39;</span><span class="p">,</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;vel&#39;</span><span class="p">);</span>
</code></pre></div>
</details>

<h5 id="nedc_modified_trajectorym"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/nedc_modified_trajectory.m">nedc_modified_trajectory.m</a><a class="headerlink" href="#nedc_modified_trajectorym" title="Permanent link">&para;</a></h5>
<p>It serves the same purpose as <a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/nedc_trajectory.m">nedc_trajectory.m</a>. It was created for testing purpose and has no impact if not used at all.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">Tstep</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">total_time</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">25</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">20</span><span class="p">;</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="nb">time</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">total_time</span><span class="p">;</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="n">vel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="n">cruise_time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="n">change_time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">13</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="p">));</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">25</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">30</span><span class="o">/</span><span class="mi">25</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span><span class="p">));</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">25</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">25</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">30</span><span class="o">/</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">25</span><span class="o">+</span><span class="mi">20</span><span class="p">));</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">25</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w">   </span><span class="k">end</span>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="k">end</span>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="nb">plot</span><span class="p">(</span><span class="n">vel</span><span class="p">);</span>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="c">% save(&#39;.\_data\nedc_modified_v2.mat&#39;,&#39;time&#39;,&#39;vel&#39;);</span>
</code></pre></div>
</details>

<h5 id="nedc_trajectory_modifiedm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/nedc_trajectory_modified.m">nedc_trajectory_modified.m</a><a class="headerlink" href="#nedc_trajectory_modifiedm" title="Permanent link">&para;</a></h5>
<p>It serves the same purpose as <a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/data_generation/nedc_trajectory.m">nedc_trajectory.m</a>. It was created for testing purpose and has no impact if not used at all.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">Tstep</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="n">total_time</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">14</span><span class="o">+</span><span class="mi">20</span><span class="p">;</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="nb">time</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">total_time</span><span class="p">;</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">vel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="n">cruise_time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="n">change_time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="mi">50</span><span class="p">);</span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">13</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="p">));</span>
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span>
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span>
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">30</span><span class="o">/</span><span class="mi">35</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="p">));</span>
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span>
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="o">/</span><span class="mi">20</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="p">));</span>
<a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span>
<a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">120</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">14</span>
<a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">120</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">50</span><span class="o">/</span><span class="mi">14</span><span class="o">*</span><span class="p">(</span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="o">-</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="p">));</span>
<a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="nb">i</span><span class="o">*</span><span class="n">Tstep</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">69</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">50</span><span class="o">+</span><span class="mi">35</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">14</span><span class="o">+</span><span class="mi">20</span>
<a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="w">       </span><span class="n">vel</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">70</span><span class="p">;</span>
<a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="w">   </span><span class="k">end</span>
<a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="k">end</span>
<a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="nb">plot</span><span class="p">(</span><span class="n">vel</span><span class="p">);</span>
<a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a>
<a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a><span class="nb">save</span><span class="p">(</span><span class="s">&#39;nedc.mat&#39;</span><span class="p">,</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;vel&#39;</span><span class="p">);</span>
</code></pre></div>
</details>

<h4 id="plot-figure">Plot Figure<a class="headerlink" href="#plot-figure" title="Permanent link">&para;</a></h4>
<h5 id="figure_brakeperturbation_trajectorym"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/plot_figure/Figure_BrakePerturbation_Trajectory.m">Figure_BrakePerturbation_Trajectory.m</a><a class="headerlink" href="#figure_brakeperturbation_trajectorym" title="Permanent link">&para;</a></h5>
<p>This function is used for analysis for simulation results under same data sample.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c">% Data set</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">data_str</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p">;</span><span class="w">  </span><span class="c">% 1. random ovm  2. manual ovm  3. homogeneous ovm</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="c">% Mix or not</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">mix</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">    </span><span class="c">% 0. all HDVs; 1. mix</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="c">% Type of the controller</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="n">controller_type</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. DeeP-LCC  2. MPC </span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="c">% Type for HDV car-following model</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="n">hdv_type</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. OVM   2. IDM</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="c">% Uncertainty for HDV behavior</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="n">acel_noise</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% A white noise signal on HDV&#39;s original acceleration</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="c">% Perturbation amplitude</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="n">per_type</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">   </span><span class="c">% 1. sinuoid perturbation 2. brake perturbation 3. ngsim simulation</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="n">per_amp</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="c">% whether there exists constraints</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="n">constraint_bool</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="c">% wheter fix equilibrium spacing</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="n">fixed_spacing_bool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="c">% Simulation Time</span>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="n">begin_time</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="n">end_time</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w">              </span>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="n">i_data</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">     </span><span class="c">% Data set number</span>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="n">weight_v</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c">% weight coefficient for velocity error</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="n">weight_s</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for spacing error   </span>
<a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="n">weight_u</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for control input</span>
<a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a>
<a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a><span class="n">lambda_g</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||g||_2^2 in objective</span>
<a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a><span class="n">lambda_y</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">1e4</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||sigma_y||_2^2 in objective</span>
<a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a>
<a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a>
<a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a>
<a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a><span class="k">if</span><span class="w"> </span><span class="n">mix</span>
<a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a><span class="k">switch</span><span class="w"> </span><span class="n">controller_type</span>
<a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-32-37" name="__codelineno-32-37" href="#__codelineno-32-37"></a><span class="w">            </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\DeeP_LCC\constrained_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-32-38" name="__codelineno-32-38" href="#__codelineno-32-38"></a><span class="w">                </span><span class="s">&#39;_fixSpacing_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">fixed_spacing_bool</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-32-39" name="__codelineno-32-39" href="#__codelineno-32-39"></a><span class="w">                </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;_lambdaG_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_g</span><span class="p">),</span><span class="s">&#39;_lambdaY_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_y</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-32-40" name="__codelineno-32-40" href="#__codelineno-32-40"></a><span class="w">            </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;DeeP-LCC&#39;</span><span class="p">;</span>
<a id="__codelineno-32-41" name="__codelineno-32-41" href="#__codelineno-32-41"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-32-42" name="__codelineno-32-42" href="#__codelineno-32-42"></a><span class="w">        </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\MPC\constrained_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-32-43" name="__codelineno-32-43" href="#__codelineno-32-43"></a><span class="w">            </span><span class="s">&#39;_fixSpacing_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">fixed_spacing_bool</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-32-44" name="__codelineno-32-44" href="#__codelineno-32-44"></a><span class="w">            </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-32-45" name="__codelineno-32-45" href="#__codelineno-32-45"></a><span class="w">        </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;MPC&#39;</span><span class="p">;</span><span class="w">    </span>
<a id="__codelineno-32-46" name="__codelineno-32-46" href="#__codelineno-32-46"></a><span class="k">end</span>
<a id="__codelineno-32-47" name="__codelineno-32-47" href="#__codelineno-32-47"></a><span class="k">else</span>
<a id="__codelineno-32-48" name="__codelineno-32-48" href="#__codelineno-32-48"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">constraint_bool</span>
<a id="__codelineno-32-49" name="__codelineno-32-49" href="#__codelineno-32-49"></a><span class="w">            </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\HDV\constrained_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-32-50" name="__codelineno-32-50" href="#__codelineno-32-50"></a><span class="w">                </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-32-51" name="__codelineno-32-51" href="#__codelineno-32-51"></a><span class="w">            </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;DeeP-LCC&#39;</span><span class="p">;</span>
<a id="__codelineno-32-52" name="__codelineno-32-52" href="#__codelineno-32-52"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-32-53" name="__codelineno-32-53" href="#__codelineno-32-53"></a><span class="w">            </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\HDV\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_perType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">per_type</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-32-54" name="__codelineno-32-54" href="#__codelineno-32-54"></a><span class="w">                </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;_lambdaG_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_g</span><span class="p">),</span><span class="s">&#39;_lambdaY_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_y</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-32-55" name="__codelineno-32-55" href="#__codelineno-32-55"></a><span class="w">            </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;DeeP-LCC&#39;</span><span class="p">;</span>
<a id="__codelineno-32-56" name="__codelineno-32-56" href="#__codelineno-32-56"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-32-57" name="__codelineno-32-57" href="#__codelineno-32-57"></a><span class="k">end</span>
<a id="__codelineno-32-58" name="__codelineno-32-58" href="#__codelineno-32-58"></a>
<a id="__codelineno-32-59" name="__codelineno-32-59" href="#__codelineno-32-59"></a>
<a id="__codelineno-32-60" name="__codelineno-32-60" href="#__codelineno-32-60"></a><span class="n">n_vehicle</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-32-61" name="__codelineno-32-61" href="#__codelineno-32-61"></a>
<a id="__codelineno-32-62" name="__codelineno-32-62" href="#__codelineno-32-62"></a>
<a id="__codelineno-32-63" name="__codelineno-32-63" href="#__codelineno-32-63"></a>
<a id="__codelineno-32-64" name="__codelineno-32-64" href="#__codelineno-32-64"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-32-65" name="__codelineno-32-65" href="#__codelineno-32-65"></a><span class="c">%   Plot Results</span>
<a id="__codelineno-32-66" name="__codelineno-32-66" href="#__codelineno-32-66"></a><span class="c">%--------------------------------------------------------------------------</span>
<a id="__codelineno-32-67" name="__codelineno-32-67" href="#__codelineno-32-67"></a><span class="n">color_gray</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">190</span><span class="w"> </span><span class="mi">190</span><span class="w"> </span><span class="mi">190</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-32-68" name="__codelineno-32-68" href="#__codelineno-32-68"></a><span class="n">color_red</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">124</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-32-69" name="__codelineno-32-69" href="#__codelineno-32-69"></a><span class="n">color_blue</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">121</span><span class="p">,</span><span class="w"> </span><span class="mi">227</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-32-70" name="__codelineno-32-70" href="#__codelineno-32-70"></a><span class="n">color_black</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-32-71" name="__codelineno-32-71" href="#__codelineno-32-71"></a><span class="n">color_orange</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">31</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-32-72" name="__codelineno-32-72" href="#__codelineno-32-72"></a><span class="n">label_size</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
<a id="__codelineno-32-73" name="__codelineno-32-73" href="#__codelineno-32-73"></a><span class="n">total_size</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span>
<a id="__codelineno-32-74" name="__codelineno-32-74" href="#__codelineno-32-74"></a><span class="n">line_width</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-32-75" name="__codelineno-32-75" href="#__codelineno-32-75"></a>
<a id="__codelineno-32-76" name="__codelineno-32-76" href="#__codelineno-32-76"></a><span class="c">% Velocity</span>
<a id="__codelineno-32-77" name="__codelineno-32-77" href="#__codelineno-32-77"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-32-78" name="__codelineno-32-78" href="#__codelineno-32-78"></a><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-32-79" name="__codelineno-32-79" href="#__codelineno-32-79"></a><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_black</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-32-80" name="__codelineno-32-80" href="#__codelineno-32-80"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-32-81" name="__codelineno-32-81" href="#__codelineno-32-81"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-32-82" name="__codelineno-32-82" href="#__codelineno-32-82"></a><span class="w">        </span><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_gray</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of HDVs</span>
<a id="__codelineno-32-83" name="__codelineno-32-83" href="#__codelineno-32-83"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-32-84" name="__codelineno-32-84" href="#__codelineno-32-84"></a><span class="k">end</span>
<a id="__codelineno-32-85" name="__codelineno-32-85" href="#__codelineno-32-85"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-32-86" name="__codelineno-32-86" href="#__codelineno-32-86"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-32-87" name="__codelineno-32-87" href="#__codelineno-32-87"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-32-88" name="__codelineno-32-88" href="#__codelineno-32-88"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-32-89" name="__codelineno-32-89" href="#__codelineno-32-89"></a><span class="w">            </span><span class="n">id_cav</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">id_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-32-90" name="__codelineno-32-90" href="#__codelineno-32-90"></a><span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-32-91" name="__codelineno-32-91" href="#__codelineno-32-91"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-32-92" name="__codelineno-32-92" href="#__codelineno-32-92"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-32-93" name="__codelineno-32-93" href="#__codelineno-32-93"></a><span class="w">    </span><span class="k">end</span><span class="w"> </span>
<a id="__codelineno-32-94" name="__codelineno-32-94" href="#__codelineno-32-94"></a><span class="k">end</span>
<a id="__codelineno-32-95" name="__codelineno-32-95" href="#__codelineno-32-95"></a><span class="nb">grid</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<a id="__codelineno-32-96" name="__codelineno-32-96" href="#__codelineno-32-96"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">total_size</span><span class="p">);</span>
<a id="__codelineno-32-97" name="__codelineno-32-97" href="#__codelineno-32-97"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;YLim&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="w"> </span><span class="mi">20</span><span class="p">]);</span>
<a id="__codelineno-32-98" name="__codelineno-32-98" href="#__codelineno-32-98"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;XLim&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="w"> </span><span class="mi">30</span><span class="p">]);</span>
<a id="__codelineno-32-99" name="__codelineno-32-99" href="#__codelineno-32-99"></a>
<a id="__codelineno-32-100" name="__codelineno-32-100" href="#__codelineno-32-100"></a><span class="n">xl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;$t$ [$\mathrm{s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-32-101" name="__codelineno-32-101" href="#__codelineno-32-101"></a><span class="n">yl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Velocity [$\mathrm{m/s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-32-102" name="__codelineno-32-102" href="#__codelineno-32-102"></a>
<a id="__codelineno-32-103" name="__codelineno-32-103" href="#__codelineno-32-103"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">250</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">400</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-32-104" name="__codelineno-32-104" href="#__codelineno-32-104"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-32-105" name="__codelineno-32-105" href="#__codelineno-32-105"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-32-106" name="__codelineno-32-106" href="#__codelineno-32-106"></a>
<a id="__codelineno-32-107" name="__codelineno-32-107" href="#__codelineno-32-107"></a><span class="c">% if mix</span>
<a id="__codelineno-32-108" name="__codelineno-32-108" href="#__codelineno-32-108"></a><span class="c">%     print(gcf,[&#39;.\figs\BrakePerturbation_VelocityProfile_Controller_&#39;,num2str(controller_type)],&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-32-109" name="__codelineno-32-109" href="#__codelineno-32-109"></a><span class="c">% else</span>
<a id="__codelineno-32-110" name="__codelineno-32-110" href="#__codelineno-32-110"></a><span class="c">%     print(gcf,&#39;.\figs\BrakePerturbation_VelocityProfile_AllHDVs&#39;,&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-32-111" name="__codelineno-32-111" href="#__codelineno-32-111"></a><span class="c">% end</span>
<a id="__codelineno-32-112" name="__codelineno-32-112" href="#__codelineno-32-112"></a>
<a id="__codelineno-32-113" name="__codelineno-32-113" href="#__codelineno-32-113"></a><span class="c">% Spacing</span>
<a id="__codelineno-32-114" name="__codelineno-32-114" href="#__codelineno-32-114"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-32-115" name="__codelineno-32-115" href="#__codelineno-32-115"></a><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-32-116" name="__codelineno-32-116" href="#__codelineno-32-116"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-32-117" name="__codelineno-32-117" href="#__codelineno-32-117"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-32-118" name="__codelineno-32-118" href="#__codelineno-32-118"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="mi">1</span>
<a id="__codelineno-32-119" name="__codelineno-32-119" href="#__codelineno-32-119"></a><span class="w">        </span><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-32-120" name="__codelineno-32-120" href="#__codelineno-32-120"></a><span class="w">        </span><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-32-121" name="__codelineno-32-121" href="#__codelineno-32-121"></a><span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-32-122" name="__codelineno-32-122" href="#__codelineno-32-122"></a><span class="w">        </span><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-32-123" name="__codelineno-32-123" href="#__codelineno-32-123"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-32-124" name="__codelineno-32-124" href="#__codelineno-32-124"></a><span class="w">   </span><span class="k">end</span><span class="w"> </span>
<a id="__codelineno-32-125" name="__codelineno-32-125" href="#__codelineno-32-125"></a><span class="k">end</span>
<a id="__codelineno-32-126" name="__codelineno-32-126" href="#__codelineno-32-126"></a><span class="c">% if mix</span>
<a id="__codelineno-32-127" name="__codelineno-32-127" href="#__codelineno-32-127"></a><span class="c">%     plot(begin_time:Tstep:end_time,5*ones(round((end_time-begin_time)/Tstep)+1),&#39;--k&#39;,&#39;linewidth&#39;,line_width);</span>
<a id="__codelineno-32-128" name="__codelineno-32-128" href="#__codelineno-32-128"></a><span class="c">%     text(11,6.2,&#39;$s_\mathrm{min}=5\,\mathrm{m}$&#39;,&#39;Interpreter&#39;,&#39;latex&#39;,&#39;FontSize&#39;,label_size);</span>
<a id="__codelineno-32-129" name="__codelineno-32-129" href="#__codelineno-32-129"></a><span class="c">% end</span>
<a id="__codelineno-32-130" name="__codelineno-32-130" href="#__codelineno-32-130"></a><span class="nb">grid</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<a id="__codelineno-32-131" name="__codelineno-32-131" href="#__codelineno-32-131"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">total_size</span><span class="p">);</span>
<a id="__codelineno-32-132" name="__codelineno-32-132" href="#__codelineno-32-132"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;YLim&#39;</span><span class="p">,[</span><span class="mi">5</span><span class="w"> </span><span class="mi">35</span><span class="p">]);</span>
<a id="__codelineno-32-133" name="__codelineno-32-133" href="#__codelineno-32-133"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;XLim&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="w"> </span><span class="mi">30</span><span class="p">]);</span>
<a id="__codelineno-32-134" name="__codelineno-32-134" href="#__codelineno-32-134"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;YTick&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">35</span><span class="p">);</span>
<a id="__codelineno-32-135" name="__codelineno-32-135" href="#__codelineno-32-135"></a>
<a id="__codelineno-32-136" name="__codelineno-32-136" href="#__codelineno-32-136"></a><span class="n">xl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;$t$ [$\mathrm{s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-32-137" name="__codelineno-32-137" href="#__codelineno-32-137"></a><span class="n">yl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Spacing [$\mathrm{m}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-32-138" name="__codelineno-32-138" href="#__codelineno-32-138"></a>
<a id="__codelineno-32-139" name="__codelineno-32-139" href="#__codelineno-32-139"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">550</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">400</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-32-140" name="__codelineno-32-140" href="#__codelineno-32-140"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-32-141" name="__codelineno-32-141" href="#__codelineno-32-141"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-32-142" name="__codelineno-32-142" href="#__codelineno-32-142"></a>
<a id="__codelineno-32-143" name="__codelineno-32-143" href="#__codelineno-32-143"></a><span class="c">% if mix</span>
<a id="__codelineno-32-144" name="__codelineno-32-144" href="#__codelineno-32-144"></a><span class="c">%     print(gcf,[&#39;.\figs\BrakePerturbation_SpacingProfile_Controller_&#39;,num2str(controller_type)],&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-32-145" name="__codelineno-32-145" href="#__codelineno-32-145"></a><span class="c">% else</span>
<a id="__codelineno-32-146" name="__codelineno-32-146" href="#__codelineno-32-146"></a><span class="c">%     print(gcf,&#39;.\figs\BrakePerturbation_SpacingProfile_AllHDVs&#39;,&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-32-147" name="__codelineno-32-147" href="#__codelineno-32-147"></a><span class="c">% end</span>
<a id="__codelineno-32-148" name="__codelineno-32-148" href="#__codelineno-32-148"></a>
<a id="__codelineno-32-149" name="__codelineno-32-149" href="#__codelineno-32-149"></a><span class="c">% Problem status</span>
<a id="__codelineno-32-150" name="__codelineno-32-150" href="#__codelineno-32-150"></a><span class="k">if</span><span class="w"> </span><span class="n">mix</span>
<a id="__codelineno-32-151" name="__codelineno-32-151" href="#__codelineno-32-151"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-32-152" name="__codelineno-32-152" href="#__codelineno-32-152"></a><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">pr_status</span><span class="p">);</span>
<a id="__codelineno-32-153" name="__codelineno-32-153" href="#__codelineno-32-153"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">850</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">400</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-32-154" name="__codelineno-32-154" href="#__codelineno-32-154"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-32-155" name="__codelineno-32-155" href="#__codelineno-32-155"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-32-156" name="__codelineno-32-156" href="#__codelineno-32-156"></a><span class="k">end</span>
<a id="__codelineno-32-157" name="__codelineno-32-157" href="#__codelineno-32-157"></a>
<a id="__codelineno-32-158" name="__codelineno-32-158" href="#__codelineno-32-158"></a><span class="c">% Acceleration</span>
<a id="__codelineno-32-159" name="__codelineno-32-159" href="#__codelineno-32-159"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-32-160" name="__codelineno-32-160" href="#__codelineno-32-160"></a><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-32-161" name="__codelineno-32-161" href="#__codelineno-32-161"></a><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_black</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-32-162" name="__codelineno-32-162" href="#__codelineno-32-162"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-32-163" name="__codelineno-32-163" href="#__codelineno-32-163"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-32-164" name="__codelineno-32-164" href="#__codelineno-32-164"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-32-165" name="__codelineno-32-165" href="#__codelineno-32-165"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-32-166" name="__codelineno-32-166" href="#__codelineno-32-166"></a><span class="w">            </span><span class="n">id_cav</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">id_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-32-167" name="__codelineno-32-167" href="#__codelineno-32-167"></a><span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-32-168" name="__codelineno-32-168" href="#__codelineno-32-168"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-32-169" name="__codelineno-32-169" href="#__codelineno-32-169"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-32-170" name="__codelineno-32-170" href="#__codelineno-32-170"></a><span class="w">    </span><span class="k">end</span><span class="w"> </span>
<a id="__codelineno-32-171" name="__codelineno-32-171" href="#__codelineno-32-171"></a><span class="k">end</span>
<a id="__codelineno-32-172" name="__codelineno-32-172" href="#__codelineno-32-172"></a><span class="nb">grid</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<a id="__codelineno-32-173" name="__codelineno-32-173" href="#__codelineno-32-173"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">total_size</span><span class="p">);</span>
<a id="__codelineno-32-174" name="__codelineno-32-174" href="#__codelineno-32-174"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;YLim&#39;</span><span class="p">,[</span><span class="o">-</span><span class="mi">6</span><span class="w"> </span><span class="mi">4</span><span class="p">]);</span>
<a id="__codelineno-32-175" name="__codelineno-32-175" href="#__codelineno-32-175"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;XLim&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="w"> </span><span class="mi">30</span><span class="p">]);</span>
<a id="__codelineno-32-176" name="__codelineno-32-176" href="#__codelineno-32-176"></a>
<a id="__codelineno-32-177" name="__codelineno-32-177" href="#__codelineno-32-177"></a><span class="n">xl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;$t$ [$\mathrm{s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-32-178" name="__codelineno-32-178" href="#__codelineno-32-178"></a><span class="n">yl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Acceleration [$\mathrm{m/s^2}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-32-179" name="__codelineno-32-179" href="#__codelineno-32-179"></a>
<a id="__codelineno-32-180" name="__codelineno-32-180" href="#__codelineno-32-180"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">250</span><span class="w"> </span><span class="mi">450</span><span class="w"> </span><span class="mi">400</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-32-181" name="__codelineno-32-181" href="#__codelineno-32-181"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-32-182" name="__codelineno-32-182" href="#__codelineno-32-182"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-32-183" name="__codelineno-32-183" href="#__codelineno-32-183"></a><span class="c">% if mix</span>
<a id="__codelineno-32-184" name="__codelineno-32-184" href="#__codelineno-32-184"></a><span class="c">%     print(gcf,[&#39;.\figs\BrakePerturbation_AccelerationProfile_Controller_&#39;,num2str(controller_type)],&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-32-185" name="__codelineno-32-185" href="#__codelineno-32-185"></a><span class="c">% else</span>
<a id="__codelineno-32-186" name="__codelineno-32-186" href="#__codelineno-32-186"></a><span class="c">%     print(gcf,&#39;.\figs\BrakePerturbation_AccelerationProfile_AllHDVs&#39;,&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-32-187" name="__codelineno-32-187" href="#__codelineno-32-187"></a><span class="c">% end</span>
<a id="__codelineno-32-188" name="__codelineno-32-188" href="#__codelineno-32-188"></a>
<a id="__codelineno-32-189" name="__codelineno-32-189" href="#__codelineno-32-189"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-32-190" name="__codelineno-32-190" href="#__codelineno-32-190"></a><span class="c">%   Calculate Performance Indexes</span>
<a id="__codelineno-32-191" name="__codelineno-32-191" href="#__codelineno-32-191"></a><span class="c">%--------------------------------------------------------------------------</span>
<a id="__codelineno-32-192" name="__codelineno-32-192" href="#__codelineno-32-192"></a>
<a id="__codelineno-32-193" name="__codelineno-32-193" href="#__codelineno-32-193"></a><span class="n">smooth_window</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-32-194" name="__codelineno-32-194" href="#__codelineno-32-194"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-32-195" name="__codelineno-32-195" href="#__codelineno-32-195"></a><span class="w">   </span><span class="n">S</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">smooth</span><span class="p">(</span><span class="n">S</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">smooth_window</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-32-196" name="__codelineno-32-196" href="#__codelineno-32-196"></a><span class="k">end</span>
<a id="__codelineno-32-197" name="__codelineno-32-197" href="#__codelineno-32-197"></a>
<a id="__codelineno-32-198" name="__codelineno-32-198" href="#__codelineno-32-198"></a><span class="n">FuelConsumption</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-32-199" name="__codelineno-32-199" href="#__codelineno-32-199"></a><span class="n">VelocityError</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-32-200" name="__codelineno-32-200" href="#__codelineno-32-200"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="p">=</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">end_time</span><span class="o">/</span><span class="n">Tstep</span>
<a id="__codelineno-32-201" name="__codelineno-32-201" href="#__codelineno-32-201"></a><span class="w">    </span><span class="n">R</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.333</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.00108</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.2</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-32-202" name="__codelineno-32-202" href="#__codelineno-32-202"></a><span class="w">    </span><span class="n">Fuel</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.09</span><span class="o">*</span><span class="n">R</span><span class="o">.*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.054</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span><span class="o">.*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-32-203" name="__codelineno-32-203" href="#__codelineno-32-203"></a><span class="w">    </span><span class="n">Fuel</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="p">;</span>
<a id="__codelineno-32-204" name="__codelineno-32-204" href="#__codelineno-32-204"></a><span class="w">    </span><span class="n">FuelConsumption</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">FuelConsumption</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">Fuel</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="p">;</span>
<a id="__codelineno-32-205" name="__codelineno-32-205" href="#__codelineno-32-205"></a>
<a id="__codelineno-32-206" name="__codelineno-32-206" href="#__codelineno-32-206"></a><span class="w">    </span><span class="n">VelocityError</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-32-207" name="__codelineno-32-207" href="#__codelineno-32-207"></a>
<a id="__codelineno-32-208" name="__codelineno-32-208" href="#__codelineno-32-208"></a><span class="k">end</span>
<a id="__codelineno-32-209" name="__codelineno-32-209" href="#__codelineno-32-209"></a>
<a id="__codelineno-32-210" name="__codelineno-32-210" href="#__codelineno-32-210"></a><span class="n">VelocityError</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="o">/</span><span class="n">n_vehicle</span><span class="o">/</span><span class="p">((</span><span class="n">end_time</span><span class="o">-</span><span class="n">begin_time</span><span class="p">)</span><span class="o">/</span><span class="n">Tstep</span><span class="p">);</span>
<a id="__codelineno-32-211" name="__codelineno-32-211" href="#__codelineno-32-211"></a>
<a id="__codelineno-32-212" name="__codelineno-32-212" href="#__codelineno-32-212"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Fuel comsumption:   %4.2f \n&#39;</span><span class="p">,</span><span class="n">FuelConsumption</span><span class="p">);</span>
<a id="__codelineno-32-213" name="__codelineno-32-213" href="#__codelineno-32-213"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Velocity error:   %4.2f \n&#39;</span><span class="p">,</span><span class="n">VelocityError</span><span class="p">);</span>
</code></pre></div>
</details>

<h5 id="figure_nedc_statisticsm"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/plot_figure/Figure_NEDC_Statistics.m">Figure_NEDC_Statistics.m</a><a class="headerlink" href="#figure_nedc_statisticsm" title="Permanent link">&para;</a></h5>
<p>This function is used for analysis for simulation results under same data sample.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c">% Data set</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="n">data_str</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p">;</span><span class="w">  </span><span class="c">% 1. random ovm  2. manual ovm  3. homogeneous ovm</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="c">% Type for HDV car-following model</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="n">hdv_type</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. OVM   2. IDM</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="c">% Uncertainty for HDV behavior</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="n">acel_noise</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% A white noise signal on HDV&#39;s original acceleration</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="c">% Head vehicle trajectory</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="n">trajectory_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="p">;</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="n">head_vehicle_trajectory</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;./_data/nedc_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="n">end_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">time</span><span class="p">(</span><span class="k">end</span><span class="p">);</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="n">initialization_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w">               </span><span class="c">% Time for the original HDV-all system to stabilize</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="n">adaption_time</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">               </span><span class="c">% Time for the CAVs to adjust to their desired state</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="c">% Total simulation results</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="c">% total_time          = initialization_time + adaption_time + end_time;  % Total Simulation Time</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="c">% begin_time          = initialization_time + adaption_time;</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="c">% Seperate different phases in the simulation</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="c">% time_point = [60,88,121,176,206];  % For Trajectory V1</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="n">time_point</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">196</span><span class="p">];</span><span class="w">   </span><span class="c">% For Trajectory V2</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="n">time_i</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="n">begin_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="p">);</span>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="n">total_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="n">weight_v</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c">% weight coefficient for velocity error</span>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="n">weight_s</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for spacing error   </span>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="n">weight_u</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for control input</span>
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>
<a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="n">lambda_g</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||g||_2^2 in objective</span>
<a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="n">lambda_y</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">1e4</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||sigma_y||_2^2 in objective</span>
<a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>
<a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="n">i_data</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a>
<a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a>
<a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\simulation_data\MPC\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a><span class="w">        </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="n">S_MPC</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">;</span><span class="w">       </span>
<a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\simulation_data\DeePC\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">        </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;_lambdaG_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_g</span><span class="p">),</span><span class="s">&#39;_lambdaY_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_y</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="n">S_DeePC</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="nb">load</span><span class="p">([</span><span class="s">&#39;_data\simulation_data\HDV\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a><span class="w">        </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="n">S_HDV</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="n">S</span><span class="p">;</span><span class="w">  </span>
<a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a>
<a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a>
<a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a><span class="n">n_vehicle</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a><span class="c">% Smooth acceleration signal</span>
<a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a><span class="n">smooth_window</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="n">n_vehicle</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a><span class="w">   </span><span class="n">S_DeePC</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">smooth</span><span class="p">(</span><span class="n">S_DeePC</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">smooth_window</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a><span class="w">   </span><span class="n">S_MPC</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">smooth</span><span class="p">(</span><span class="n">S_MPC</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">smooth_window</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a><span class="w">   </span><span class="n">S_HDV</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">smooth</span><span class="p">(</span><span class="n">S_HDV</span><span class="p">(:,</span><span class="nb">i</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">smooth_window</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a><span class="k">end</span>
<a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a>
<a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a><span class="n">FuelConsumption</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-33-59" name="__codelineno-33-59" href="#__codelineno-33-59"></a><span class="n">VelocityError</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-33-60" name="__codelineno-33-60" href="#__codelineno-33-60"></a>
<a id="__codelineno-33-61" name="__codelineno-33-61" href="#__codelineno-33-61"></a>
<a id="__codelineno-33-62" name="__codelineno-33-62" href="#__codelineno-33-62"></a>
<a id="__codelineno-33-63" name="__codelineno-33-63" href="#__codelineno-33-63"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="p">=</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span>
<a id="__codelineno-33-64" name="__codelineno-33-64" href="#__codelineno-33-64"></a><span class="w">    </span><span class="n">R_DeePC</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.333</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.00108</span><span class="o">*</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.2</span><span class="o">*</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-33-65" name="__codelineno-33-65" href="#__codelineno-33-65"></a><span class="w">    </span><span class="n">F_DeePC</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.09</span><span class="o">*</span><span class="n">R_DeePC</span><span class="o">.*</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.054</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span><span class="o">.*</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-33-66" name="__codelineno-33-66" href="#__codelineno-33-66"></a><span class="w">    </span><span class="n">F_DeePC</span><span class="p">(</span><span class="n">R_DeePC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="p">;</span>
<a id="__codelineno-33-67" name="__codelineno-33-67" href="#__codelineno-33-67"></a><span class="w">    </span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">F_DeePC</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="p">;</span>
<a id="__codelineno-33-68" name="__codelineno-33-68" href="#__codelineno-33-68"></a>
<a id="__codelineno-33-69" name="__codelineno-33-69" href="#__codelineno-33-69"></a><span class="w">    </span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">S_DeePC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-33-70" name="__codelineno-33-70" href="#__codelineno-33-70"></a>
<a id="__codelineno-33-71" name="__codelineno-33-71" href="#__codelineno-33-71"></a><span class="w">    </span><span class="n">R_MPC</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.333</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.00108</span><span class="o">*</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.2</span><span class="o">*</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-33-72" name="__codelineno-33-72" href="#__codelineno-33-72"></a><span class="w">    </span><span class="n">F_MPC</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.09</span><span class="o">*</span><span class="n">R_MPC</span><span class="o">.*</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.054</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span><span class="o">.*</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-33-73" name="__codelineno-33-73" href="#__codelineno-33-73"></a><span class="w">    </span><span class="n">F_MPC</span><span class="p">(</span><span class="n">R_MPC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="p">;</span>
<a id="__codelineno-33-74" name="__codelineno-33-74" href="#__codelineno-33-74"></a><span class="w">    </span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">F_MPC</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="p">;</span>
<a id="__codelineno-33-75" name="__codelineno-33-75" href="#__codelineno-33-75"></a>
<a id="__codelineno-33-76" name="__codelineno-33-76" href="#__codelineno-33-76"></a><span class="w">    </span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">S_MPC</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-33-77" name="__codelineno-33-77" href="#__codelineno-33-77"></a>
<a id="__codelineno-33-78" name="__codelineno-33-78" href="#__codelineno-33-78"></a><span class="w">    </span><span class="n">R_HDV</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.333</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.00108</span><span class="o">*</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.2</span><span class="o">*</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-33-79" name="__codelineno-33-79" href="#__codelineno-33-79"></a><span class="w">    </span><span class="n">F_HDV</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.09</span><span class="o">*</span><span class="n">R_HDV</span><span class="o">.*</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.054</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span><span class="o">.*</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-33-80" name="__codelineno-33-80" href="#__codelineno-33-80"></a><span class="w">    </span><span class="n">F_HDV</span><span class="p">(</span><span class="n">R_HDV</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="p">;</span>
<a id="__codelineno-33-81" name="__codelineno-33-81" href="#__codelineno-33-81"></a><span class="w">    </span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">F_HDV</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="p">;</span><span class="w">    </span>
<a id="__codelineno-33-82" name="__codelineno-33-82" href="#__codelineno-33-82"></a>
<a id="__codelineno-33-83" name="__codelineno-33-83" href="#__codelineno-33-83"></a><span class="w">    </span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">S_HDV</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-33-84" name="__codelineno-33-84" href="#__codelineno-33-84"></a><span class="k">end</span>
<a id="__codelineno-33-85" name="__codelineno-33-85" href="#__codelineno-33-85"></a>
<a id="__codelineno-33-86" name="__codelineno-33-86" href="#__codelineno-33-86"></a><span class="n">VelocityError</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="o">/</span><span class="n">n_vehicle</span><span class="o">/</span><span class="p">((</span><span class="n">total_time</span><span class="o">-</span><span class="n">begin_time</span><span class="p">)</span><span class="o">/</span><span class="n">Tstep</span><span class="p">);</span>
<a id="__codelineno-33-87" name="__codelineno-33-87" href="#__codelineno-33-87"></a>
<a id="__codelineno-33-88" name="__codelineno-33-88" href="#__codelineno-33-88"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Fuel Consumption:   DeePC  |    MPC    |   HDVs  \n&#39;</span><span class="p">);</span>
<a id="__codelineno-33-89" name="__codelineno-33-89" href="#__codelineno-33-89"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;                  %4.2f  |  %4.2f  |   %4.2f \n&#39;</span><span class="p">,</span><span class="n">FuelConsumption</span><span class="p">);</span>
<a id="__codelineno-33-90" name="__codelineno-33-90" href="#__codelineno-33-90"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;                  %4.2f%%  |  %4.2f%%  |   %4.2f%% \n&#39;</span><span class="p">,(</span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">FuelConsumption</span><span class="p">)</span><span class="o">/</span><span class="n">FuelConsumption</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-33-91" name="__codelineno-33-91" href="#__codelineno-33-91"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Velocity Error:   DeePC  |    MPC    |   HDVs  \n&#39;</span><span class="p">);</span>
<a id="__codelineno-33-92" name="__codelineno-33-92" href="#__codelineno-33-92"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;                  %4.4f  |  %4.4f  |   %4.4f \n&#39;</span><span class="p">,</span><span class="n">VelocityError</span><span class="p">);</span>
<a id="__codelineno-33-93" name="__codelineno-33-93" href="#__codelineno-33-93"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;                  %4.2f%%  |  %4.2f%%  |   %4.2f%% \n&#39;</span><span class="p">,(</span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">VelocityError</span><span class="p">)</span><span class="o">/</span><span class="n">VelocityError</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
</code></pre></div>
</details>

<h5 id="figure_nedc_trajectorym"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/plot_figure/Figure_NEDC_Trajectory.m">Figure_NEDC_Trajectory.m</a><a class="headerlink" href="#figure_nedc_trajectorym" title="Permanent link">&para;</a></h5>
<p>This function is used for analysis for simulation results under same data sample.</p>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c">% Data set</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">data_str</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p">;</span><span class="w">  </span><span class="c">% 1. random ovm  2. manual ovm  3. homogeneous ovm</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="c">% Mix or not</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="n">mix</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 0. all HDVs; 1. mix</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="c">% Type of the controller</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="n">controller_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. DeeP-LCC  2. MPC  </span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="c">% Type for HDV car-following model</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="n">hdv_type</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c">% 1. OVM   2. IDM</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="c">% Uncertainty for HDV behavior</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="n">acel_noise</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c">% A white noise signal on HDV&#39;s original acceleration</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="c">% Head vehicle trajectory</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="n">trajectory_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="p">;</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="n">head_vehicle_trajectory</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;../_data/nedc_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="n">end_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">head_vehicle_trajectory</span><span class="p">.</span><span class="n">time</span><span class="p">(</span><span class="k">end</span><span class="p">);</span>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="n">initialization_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w">               </span><span class="c">% Time for the original HDV-all system to stabilize</span>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="n">adaption_time</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">               </span><span class="c">% Time for the CAVs to adjust to their desired state</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="n">total_time</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">end_time</span><span class="p">;</span><span class="w">  </span><span class="c">% Total Simulation Time</span>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="n">begin_time</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">;</span>
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>
<a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a><span class="n">weight_v</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c">% weight coefficient for velocity error</span>
<a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a><span class="n">weight_s</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for spacing error</span>
<a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="n">weight_u</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">      </span><span class="c">% weight coefficient for control input</span>
<a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>
<a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a><span class="n">lambda_g</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||g||_2^2 in objective</span>
<a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a><span class="n">lambda_y</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mf">1e4</span><span class="p">;</span><span class="w">      </span><span class="c">% penalty on ||sigma_y||_2^2 in objective</span>
<a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a>
<a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a><span class="n">i_data</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a>
<a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a><span class="k">if</span><span class="w"> </span><span class="n">mix</span>
<a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="n">controller_type</span>
<a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a><span class="w">            </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\DeeP_LCC\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">i_data</span><span class="p">),</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a><span class="w">                </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;_lambdaG_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_g</span><span class="p">),</span><span class="s">&#39;_lambdaY_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">lambda_y</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a><span class="w">            </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;DeePC&#39;</span><span class="p">;</span>
<a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a><span class="w">            </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\MPC\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a><span class="w">                </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-34-40" name="__codelineno-34-40" href="#__codelineno-34-40"></a><span class="w">            </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;MPC&#39;</span><span class="p">;</span>
<a id="__codelineno-34-41" name="__codelineno-34-41" href="#__codelineno-34-41"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-34-42" name="__codelineno-34-42" href="#__codelineno-34-42"></a><span class="k">else</span><span class="w"> </span><span class="c">% ngsim simulation</span>
<a id="__codelineno-34-43" name="__codelineno-34-43" href="#__codelineno-34-43"></a><span class="w">    </span><span class="nb">load</span><span class="p">([</span><span class="s">&#39;..\_data\simulation_data\HDV\nedc_simulation\simulation_data&#39;</span><span class="p">,</span><span class="n">data_str</span><span class="p">,</span><span class="s">&#39;_modified_v&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">trajectory_id</span><span class="p">),</span><span class="s">&#39;_noiseLevel_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">acel_noise</span><span class="p">),</span><span class="k">...</span>
<a id="__codelineno-34-44" name="__codelineno-34-44" href="#__codelineno-34-44"></a><span class="w">        </span><span class="s">&#39;_hdvType_&#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">hdv_type</span><span class="p">),</span><span class="s">&#39;.mat&#39;</span><span class="p">]);</span>
<a id="__codelineno-34-45" name="__codelineno-34-45" href="#__codelineno-34-45"></a><span class="w">    </span><span class="n">controller_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;HDV&#39;</span><span class="p">;</span>
<a id="__codelineno-34-46" name="__codelineno-34-46" href="#__codelineno-34-46"></a>
<a id="__codelineno-34-47" name="__codelineno-34-47" href="#__codelineno-34-47"></a><span class="k">end</span>
<a id="__codelineno-34-48" name="__codelineno-34-48" href="#__codelineno-34-48"></a>
<a id="__codelineno-34-49" name="__codelineno-34-49" href="#__codelineno-34-49"></a>
<a id="__codelineno-34-50" name="__codelineno-34-50" href="#__codelineno-34-50"></a><span class="n">n_vehicle</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span><span class="w">           </span><span class="c">% number of vehicles</span>
<a id="__codelineno-34-51" name="__codelineno-34-51" href="#__codelineno-34-51"></a>
<a id="__codelineno-34-52" name="__codelineno-34-52" href="#__codelineno-34-52"></a>
<a id="__codelineno-34-53" name="__codelineno-34-53" href="#__codelineno-34-53"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-34-54" name="__codelineno-34-54" href="#__codelineno-34-54"></a><span class="c">%   Plot Results</span>
<a id="__codelineno-34-55" name="__codelineno-34-55" href="#__codelineno-34-55"></a><span class="c">%--------------------------------------------------------------------------</span>
<a id="__codelineno-34-56" name="__codelineno-34-56" href="#__codelineno-34-56"></a><span class="n">color_gray</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">170</span><span class="w"> </span><span class="mi">170</span><span class="w"> </span><span class="mi">170</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-34-57" name="__codelineno-34-57" href="#__codelineno-34-57"></a><span class="n">color_red</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">124</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-34-58" name="__codelineno-34-58" href="#__codelineno-34-58"></a><span class="n">color_blue</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">121</span><span class="p">,</span><span class="w"> </span><span class="mi">227</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-34-59" name="__codelineno-34-59" href="#__codelineno-34-59"></a><span class="n">color_black</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-34-60" name="__codelineno-34-60" href="#__codelineno-34-60"></a><span class="n">color_orange</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">31</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-34-61" name="__codelineno-34-61" href="#__codelineno-34-61"></a><span class="n">color_blue_2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-34-62" name="__codelineno-34-62" href="#__codelineno-34-62"></a><span class="n">color_red_2</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">238</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<a id="__codelineno-34-63" name="__codelineno-34-63" href="#__codelineno-34-63"></a><span class="n">label_size</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
<a id="__codelineno-34-64" name="__codelineno-34-64" href="#__codelineno-34-64"></a><span class="n">total_size</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span>
<a id="__codelineno-34-65" name="__codelineno-34-65" href="#__codelineno-34-65"></a><span class="n">line_width</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<a id="__codelineno-34-66" name="__codelineno-34-66" href="#__codelineno-34-66"></a>
<a id="__codelineno-34-67" name="__codelineno-34-67" href="#__codelineno-34-67"></a><span class="c">% Head vehicle trajectory</span>
<a id="__codelineno-34-68" name="__codelineno-34-68" href="#__codelineno-34-68"></a><span class="n">time_point</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">176</span><span class="p">,</span><span class="mi">206</span><span class="p">];</span><span class="w">  </span><span class="c">% For Trajectory V1</span>
<a id="__codelineno-34-69" name="__codelineno-34-69" href="#__codelineno-34-69"></a><span class="c">% time_point = [60,88,121,166,196];   % For Trajectory V2</span>
<a id="__codelineno-34-70" name="__codelineno-34-70" href="#__codelineno-34-70"></a><span class="n">time_scale</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">begin_time</span><span class="p">:</span><span class="n">Tstep</span><span class="p">:</span><span class="n">total_time</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">);</span>
<a id="__codelineno-34-71" name="__codelineno-34-71" href="#__codelineno-34-71"></a>
<a id="__codelineno-34-72" name="__codelineno-34-72" href="#__codelineno-34-72"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-34-73" name="__codelineno-34-73" href="#__codelineno-34-73"></a><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_black</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-34-74" name="__codelineno-34-74" href="#__codelineno-34-74"></a><span class="n">grid</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-34-75" name="__codelineno-34-75" href="#__codelineno-34-75"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">total_size</span><span class="p">);</span>
<a id="__codelineno-34-76" name="__codelineno-34-76" href="#__codelineno-34-76"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;XLim&#39;</span><span class="p">,[</span><span class="n">begin_time</span><span class="w"> </span><span class="n">total_time</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">));</span>
<a id="__codelineno-34-77" name="__codelineno-34-77" href="#__codelineno-34-77"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;YLim&#39;</span><span class="p">,[</span><span class="mi">10</span><span class="p">,</span><span class="mi">30</span><span class="p">]);</span>
<a id="__codelineno-34-78" name="__codelineno-34-78" href="#__codelineno-34-78"></a>
<a id="__codelineno-34-79" name="__codelineno-34-79" href="#__codelineno-34-79"></a>
<a id="__codelineno-34-80" name="__codelineno-34-80" href="#__codelineno-34-80"></a><span class="k">for</span><span class="w"> </span><span class="n">time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span>
<a id="__codelineno-34-81" name="__codelineno-34-81" href="#__codelineno-34-81"></a><span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">),</span><span class="nb">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="p">)</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">20</span><span class="p">),</span><span class="s">&#39;--&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-34-82" name="__codelineno-34-82" href="#__codelineno-34-82"></a><span class="w">    </span><span class="n">text_phase</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">text</span><span class="p">((</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="p">)</span><span class="o">+</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">),</span><span class="mf">11.5</span><span class="p">,[</span><span class="s">&#39;phase &#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">time_i</span><span class="p">)],</span><span class="k">...</span>
<a id="__codelineno-34-83" name="__codelineno-34-83" href="#__codelineno-34-83"></a><span class="w">        </span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;FontSize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;HorizontalAlignment&#39;</span><span class="p">,</span><span class="s">&#39;center&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red</span><span class="p">);</span>
<a id="__codelineno-34-84" name="__codelineno-34-84" href="#__codelineno-34-84"></a><span class="k">end</span>
<a id="__codelineno-34-85" name="__codelineno-34-85" href="#__codelineno-34-85"></a>
<a id="__codelineno-34-86" name="__codelineno-34-86" href="#__codelineno-34-86"></a>
<a id="__codelineno-34-87" name="__codelineno-34-87" href="#__codelineno-34-87"></a>
<a id="__codelineno-34-88" name="__codelineno-34-88" href="#__codelineno-34-88"></a>
<a id="__codelineno-34-89" name="__codelineno-34-89" href="#__codelineno-34-89"></a><span class="n">xl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;$t$ [$\mathrm{s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-90" name="__codelineno-34-90" href="#__codelineno-34-90"></a><span class="n">yl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Velocity [$\mathrm{m/s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-91" name="__codelineno-34-91" href="#__codelineno-34-91"></a>
<a id="__codelineno-34-92" name="__codelineno-34-92" href="#__codelineno-34-92"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">250</span><span class="w"> </span><span class="mi">550</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-34-93" name="__codelineno-34-93" href="#__codelineno-34-93"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-34-94" name="__codelineno-34-94" href="#__codelineno-34-94"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-34-95" name="__codelineno-34-95" href="#__codelineno-34-95"></a>
<a id="__codelineno-34-96" name="__codelineno-34-96" href="#__codelineno-34-96"></a><span class="c">% print(gcf,&#39;.\figs\NEDC_HeadVehicleTrajectory&#39;,&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-34-97" name="__codelineno-34-97" href="#__codelineno-34-97"></a>
<a id="__codelineno-34-98" name="__codelineno-34-98" href="#__codelineno-34-98"></a>
<a id="__codelineno-34-99" name="__codelineno-34-99" href="#__codelineno-34-99"></a><span class="c">% Velocity</span>
<a id="__codelineno-34-100" name="__codelineno-34-100" href="#__codelineno-34-100"></a><span class="c">% for time_i = 1:4</span>
<a id="__codelineno-34-101" name="__codelineno-34-101" href="#__codelineno-34-101"></a><span class="c">%     begin_time = time_point(time_i);</span>
<a id="__codelineno-34-102" name="__codelineno-34-102" href="#__codelineno-34-102"></a><span class="c">%     total_time = time_point(time_i+1);</span>
<a id="__codelineno-34-103" name="__codelineno-34-103" href="#__codelineno-34-103"></a><span class="c">%     figure;</span>
<a id="__codelineno-34-104" name="__codelineno-34-104" href="#__codelineno-34-104"></a><span class="c">%     plot(begin_time:Tstep:total_time,S(begin_time/Tstep:round(total_time/Tstep),1,2),&#39;Color&#39;,color_gray,&#39;linewidth&#39;,line_width); hold on;</span>
<a id="__codelineno-34-105" name="__codelineno-34-105" href="#__codelineno-34-105"></a><span class="c">%     for i = 1:n_vehicle</span>
<a id="__codelineno-34-106" name="__codelineno-34-106" href="#__codelineno-34-106"></a><span class="c">%         if ID(i) == 1</span>
<a id="__codelineno-34-107" name="__codelineno-34-107" href="#__codelineno-34-107"></a><span class="c">%             plot(begin_time:Tstep:total_time,S(begin_time/Tstep:round(total_time/Tstep),i+1,2),&#39;Color&#39;,color_red,&#39;linewidth&#39;,line_width); hold on; % line for velocity of CAVs</span>
<a id="__codelineno-34-108" name="__codelineno-34-108" href="#__codelineno-34-108"></a><span class="c">%         else</span>
<a id="__codelineno-34-109" name="__codelineno-34-109" href="#__codelineno-34-109"></a><span class="c">%             plot(begin_time:Tstep:total_time,S(begin_time/Tstep:round(total_time/Tstep),i+1,2),&#39;Color&#39;,color_blue,&#39;linewidth&#39;,line_width); hold on; % line for velocity of HDVs</span>
<a id="__codelineno-34-110" name="__codelineno-34-110" href="#__codelineno-34-110"></a><span class="c">%         end</span>
<a id="__codelineno-34-111" name="__codelineno-34-111" href="#__codelineno-34-111"></a><span class="c">%     end</span>
<a id="__codelineno-34-112" name="__codelineno-34-112" href="#__codelineno-34-112"></a><span class="c">%     grid on;</span>
<a id="__codelineno-34-113" name="__codelineno-34-113" href="#__codelineno-34-113"></a><span class="c">%     set(gca,&#39;TickLabelInterpreter&#39;,&#39;latex&#39;,&#39;fontsize&#39;,total_size);</span>
<a id="__codelineno-34-114" name="__codelineno-34-114" href="#__codelineno-34-114"></a><span class="c">%     set(gca,&#39;XLim&#39;,[begin_time total_time]);</span>
<a id="__codelineno-34-115" name="__codelineno-34-115" href="#__codelineno-34-115"></a><span class="c">%     </span>
<a id="__codelineno-34-116" name="__codelineno-34-116" href="#__codelineno-34-116"></a><span class="c">%     xl = xlabel(&#39;$t$ [$\mathrm{s}$]&#39;,&#39;fontsize&#39;,label_size,&#39;Interpreter&#39;,&#39;latex&#39;,&#39;Color&#39;,&#39;k&#39;);</span>
<a id="__codelineno-34-117" name="__codelineno-34-117" href="#__codelineno-34-117"></a><span class="c">%     yl = ylabel(&#39;Velocity [$\mathrm{m/s}$]&#39;,&#39;fontsize&#39;,label_size,&#39;Interpreter&#39;,&#39;latex&#39;,&#39;Color&#39;,&#39;k&#39;);</span>
<a id="__codelineno-34-118" name="__codelineno-34-118" href="#__codelineno-34-118"></a><span class="c">%     </span>
<a id="__codelineno-34-119" name="__codelineno-34-119" href="#__codelineno-34-119"></a><span class="c">%     set(gcf,&#39;Position&#39;,[250 150 400 300]);</span>
<a id="__codelineno-34-120" name="__codelineno-34-120" href="#__codelineno-34-120"></a><span class="c">%     fig = gcf;</span>
<a id="__codelineno-34-121" name="__codelineno-34-121" href="#__codelineno-34-121"></a><span class="c">%     fig.PaperPositionMode = &#39;auto&#39;;</span>
<a id="__codelineno-34-122" name="__codelineno-34-122" href="#__codelineno-34-122"></a><span class="c">%     </span>
<a id="__codelineno-34-123" name="__codelineno-34-123" href="#__codelineno-34-123"></a><span class="c">% end</span>
<a id="__codelineno-34-124" name="__codelineno-34-124" href="#__codelineno-34-124"></a>
<a id="__codelineno-34-125" name="__codelineno-34-125" href="#__codelineno-34-125"></a><span class="n">total_time</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">end_time</span><span class="p">;</span><span class="w">  </span><span class="c">% Total Simulation Time</span>
<a id="__codelineno-34-126" name="__codelineno-34-126" href="#__codelineno-34-126"></a><span class="n">begin_time</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">;</span>
<a id="__codelineno-34-127" name="__codelineno-34-127" href="#__codelineno-34-127"></a>
<a id="__codelineno-34-128" name="__codelineno-34-128" href="#__codelineno-34-128"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-34-129" name="__codelineno-34-129" href="#__codelineno-34-129"></a><span class="c">% h = axes(&#39;position&#39;,[0 0 1 1]);</span>
<a id="__codelineno-34-130" name="__codelineno-34-130" href="#__codelineno-34-130"></a><span class="c">% axis(h);</span>
<a id="__codelineno-34-131" name="__codelineno-34-131" href="#__codelineno-34-131"></a><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_black</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-34-132" name="__codelineno-34-132" href="#__codelineno-34-132"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-34-133" name="__codelineno-34-133" href="#__codelineno-34-133"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-34-134" name="__codelineno-34-134" href="#__codelineno-34-134"></a><span class="w">        </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_gray</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of HDVs</span>
<a id="__codelineno-34-135" name="__codelineno-34-135" href="#__codelineno-34-135"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-34-136" name="__codelineno-34-136" href="#__codelineno-34-136"></a><span class="k">end</span>
<a id="__codelineno-34-137" name="__codelineno-34-137" href="#__codelineno-34-137"></a><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-34-138" name="__codelineno-34-138" href="#__codelineno-34-138"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-34-139" name="__codelineno-34-139" href="#__codelineno-34-139"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-34-140" name="__codelineno-34-140" href="#__codelineno-34-140"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-34-141" name="__codelineno-34-141" href="#__codelineno-34-141"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-34-142" name="__codelineno-34-142" href="#__codelineno-34-142"></a><span class="w">            </span><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-34-143" name="__codelineno-34-143" href="#__codelineno-34-143"></a><span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-34-144" name="__codelineno-34-144" href="#__codelineno-34-144"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-34-145" name="__codelineno-34-145" href="#__codelineno-34-145"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-34-146" name="__codelineno-34-146" href="#__codelineno-34-146"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-34-147" name="__codelineno-34-147" href="#__codelineno-34-147"></a><span class="k">end</span>
<a id="__codelineno-34-148" name="__codelineno-34-148" href="#__codelineno-34-148"></a>
<a id="__codelineno-34-149" name="__codelineno-34-149" href="#__codelineno-34-149"></a><span class="k">for</span><span class="w"> </span><span class="n">time_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span>
<a id="__codelineno-34-150" name="__codelineno-34-150" href="#__codelineno-34-150"></a><span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">),</span><span class="nb">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="p">)</span><span class="o">/</span><span class="n">Tstep</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">20</span><span class="p">),</span><span class="s">&#39;--&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue_2</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-34-151" name="__codelineno-34-151" href="#__codelineno-34-151"></a><span class="w">    </span><span class="n">text_phase</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">text</span><span class="p">((</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="p">)</span><span class="o">+</span><span class="n">time_point</span><span class="p">(</span><span class="n">time_i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">initialization_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adaption_time</span><span class="p">),</span><span class="mf">12.5</span><span class="p">,[</span><span class="s">&#39;Phase &#39;</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">time_i</span><span class="p">)],</span><span class="k">...</span>
<a id="__codelineno-34-152" name="__codelineno-34-152" href="#__codelineno-34-152"></a><span class="w">        </span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;FontSize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;HorizontalAlignment&#39;</span><span class="p">,</span><span class="s">&#39;center&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red_2</span><span class="p">);</span>
<a id="__codelineno-34-153" name="__codelineno-34-153" href="#__codelineno-34-153"></a><span class="k">end</span>
<a id="__codelineno-34-154" name="__codelineno-34-154" href="#__codelineno-34-154"></a>
<a id="__codelineno-34-155" name="__codelineno-34-155" href="#__codelineno-34-155"></a><span class="nb">grid</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<a id="__codelineno-34-156" name="__codelineno-34-156" href="#__codelineno-34-156"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">total_size</span><span class="p">);</span>
<a id="__codelineno-34-157" name="__codelineno-34-157" href="#__codelineno-34-157"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;XLim&#39;</span><span class="p">,[</span><span class="n">time_scale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">time_scale</span><span class="p">(</span><span class="k">end</span><span class="p">)]);</span>
<a id="__codelineno-34-158" name="__codelineno-34-158" href="#__codelineno-34-158"></a>
<a id="__codelineno-34-159" name="__codelineno-34-159" href="#__codelineno-34-159"></a><span class="n">xl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;$t$ [$\mathrm{s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-160" name="__codelineno-34-160" href="#__codelineno-34-160"></a><span class="n">yl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Velocity [$\mathrm{m/s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-161" name="__codelineno-34-161" href="#__codelineno-34-161"></a>
<a id="__codelineno-34-162" name="__codelineno-34-162" href="#__codelineno-34-162"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;YLim&#39;</span><span class="p">,[</span><span class="mf">11.5</span><span class="p">,</span><span class="mf">28.5</span><span class="p">]);</span>
<a id="__codelineno-34-163" name="__codelineno-34-163" href="#__codelineno-34-163"></a>
<a id="__codelineno-34-164" name="__codelineno-34-164" href="#__codelineno-34-164"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">250</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-34-165" name="__codelineno-34-165" href="#__codelineno-34-165"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-34-166" name="__codelineno-34-166" href="#__codelineno-34-166"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-34-167" name="__codelineno-34-167" href="#__codelineno-34-167"></a>
<a id="__codelineno-34-168" name="__codelineno-34-168" href="#__codelineno-34-168"></a><span class="c">% h1 = axes;</span>
<a id="__codelineno-34-169" name="__codelineno-34-169" href="#__codelineno-34-169"></a><span class="c">% axis(h1);</span>
<a id="__codelineno-34-170" name="__codelineno-34-170" href="#__codelineno-34-170"></a><span class="c">% begin_time_1 = 65;</span>
<a id="__codelineno-34-171" name="__codelineno-34-171" href="#__codelineno-34-171"></a><span class="c">% total_time_1 = 75;</span>
<a id="__codelineno-34-172" name="__codelineno-34-172" href="#__codelineno-34-172"></a><span class="c">% </span>
<a id="__codelineno-34-173" name="__codelineno-34-173" href="#__codelineno-34-173"></a><span class="c">% plot(begin_time_1:Tstep:total_time_1,S(begin_time_1/Tstep:round(total_time_1/Tstep),1,2),&#39;Color&#39;,color_black,&#39;linewidth&#39;,line_width); hold on; % line for velocity of HDVs</span>
<a id="__codelineno-34-174" name="__codelineno-34-174" href="#__codelineno-34-174"></a><span class="c">% for i = 1:n_vehicle</span>
<a id="__codelineno-34-175" name="__codelineno-34-175" href="#__codelineno-34-175"></a><span class="c">%     if ID(i) == 0</span>
<a id="__codelineno-34-176" name="__codelineno-34-176" href="#__codelineno-34-176"></a><span class="c">%         plot(begin_time_1:Tstep:total_time_1,S(begin_time_1/Tstep:round(total_time_1/Tstep),i+1,2),&#39;Color&#39;,color_gray,&#39;linewidth&#39;,line_width/2); hold on; % line for velocity of HDVs</span>
<a id="__codelineno-34-177" name="__codelineno-34-177" href="#__codelineno-34-177"></a><span class="c">%     end</span>
<a id="__codelineno-34-178" name="__codelineno-34-178" href="#__codelineno-34-178"></a><span class="c">% end</span>
<a id="__codelineno-34-179" name="__codelineno-34-179" href="#__codelineno-34-179"></a><span class="c">% id_cav = 1;</span>
<a id="__codelineno-34-180" name="__codelineno-34-180" href="#__codelineno-34-180"></a><span class="c">% for i = 1:n_vehicle</span>
<a id="__codelineno-34-181" name="__codelineno-34-181" href="#__codelineno-34-181"></a><span class="c">%     if ID(i) == 1</span>
<a id="__codelineno-34-182" name="__codelineno-34-182" href="#__codelineno-34-182"></a><span class="c">%         if id_cav == 1</span>
<a id="__codelineno-34-183" name="__codelineno-34-183" href="#__codelineno-34-183"></a><span class="c">%             plot(begin_time_1:Tstep:total_time_1,S(begin_time_1/Tstep:round(total_time_1/Tstep),i+1,2),&#39;Color&#39;,color_red,&#39;linewidth&#39;,line_width); hold on; % line for velocity of CAVs</span>
<a id="__codelineno-34-184" name="__codelineno-34-184" href="#__codelineno-34-184"></a><span class="c">%             id_cav = id_cav+1;</span>
<a id="__codelineno-34-185" name="__codelineno-34-185" href="#__codelineno-34-185"></a><span class="c">%         elseif id_cav == 2</span>
<a id="__codelineno-34-186" name="__codelineno-34-186" href="#__codelineno-34-186"></a><span class="c">%             plot(begin_time_1:Tstep:total_time_1,S(begin_time_1/Tstep:round(total_time_1/Tstep),i+1,2),&#39;Color&#39;,color_blue,&#39;linewidth&#39;,line_width); hold on; % line for velocity of CAVs</span>
<a id="__codelineno-34-187" name="__codelineno-34-187" href="#__codelineno-34-187"></a><span class="c">%         end</span>
<a id="__codelineno-34-188" name="__codelineno-34-188" href="#__codelineno-34-188"></a><span class="c">%     end</span>
<a id="__codelineno-34-189" name="__codelineno-34-189" href="#__codelineno-34-189"></a><span class="c">% end</span>
<a id="__codelineno-34-190" name="__codelineno-34-190" href="#__codelineno-34-190"></a><span class="c">% </span>
<a id="__codelineno-34-191" name="__codelineno-34-191" href="#__codelineno-34-191"></a><span class="c">% set(gca,&#39;xticklabel&#39;,[])</span>
<a id="__codelineno-34-192" name="__codelineno-34-192" href="#__codelineno-34-192"></a><span class="c">% set(gca,&#39;yticklabel&#39;,[])</span>
<a id="__codelineno-34-193" name="__codelineno-34-193" href="#__codelineno-34-193"></a><span class="c">% set(gca,&#39;YLim&#39;,[13 18]);</span>
<a id="__codelineno-34-194" name="__codelineno-34-194" href="#__codelineno-34-194"></a><span class="c">% h1.Position = [0.15 0.6 0.15 0.25];</span>
<a id="__codelineno-34-195" name="__codelineno-34-195" href="#__codelineno-34-195"></a>
<a id="__codelineno-34-196" name="__codelineno-34-196" href="#__codelineno-34-196"></a><span class="c">% if mix</span>
<a id="__codelineno-34-197" name="__codelineno-34-197" href="#__codelineno-34-197"></a><span class="c">%     print(gcf,[&#39;.\figs\NEDC_VelocityProfile_Controller_&#39;,num2str(controller_type)],&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-34-198" name="__codelineno-34-198" href="#__codelineno-34-198"></a><span class="c">% else</span>
<a id="__codelineno-34-199" name="__codelineno-34-199" href="#__codelineno-34-199"></a><span class="c">%     print(gcf,&#39;.\figs\NEDC_VelocityProfile_AllHDVs&#39;,&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-34-200" name="__codelineno-34-200" href="#__codelineno-34-200"></a><span class="c">% end</span>
<a id="__codelineno-34-201" name="__codelineno-34-201" href="#__codelineno-34-201"></a>
<a id="__codelineno-34-202" name="__codelineno-34-202" href="#__codelineno-34-202"></a>
<a id="__codelineno-34-203" name="__codelineno-34-203" href="#__codelineno-34-203"></a>
<a id="__codelineno-34-204" name="__codelineno-34-204" href="#__codelineno-34-204"></a>
<a id="__codelineno-34-205" name="__codelineno-34-205" href="#__codelineno-34-205"></a>
<a id="__codelineno-34-206" name="__codelineno-34-206" href="#__codelineno-34-206"></a><span class="c">% Spacing</span>
<a id="__codelineno-34-207" name="__codelineno-34-207" href="#__codelineno-34-207"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-34-208" name="__codelineno-34-208" href="#__codelineno-34-208"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-34-209" name="__codelineno-34-209" href="#__codelineno-34-209"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-34-210" name="__codelineno-34-210" href="#__codelineno-34-210"></a><span class="w">        </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_gray</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of HDVs</span>
<a id="__codelineno-34-211" name="__codelineno-34-211" href="#__codelineno-34-211"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-34-212" name="__codelineno-34-212" href="#__codelineno-34-212"></a><span class="k">end</span>
<a id="__codelineno-34-213" name="__codelineno-34-213" href="#__codelineno-34-213"></a><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-34-214" name="__codelineno-34-214" href="#__codelineno-34-214"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-34-215" name="__codelineno-34-215" href="#__codelineno-34-215"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-34-216" name="__codelineno-34-216" href="#__codelineno-34-216"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-34-217" name="__codelineno-34-217" href="#__codelineno-34-217"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-34-218" name="__codelineno-34-218" href="#__codelineno-34-218"></a><span class="w">            </span><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-34-219" name="__codelineno-34-219" href="#__codelineno-34-219"></a><span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-34-220" name="__codelineno-34-220" href="#__codelineno-34-220"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-34-221" name="__codelineno-34-221" href="#__codelineno-34-221"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-34-222" name="__codelineno-34-222" href="#__codelineno-34-222"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-34-223" name="__codelineno-34-223" href="#__codelineno-34-223"></a><span class="k">end</span>
<a id="__codelineno-34-224" name="__codelineno-34-224" href="#__codelineno-34-224"></a>
<a id="__codelineno-34-225" name="__codelineno-34-225" href="#__codelineno-34-225"></a><span class="nb">grid</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<a id="__codelineno-34-226" name="__codelineno-34-226" href="#__codelineno-34-226"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">total_size</span><span class="p">);</span>
<a id="__codelineno-34-227" name="__codelineno-34-227" href="#__codelineno-34-227"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;XLim&#39;</span><span class="p">,[</span><span class="n">time_scale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">time_scale</span><span class="p">(</span><span class="k">end</span><span class="p">)]);</span>
<a id="__codelineno-34-228" name="__codelineno-34-228" href="#__codelineno-34-228"></a>
<a id="__codelineno-34-229" name="__codelineno-34-229" href="#__codelineno-34-229"></a><span class="n">xl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;$t$ [$\mathrm{s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-230" name="__codelineno-34-230" href="#__codelineno-34-230"></a><span class="n">yl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Spacing [$\mathrm{m}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-231" name="__codelineno-34-231" href="#__codelineno-34-231"></a>
<a id="__codelineno-34-232" name="__codelineno-34-232" href="#__codelineno-34-232"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">1050</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">750</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-34-233" name="__codelineno-34-233" href="#__codelineno-34-233"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-34-234" name="__codelineno-34-234" href="#__codelineno-34-234"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-34-235" name="__codelineno-34-235" href="#__codelineno-34-235"></a>
<a id="__codelineno-34-236" name="__codelineno-34-236" href="#__codelineno-34-236"></a><span class="c">% if mix</span>
<a id="__codelineno-34-237" name="__codelineno-34-237" href="#__codelineno-34-237"></a><span class="c">%     print(gcf,[&#39;.\figs\NGSIM_SpacingProfile_Controller_&#39;,num2str(controller_type)],&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-34-238" name="__codelineno-34-238" href="#__codelineno-34-238"></a><span class="c">% else</span>
<a id="__codelineno-34-239" name="__codelineno-34-239" href="#__codelineno-34-239"></a><span class="c">%     print(gcf,&#39;.\figs\NGSIM_SpacingProfile_AllHDVs&#39;,&#39;-painters&#39;,&#39;-depsc2&#39;,&#39;-r300&#39;);</span>
<a id="__codelineno-34-240" name="__codelineno-34-240" href="#__codelineno-34-240"></a><span class="c">% end</span>
<a id="__codelineno-34-241" name="__codelineno-34-241" href="#__codelineno-34-241"></a>
<a id="__codelineno-34-242" name="__codelineno-34-242" href="#__codelineno-34-242"></a><span class="c">% acceleration</span>
<a id="__codelineno-34-243" name="__codelineno-34-243" href="#__codelineno-34-243"></a><span class="nb">figure</span><span class="p">;</span>
<a id="__codelineno-34-244" name="__codelineno-34-244" href="#__codelineno-34-244"></a>
<a id="__codelineno-34-245" name="__codelineno-34-245" href="#__codelineno-34-245"></a>
<a id="__codelineno-34-246" name="__codelineno-34-246" href="#__codelineno-34-246"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-34-247" name="__codelineno-34-247" href="#__codelineno-34-247"></a><span class="w">    </span><span class="c">% smooth acceleration signal</span>
<a id="__codelineno-34-248" name="__codelineno-34-248" href="#__codelineno-34-248"></a><span class="w">    </span><span class="n">S</span><span class="p">(:,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">smooth</span><span class="p">(</span><span class="n">S</span><span class="p">(:,</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-34-249" name="__codelineno-34-249" href="#__codelineno-34-249"></a><span class="k">end</span>
<a id="__codelineno-34-250" name="__codelineno-34-250" href="#__codelineno-34-250"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-34-251" name="__codelineno-34-251" href="#__codelineno-34-251"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-34-252" name="__codelineno-34-252" href="#__codelineno-34-252"></a><span class="w">        </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_gray</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of HDVs</span>
<a id="__codelineno-34-253" name="__codelineno-34-253" href="#__codelineno-34-253"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-34-254" name="__codelineno-34-254" href="#__codelineno-34-254"></a><span class="k">end</span>
<a id="__codelineno-34-255" name="__codelineno-34-255" href="#__codelineno-34-255"></a><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-34-256" name="__codelineno-34-256" href="#__codelineno-34-256"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_vehicle</span>
<a id="__codelineno-34-257" name="__codelineno-34-257" href="#__codelineno-34-257"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ID</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-34-258" name="__codelineno-34-258" href="#__codelineno-34-258"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-34-259" name="__codelineno-34-259" href="#__codelineno-34-259"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_red</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-34-260" name="__codelineno-34-260" href="#__codelineno-34-260"></a><span class="w">            </span><span class="n">id_cav</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">id_cav</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-34-261" name="__codelineno-34-261" href="#__codelineno-34-261"></a><span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">id_cav</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-34-262" name="__codelineno-34-262" href="#__codelineno-34-262"></a><span class="w">            </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_scale</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">),</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="n">color_blue</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="p">);</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="c">% line for velocity of CAVs</span>
<a id="__codelineno-34-263" name="__codelineno-34-263" href="#__codelineno-34-263"></a><span class="w">        </span><span class="k">end</span>
<a id="__codelineno-34-264" name="__codelineno-34-264" href="#__codelineno-34-264"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-34-265" name="__codelineno-34-265" href="#__codelineno-34-265"></a><span class="k">end</span>
<a id="__codelineno-34-266" name="__codelineno-34-266" href="#__codelineno-34-266"></a><span class="nb">grid</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<a id="__codelineno-34-267" name="__codelineno-34-267" href="#__codelineno-34-267"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">total_size</span><span class="p">);</span>
<a id="__codelineno-34-268" name="__codelineno-34-268" href="#__codelineno-34-268"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;XLim&#39;</span><span class="p">,[</span><span class="n">time_scale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">time_scale</span><span class="p">(</span><span class="k">end</span><span class="p">)]);</span>
<a id="__codelineno-34-269" name="__codelineno-34-269" href="#__codelineno-34-269"></a>
<a id="__codelineno-34-270" name="__codelineno-34-270" href="#__codelineno-34-270"></a><span class="n">xl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;$t$ [$\mathrm{s}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-271" name="__codelineno-34-271" href="#__codelineno-34-271"></a><span class="n">yl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Acceleration [$\mathrm{m/s^2}$]&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">label_size</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-34-272" name="__codelineno-34-272" href="#__codelineno-34-272"></a>
<a id="__codelineno-34-273" name="__codelineno-34-273" href="#__codelineno-34-273"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">1050</span><span class="w"> </span><span class="mi">550</span><span class="w"> </span><span class="mi">700</span><span class="w"> </span><span class="mi">300</span><span class="p">]);</span>
<a id="__codelineno-34-274" name="__codelineno-34-274" href="#__codelineno-34-274"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-34-275" name="__codelineno-34-275" href="#__codelineno-34-275"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-34-276" name="__codelineno-34-276" href="#__codelineno-34-276"></a>
<a id="__codelineno-34-277" name="__codelineno-34-277" href="#__codelineno-34-277"></a><span class="c">% -------------------------------------------------------------------------</span>
<a id="__codelineno-34-278" name="__codelineno-34-278" href="#__codelineno-34-278"></a><span class="c">%   Calculate Performance Indexes</span>
<a id="__codelineno-34-279" name="__codelineno-34-279" href="#__codelineno-34-279"></a><span class="c">%--------------------------------------------------------------------------</span>
<a id="__codelineno-34-280" name="__codelineno-34-280" href="#__codelineno-34-280"></a><span class="n">FuelConsumption</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-34-281" name="__codelineno-34-281" href="#__codelineno-34-281"></a><span class="n">VelocityError</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-34-282" name="__codelineno-34-282" href="#__codelineno-34-282"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="p">=</span><span class="n">begin_time</span><span class="o">/</span><span class="n">Tstep</span><span class="p">:</span><span class="n">total_time</span><span class="o">/</span><span class="n">Tstep</span>
<a id="__codelineno-34-283" name="__codelineno-34-283" href="#__codelineno-34-283"></a><span class="w">    </span><span class="n">R</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.333</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.00108</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.2</span><span class="o">*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-34-284" name="__codelineno-34-284" href="#__codelineno-34-284"></a><span class="w">    </span><span class="n">Fuel</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.09</span><span class="o">*</span><span class="n">R</span><span class="o">.*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.054</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span><span class="o">.*</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-34-285" name="__codelineno-34-285" href="#__codelineno-34-285"></a><span class="w">    </span><span class="n">Fuel</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.444</span><span class="p">;</span>
<a id="__codelineno-34-286" name="__codelineno-34-286" href="#__codelineno-34-286"></a><span class="w">    </span><span class="n">FuelConsumption</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">FuelConsumption</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">Fuel</span><span class="p">)</span><span class="o">*</span><span class="n">Tstep</span><span class="p">;</span>
<a id="__codelineno-34-287" name="__codelineno-34-287" href="#__codelineno-34-287"></a>
<a id="__codelineno-34-288" name="__codelineno-34-288" href="#__codelineno-34-288"></a><span class="w">    </span><span class="n">VelocityError</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="k">end</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">S</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-34-289" name="__codelineno-34-289" href="#__codelineno-34-289"></a>
<a id="__codelineno-34-290" name="__codelineno-34-290" href="#__codelineno-34-290"></a><span class="k">end</span>
<a id="__codelineno-34-291" name="__codelineno-34-291" href="#__codelineno-34-291"></a>
<a id="__codelineno-34-292" name="__codelineno-34-292" href="#__codelineno-34-292"></a><span class="n">VelocityError</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">VelocityError</span><span class="o">/</span><span class="n">n_vehicle</span><span class="o">/</span><span class="p">((</span><span class="n">total_time</span><span class="o">-</span><span class="n">begin_time</span><span class="p">)</span><span class="o">/</span><span class="n">Tstep</span><span class="p">);</span>
<a id="__codelineno-34-293" name="__codelineno-34-293" href="#__codelineno-34-293"></a>
<a id="__codelineno-34-294" name="__codelineno-34-294" href="#__codelineno-34-294"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Fuel comsumption:   %4.2f \n&#39;</span><span class="p">,</span><span class="n">FuelConsumption</span><span class="p">);</span>
<a id="__codelineno-34-295" name="__codelineno-34-295" href="#__codelineno-34-295"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Velocity error:   %4.4f \n&#39;</span><span class="p">,</span><span class="n">VelocityError</span><span class="p">);</span>
</code></pre></div>
</details>

<h5 id="figure_ovmspacingpolicym"><a href="https://github.com/soc-ucsd/DeeP-LCC/blob/main/plot_figure/Figure_OVMSpacingPolicy.m">Figure_OVMSpacingPolicy.m</a><a class="headerlink" href="#figure_ovmspacingpolicym" title="Permanent link">&para;</a></h5>
<details>
<summary>Click here to view code</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nb">alpha</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.6</span><span class="p">;</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nb">beta</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.9</span><span class="p">;</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="n">s_st</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="n">s_go</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">35</span><span class="p">;</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="n">v_max</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="n">v</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="mf">0.05</span><span class="p">:</span><span class="n">v_max</span><span class="p">;</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="n">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">v</span><span class="o">/</span><span class="mi">30</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">35</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="n">f1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="nb">plot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="nb">axis</span><span class="p">([</span><span class="mi">0</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">40</span><span class="p">]);</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="nb">plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">v_max</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span><span class="s">&#39;--k&#39;</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="n">Wsize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span><span class="w">  </span><span class="c">% word size</span>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;TickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="mi">11</span><span class="p">);</span>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="n">grid</span><span class="w"> </span><span class="s">on</span><span class="p">;</span>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;Spacing&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">Wsize</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Desired velocity&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">Wsize</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;ytick&#39;</span><span class="p">,[])</span>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gca</span><span class="p">,</span><span class="s">&#39;xtick&#39;</span><span class="p">,[])</span>
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="nb">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="s">&#39;$v_{\mathrm{max}}$&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">Wsize</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="nb">text</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s">&#39;$s_{\mathrm{go}}$&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">Wsize</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="nb">text</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s">&#39;$s_{\mathrm{st}}$&#39;</span><span class="p">,</span><span class="s">&#39;fontsize&#39;</span><span class="p">,</span><span class="n">Wsize</span><span class="p">,</span><span class="s">&#39;Interpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">);</span>
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="nb">plot</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;-k&#39;</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="nb">plot</span><span class="p">([</span><span class="mi">35</span><span class="p">,</span><span class="mi">35</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">30</span><span class="p">],</span><span class="s">&#39;--k&#39;</span><span class="p">,</span><span class="s">&#39;linewidth&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a><span class="nb">set</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;Position&#39;</span><span class="p">,[</span><span class="mi">250</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">250</span><span class="w"> </span><span class="mi">200</span><span class="p">]);</span>
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a>
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="n">fig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gcf</span><span class="p">;</span>
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="n">fig</span><span class="p">.</span><span class="n">PaperPositionMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;auto&#39;</span><span class="p">;</span>
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="nb">print</span><span class="p">(</span><span class="nb">gcf</span><span class="p">,</span><span class="s">&#39;./Figures_Fig2_OVMSpacingPolicy&#39;</span><span class="p">,</span><span class="s">&#39;-painters&#39;</span><span class="p">,</span><span class="s">&#39;-depsc2&#39;</span><span class="p">,</span><span class="s">&#39;-r300&#39;</span><span class="p">);</span>
</code></pre></div>
</details>

<h2 id="python-implementation">Python Implementation<a class="headerlink" href="#python-implementation" title="Permanent link">&para;</a></h2>
<p>Python implementation follows closely with Matlab implementation.
It simulates two scenarios:</p>
<ul>
<li>Scenario 1: Safety test with head vehicle takeing a sudden brake </li>
<li>Scenario 2: New European Driving Cyccle (NEDC) simulation with head vehicle following a trajectory modified from Extra-Urban Driving Cycle (EUDC) in NEDC</li>
</ul>
<h3 id="packages">Packages<a class="headerlink" href="#packages" title="Permanent link">&para;</a></h3>
<p>The python implementation requires user to have the following packages installed:</p>
<ul>
<li>numpy</li>
<li>cvxopt</li>
<li>scipy.io</li>
<li>ttictoc</li>
<li>math</li>
<li>matplotlib.pyplot</li>
<li>sys</li>
<li>dill</li>
</ul>
<h3 id="function">Function<a class="headerlink" href="#function" title="Permanent link">&para;</a></h3>
<p>Two main functions are:</p>
<ol>
<li>
<p><em>main_brake_simulation.py</em>
This simulates scenario 1.</p>
</li>
<li>
<p><em>main_nedc_simulation.py</em>
This simulates scenario 2.</p>
</li>
</ol>
<p>Both functions allow user to switch between MPC and DeePC method by changing variable values.
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">controller_type</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w">    </span>#<span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">DeeP</span><span class="o">-</span><span class="n">LCC</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">MPC</span>
</code></pre></div>
The optimization problem is solved in the following functions:</p>
<ol>
<li><em>qp_DeeP_LCC.py</em></li>
<li><em>qp_MPC.py</em></li>
</ol>
<p>Both functions utilize cvxopt solver to solve the optimization problem.</p>
<h2 id="experiment-results">Experiment Results<a class="headerlink" href="#experiment-results" title="Permanent link">&para;</a></h2>
<h3 id="experiment-setup">Experiment Setup<a class="headerlink" href="#experiment-setup" title="Permanent link">&para;</a></h3>
<p>We consider eight vehicles with two CAVs, i.e., <script type="math/tex; mode=display">n = 8, m = 2</script> in the above figure.</p>
<p><a class="glightbox" href="../img/deepLCC/Result_fig1.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Result_fig1" src="../img/deepLCC/Result_fig1.png" /></a></p>
<p>In DeeP-LCC, we use the following parameters.</p>
<ol>
<li>In offline data collection: the length for the pre-collected data is $T = 2000$ with $\Delta t = 0.05s$</li>
<li>In online predictive control: the time horizons for the future and past trajectories are set to $N = 50$. $T_{ini} = 20$. For constraints, we have <script type="math/tex; mode=display">\tilde{s}_{max} = 20, \tilde{s}_{min} = -15, a_{max} = 2, a_{min} = -5</script>.</li>
</ol>
<h3 id="numerical-results">Numerical Results<a class="headerlink" href="#numerical-results" title="Permanent link">&para;</a></h3>
<p><strong>Experiment A</strong>: We first design a comprehensive simulation scenario to validate the capability of DeeP-LCC in improving traffic performance. Specifically, motivated by EUDC driving cycle, we design a velocity trajectory for the head vehicle. For performance evaluation, we calculate the fuel consumption using the numerical model in [2] for the vehivles indexed from 3 to 8, given that the first two HDVs would not be influnced. </p>
<p>The simulation results are as below:</p>
<p><a class="glightbox" href="../img/deepLCC/Result_fig2.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Result_fig2" src="../img/deepLCC/Result_fig2.png" /></a></p>
<p>This figure shows how velocity profiles in Experiment A. The black profile represents the head vehicle, and the gray profile represents the HDVs. The red profile and the blue profile represent the first and the second CAV, respectively. (a) All the vehicles are HDVs. (b) The CAVs utilize DeeP-LCC.</p>
<p>The results of the fuel consumption is presented in the below table, with the whole simulation separated into four phases:</p>
<p><a class="glightbox" href="../img/deepLCC/Result_fig3.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Result_fig3" src="../img/deepLCC/Result_fig3.png" /></a></p>
<p><strong>Experiment B</strong>: To further validate the safety performance of DeeP-LCC, we design a particular braking scenario motivated by EUDC, where the head vehicle takes a sudden emergency brake with maximum deceleration capability, maintains the low velocity for a while, and finally accelerates to the original normal velocity. This is a typical emergency case in real traffic flow, which requires the CAVs control to have strict safety guarantees from rear-end collision.</p>
<p>The results are shown below:</p>
<p><a class="glightbox" href="../img/deepLCC/Result_fig4.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Result_fig4" src="../img/deepLCC/Result_fig4.png" /></a></p>
<p>Simulation results in Experiment B. $(a)(c)(e)$ show the velocity, spacing, and acceleration profiles, respectively when all the vehicles are HDVs, while (b)(d)(f) show the corresponding profiles where the two CAVs utilize DeeP-LCC. In $(c)-(f)$, the profiles of the other HDVs are hidden.</p>
<h2 id="runtime">Runtime<a class="headerlink" href="#runtime" title="Permanent link">&para;</a></h2>
<p>Here we present the runtime of both simulations at the time of creation of this webpage.<br />
<strong>Optimization for main_brake_simulation</strong><br />
Matlab: 13.5 min<br />
Python: 14   min<br />
<strong>Optimization for main_nedc_simulation</strong><br />
Matlab: 56   min<br />
Python: 39.6 min</p>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<p>[1] Wang, J., Zheng, Y., Li, K.,&amp; Xu, Q.,(2023). DeeP-LCC: Data-EnablEd Predictive Leading Cruise Control in Mixed Traffic Flow. 2203-10639. [<a href="https://arxiv.org/abs/2203.10639v2">pdf</a>]</p>
<p>[2] Wang, J., Zheng, Y., Li, K.,&amp; Xu, Q.,(2022). Data-Driven Predictive Control for Connected and Autonomous Vehicles in Mixed Traffic. 2110-100. [<a href="https://arxiv.org/abs/2110.10097">pdf</a>]</p>
<p>[3] D. P. Bowyer, R. Akccelik, and D. Biggs, Guide to fuel consumption
analysis for urban traffic management. Vermont South, Australia:
ARRB Transport Research Ltd, 1985, no. 32. </p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 SOC Lab
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.tracking", "navigation.indexes", "toc.integrate", "toc.follow", "navigation.expand"], "search": "../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>